<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spunk.Bet — Free, Fair & Safe Casino on Bitcoin</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="canonical" href="https://spunk.bet">
  <script>if (location.protocol !== 'https:' && location.hostname !== 'localhost') location.replace('https://' + location.host + location.pathname + location.search);</script>
  <meta name="description" content="Free, fair and safe original casino gambling on Bitcoin. Provably fair games, no KYC, no fees. Play instantly with SPUNK•BET runes.">
  <meta property="og:title" content="Spunk.Bet — Free, Fair & Safe Casino on Bitcoin">
  <meta property="og:description" content="Free, fair and safe original casino gambling on Bitcoin. Provably fair games, no KYC, no fees. Play instantly.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://spunk.bet">
  <meta property="og:image" content="https://spunk.bet/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="628">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@SpunkArt13">
  <meta name="twitter:creator" content="@SpunkArt13">
  <meta name="twitter:title" content="Spunk.Bet — Free, Fair & Safe Casino on Bitcoin">
  <meta name="twitter:description" content="Free, fair and safe original casino gambling on Bitcoin. Provably fair games, no KYC, no fees. Play instantly.">
  <meta name="twitter:image" content="https://spunk.bet/og-image.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0d0d0d;
      --surface: #111111;
      --surface2: #1a1a1a;
      --border: #222222;
      --text: #e4e4e7;
      --muted: #71717a;
      --accent: #ff5f1f;
      --accent-dim: #cc5500;
      --accent-glow: rgba(255, 95, 31, 0.25);
      --accent-glow2: rgba(255, 95, 31, 0.12);
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #eab308;
      --gold: #f59e0b;
      --purple: #a855f7;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* NAV */
    nav {
      display: flex; align-items: center; justify-content: space-between;
      padding: 1rem 2rem; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 100;
      background: rgba(13,13,13,0.95); backdrop-filter: blur(12px);
    }
    .logo { font-size: 1.4rem; font-weight: 700; letter-spacing: -0.03em; cursor: pointer; }
    .logo span { color: var(--accent); }
    .nav-center { display: flex; gap: 0.25rem; }
    .nav-tab {
      padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.85rem; font-weight: 500;
      color: var(--muted); cursor: pointer; border: none; background: none; transition: all 0.2s;
    }
    .nav-tab:hover { color: var(--text); }
    .nav-tab.active { color: var(--accent); background: var(--accent-glow); }
    .nav-right { display: flex; align-items: center; gap: 0.75rem; }
    .balance-display {
      background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
      padding: 0.4rem 0.8rem; font-size: 0.85rem; font-weight: 600;
    }
    .balance-display span { color: var(--accent); }
    .btn {
      background: var(--accent); color: #fff; border: none; padding: 0.6rem 1.4rem;
      border-radius: 10px; font-size: 0.9rem; font-weight: 700; cursor: pointer; transition: all 0.15s;
      letter-spacing: 0.01em;
    }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn:active { transform: scale(0.97) translateY(0); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
    .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { border-color: var(--accent); }
    .btn-green { background: var(--green); }
    .btn-red { background: var(--red); }

    /* HAMBURGER MENU */
    .hamburger {
      display: none; background: none; border: none; cursor: pointer; padding: 0.25rem;
      flex-direction: column; gap: 4px; z-index: 110;
    }
    .hamburger span {
      display: block; width: 20px; height: 2px; background: var(--text); border-radius: 2px;
      transition: all 0.3s;
    }
    .hamburger.open span:nth-child(1) { transform: rotate(45deg) translate(4px, 4px); }
    .hamburger.open span:nth-child(2) { opacity: 0; }
    .hamburger.open span:nth-child(3) { transform: rotate(-45deg) translate(4px, -4px); }
    .mobile-menu {
      display: none; position: fixed; top: 57px; left: 0; right: 0; bottom: 0;
      background: rgba(13,13,13,0.98); backdrop-filter: blur(12px); z-index: 99;
      flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem;
    }
    .mobile-menu.show { display: flex; }
    .mobile-menu button {
      background: none; border: 1px solid var(--border); color: var(--text); padding: 1rem 3rem;
      border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s; width: 260px; text-align: center;
    }
    .mobile-menu button:hover { border-color: var(--accent); color: var(--accent); }

    /* PAGES */
    .page { display: none; }
    .page.active { display: block; }

    /* HERO */
    .hero { text-align: center; padding: 3.5rem 2rem 2rem; position: relative; }
    .hero::before {
      content: ''; position: absolute; top: -40%; left: 50%; transform: translateX(-50%);
      width: 600px; height: 600px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%); pointer-events: none;
    }
    .hero h1 { font-size: clamp(2.5rem,6vw,4rem); font-weight: 800; letter-spacing: -0.04em; line-height: 1.1; margin-bottom: 1rem; }
    .hero h1 span { color: var(--accent); }
    .hero p { color: var(--muted); font-size: 1.1rem; max-width: 480px; margin: 0 auto 2rem; line-height: 1.6; }
    .hero-rune {
      display: inline-block; background: var(--accent-glow); border: 1px solid var(--accent);
      border-radius: 8px; padding: 0.3rem 0.8rem; font-size: 0.8rem; font-weight: 700;
      color: var(--accent); margin-bottom: 1rem; letter-spacing: 0.05em;
    }

    /* FAUCET */
    .faucet-banner {
      max-width: 900px; margin: 0 auto; padding: 0 2rem 1.5rem;
    }
    .faucet-card {
      background: linear-gradient(135deg, rgba(34,197,94,0.08), rgba(255,95,31,0.08));
      border: 1px solid var(--green); border-radius: 14px;
      padding: 1.25rem 1.5rem; display: flex; align-items: center; justify-content: space-between;
      gap: 1rem; flex-wrap: wrap;
    }
    .faucet-left h3 { font-size: 1rem; font-weight: 700; margin-bottom: 0.2rem; }
    .faucet-left h3 span { color: var(--green); }
    .faucet-left p { font-size: 0.8rem; color: var(--muted); line-height: 1.5; }
    .faucet-btn {
      background: var(--green); color: #fff; border: none; padding: 0.6rem 1.5rem;
      border-radius: 10px; font-size: 0.9rem; font-weight: 700; cursor: pointer;
      transition: all 0.15s; white-space: nowrap;
    }
    .faucet-btn:hover { opacity: 0.9; }
    .faucet-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ORIGINALS SECTION */
    .originals-header {
      max-width: 1100px; margin: 0 auto; padding: 0 2rem 0.75rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .originals-header h2 {
      font-size: 1rem; font-weight: 700; letter-spacing: -0.01em; color: #fff;
    }
    .originals-header .tag {
      background: rgba(255,95,31,0.12); color: var(--accent); font-size: 0.65rem;
      font-weight: 700; padding: 0.15rem 0.5rem; border-radius: 4px;
      letter-spacing: 0.04em;
    }

    /* GAME CARDS - Winna/Stake Style */
    .game-grid {
      max-width: 1100px; margin: 0 auto; padding: 0 2rem 4rem;
      display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem;
    }
    .game-card {
      background: #181818; border: 1px solid #222; border-radius: 12px;
      padding: 1.5rem 1rem 2.2rem; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden;
      display: flex; flex-direction: column; align-items: center; text-align: center;
      min-height: 170px; justify-content: center;
    }
    .game-card:hover {
      background: #1e1e1e; border-color: #333;
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .game-card-icon {
      font-size: 2.8rem; margin-bottom: 0.6rem; transition: transform 0.2s ease;
    }
    .game-card:hover .game-card-icon { transform: scale(1.1); }
    .game-card h3 {
      font-size: 0.9rem; font-weight: 700; margin-bottom: 0.15rem; color: #fff;
      letter-spacing: -0.01em;
    }
    .game-card p { display: none; }
    .game-card-desc {
      display: block !important; font-size: 0.7rem !important; color: #666 !important;
      margin: 0; font-weight: 500;
    }
    .game-card-edge {
      position: absolute; bottom: 0.5rem; left: 50%; transform: translateX(-50%);
      font-size: 0.7rem; font-weight: 700; color: var(--accent);
      padding: 0.15rem 0.6rem; border-radius: 4px;
      letter-spacing: 0.02em;
      background: rgba(255,95,31,0.1);
    }

    /* GAME CONTAINER */
    .game-container {
      max-width: 680px; margin: 0 auto; padding: 2rem;
    }
    .game-back {
      color: var(--muted); font-size: 0.85rem; cursor: pointer; margin-bottom: 1rem;
      display: inline-flex; align-items: center; gap: 0.3rem; border: none; background: none;
      transition: color 0.2s;
    }
    .game-back:hover { color: var(--text); }
    .game-title { font-size: 1.75rem; font-weight: 800; margin-bottom: 0.5rem; letter-spacing: -0.02em; }
    .game-payout-badge {
      display: inline-flex; align-items: center; gap: 0.4rem;
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 0.4rem 0.9rem; margin-bottom: 1.5rem; font-size: 0.85rem;
    }
    .game-payout-badge .payout-label { color: var(--muted); font-weight: 500; }
    .game-payout-badge .payout-value { color: var(--green); font-weight: 800; font-size: 1rem; }

    /* BET CONTROLS */
    .bet-controls {
      background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
      padding: 1.25rem; margin-bottom: 1rem;
    }
    .bet-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
    .bet-row:last-child { margin-bottom: 0; }
    .bet-label { font-size: 0.8rem; color: var(--muted); min-width: 70px; }
    .bet-input {
      flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
      padding: 0.6rem 0.85rem; color: var(--text); font-size: 0.95rem; font-weight: 600;
      outline: none; transition: border-color 0.2s;
    }
    .bet-input:focus { border-color: var(--accent); }
    .bet-quick { display: flex; gap: 0.3rem; }
    .bet-quick button {
      background: var(--border); border: none; color: var(--muted); padding: 0.35rem 0.6rem;
      border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .bet-quick button:hover { color: var(--text); background: var(--accent-glow); }

    /* GAME AREA */
    .game-area {
      background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
      padding: 2.5rem; text-align: center; margin-bottom: 1rem; min-height: 280px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }

    /* RESULT */
    .result {
      padding: 1rem 1.25rem; border-radius: 12px; font-weight: 700; font-size: 1rem;
      text-align: center; margin-bottom: 1rem; display: none;
    }
    .result.win {
      display: block; background: rgba(34,197,94,0.08);
      border: 1px solid rgba(34,197,94,0.25); color: var(--green);
      box-shadow: 0 0 20px rgba(34,197,94,0.05);
    }
    .result.lose {
      display: block; background: rgba(239,68,68,0.08);
      border: 1px solid rgba(239,68,68,0.25); color: var(--red);
      box-shadow: 0 0 20px rgba(239,68,68,0.05);
    }
    .result .payout-amount { font-size: 1.2rem; font-weight: 800; display: block; margin-top: 0.15rem; }

    /* PROVABLY FAIR SEED DISPLAY */
    .seed-display {
      background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
      padding: 0.5rem 0.75rem; margin-top: 0.5rem; font-size: 0.7rem; color: var(--muted);
      font-family: monospace; word-break: break-all; cursor: pointer; transition: border-color 0.2s;
    }
    .seed-display:hover { border-color: var(--accent); }

    /* COIN FLIP */
    .coin {
      width: 150px; height: 150px; border-radius: 50%; display: flex; align-items: center;
      justify-content: center; font-size: 3.5rem; font-weight: 800; margin: 1.5rem 0;
      border: 3px solid var(--border); background: var(--surface2); transition: all 0.3s;
    }
    .coin.flipping { animation: coinflip 0.6s ease-in-out; }
    @keyframes coinflip {
      0% { transform: rotateY(0deg) scale(1); }
      50% { transform: rotateY(900deg) scale(0.8); }
      100% { transform: rotateY(1800deg) scale(1); }
    }
    .coin.heads { border-color: var(--accent); color: var(--accent); }
    .coin.tails { border-color: var(--yellow); color: var(--yellow); }
    .flip-choices { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .flip-choice {
      padding: 0.5rem 1.5rem; border-radius: 8px; border: 2px solid var(--border);
      background: transparent; color: var(--text); font-weight: 600; font-size: 0.9rem;
      cursor: pointer; transition: all 0.2s;
    }
    .flip-choice:hover { border-color: var(--accent); }
    .flip-choice.selected { border-color: var(--accent); background: var(--accent-glow); color: var(--accent); }

    /* DICE */
    .dice-display { display: flex; gap: 1rem; margin: 1rem 0; }
    .die {
      width: 100px; height: 100px; background: var(--surface2); border: 2px solid var(--border);
      border-radius: 14px; display: flex; align-items: center; justify-content: center;
      font-size: 2.5rem; font-weight: 800; transition: all 0.3s;
    }
    .die.rolling { animation: shake 0.4s ease-in-out; }
    @keyframes shake {
      0%,100% { transform: rotate(0deg); }
      25% { transform: rotate(-15deg) scale(0.9); }
      75% { transform: rotate(15deg) scale(0.9); }
    }
    .die.hit { border-color: var(--green); color: var(--green); }
    .die.miss { border-color: var(--red); color: var(--red); }
    .dice-slider-wrap { width: 100%; margin: 0.75rem 0; }
    .dice-slider {
      -webkit-appearance: none; width: 100%; height: 6px; border-radius: 3px;
      background: linear-gradient(to right, var(--green) 0%, var(--green) var(--val, 50%), var(--red) var(--val, 50%), var(--red) 100%);
      outline: none; cursor: pointer;
    }
    .dice-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
      background: var(--text); cursor: pointer; border: 2px solid var(--bg);
    }
    .dice-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--muted); }
    .dice-target { font-size: 1.1rem; font-weight: 700; margin: 0.5rem 0; }
    .dice-target span { color: var(--accent); }
    .dice-multi { font-size: 0.85rem; color: var(--muted); }
    .dice-multi span { color: var(--green); font-weight: 600; }

    /* MINES */
    .mines-grid {
      display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;
      width: 340px; margin: 0.75rem 0;
    }
    .mine-cell {
      width: 62px; height: 62px; background: var(--surface2); border: 1px solid var(--border);
      border-radius: 10px; display: flex; align-items: center; justify-content: center;
      font-size: 1.4rem; cursor: pointer; transition: all 0.15s; user-select: none;
    }
    .mine-cell:hover:not(.revealed) { border-color: var(--accent); background: var(--accent-glow2); }
    .mine-cell.revealed.safe { background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.4); color: var(--green); }
    .mine-cell.revealed.bomb { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.4); color: var(--red); }
    .mine-cell.revealed.shown { background: rgba(113,113,122,0.1); border-color: var(--border); color: var(--muted); }
    .mines-info { display: flex; gap: 1.5rem; margin: 0.75rem 0; font-size: 0.85rem; }
    .mines-info span { color: var(--accent); font-weight: 600; }
    .mines-count-row { display: flex; align-items: center; gap: 0.5rem; }
    .mines-count-btn {
      width: 28px; height: 28px; border-radius: 6px; border: 1px solid var(--border);
      background: var(--surface2); color: var(--text); font-weight: 700; cursor: pointer;
      display: flex; align-items: center; justify-content: center; font-size: 0.85rem;
    }
    .mines-count-btn:hover { border-color: var(--accent); }

    /* CRASH */
    .crash-graph {
      width: 100%; height: 260px; background: var(--bg); border-radius: 12px;
      border: 1px solid var(--border); position: relative; overflow: hidden; margin: 0.75rem 0;
    }
    .crash-canvas { width: 100%; height: 100%; }
    .crash-multi {
      font-size: 3rem; font-weight: 800; letter-spacing: -0.03em;
      transition: color 0.2s;
    }
    .crash-multi.live { color: var(--green); }
    .crash-multi.crashed { color: var(--red); }
    .crash-multi.cashed { color: var(--accent); }
    .crash-status { font-size: 0.85rem; color: var(--muted); margin-top: 0.25rem; }

    /* LIMBO */
    .limbo-display {
      font-size: 5rem; font-weight: 800; letter-spacing: -0.03em;
      margin: 1.5rem 0; transition: color 0.3s;
    }
    .limbo-display.win { color: var(--green); }
    .limbo-display.lose { color: var(--red); }
    .limbo-display.idle { color: var(--muted); }
    .limbo-target-display {
      font-size: 0.9rem; color: var(--muted); margin-bottom: 0.5rem;
    }
    .limbo-target-display span { color: var(--accent); font-weight: 700; }
    @keyframes limboSpin {
      0% { transform: scale(0.8); opacity: 0.5; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
    .limbo-display.spinning { animation: limboSpin 0.4s ease-out; }

    /* KENO */
    .keno-grid {
      display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px;
      width: 100%; max-width: 360px; margin: 0.5rem auto;
    }
    .keno-cell {
      aspect-ratio: 1; background: var(--surface2); border: 1px solid var(--border);
      border-radius: 6px; display: flex; align-items: center; justify-content: center;
      font-size: 0.85rem; font-weight: 700; cursor: pointer; transition: all 0.15s;
      user-select: none;
    }
    .keno-cell:hover:not(.drawn) { border-color: var(--accent); }
    .keno-cell.selected { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); }
    .keno-cell.drawn { pointer-events: none; }
    .keno-cell.drawn.miss { background: rgba(113,113,122,0.05); border-color: var(--border); color: var(--muted); opacity: 0.35; }
    .keno-cell.keno-hit {
      background: rgba(34,197,94,0.45) !important; border-color: var(--green) !important; color: #fff !important;
      box-shadow: 0 0 20px rgba(34,197,94,0.7), 0 0 40px rgba(34,197,94,0.25), inset 0 0 12px rgba(34,197,94,0.3) !important;
      transform: scale(1.15) !important; font-size: 1.05rem !important; font-weight: 900 !important;
      z-index: 2; position: relative; opacity: 1 !important;
      animation: kenoHitPulse 0.6s ease-out !important;
    }
    .keno-cell.drawn.selected.miss, .keno-cell.selected.drawn.miss { background: rgba(239,68,68,0.2) !important; border-color: var(--red) !important; color: var(--red) !important; opacity: 0.6 !important; }
    /* SHARE ON X */
    .share-x-btn { display:inline-flex; align-items:center; gap:0.3rem; margin-left:0.5rem; padding:0.35rem 0.8rem; border-radius:8px; border:1px solid #333; background:#000; color:#fff; font-size:0.75rem; font-weight:700; cursor:pointer; vertical-align:middle; transition:all 0.2s; }
    .share-x-btn:hover { background:#1a1a1a; border-color:#555; transform:scale(1.05); }
    .share-x-btn svg { width:14px; height:14px; fill:#fff; }

    @keyframes kenoHitPulse { 0% { transform:scale(1.5); box-shadow:0 0 30px rgba(34,197,94,0.8); } 40% { transform:scale(1.05); } 70% { transform:scale(1.15); } 100% { transform:scale(1.12); box-shadow:0 0 16px rgba(34,197,94,0.6); } }
    .keno-info { font-size: 0.8rem; color: var(--muted); margin: 0.5rem 0; }
    .keno-info span { color: var(--accent); font-weight: 600; }
    .keno-picks { display: flex; gap: 0.25rem; flex-wrap: wrap; margin: 0.5rem 0; }
    .keno-pick-btn {
      padding: 0.25rem 0.5rem; border-radius: 6px; border: 1px solid var(--border);
      background: var(--surface2); color: var(--muted); font-size: 0.7rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .keno-pick-btn:hover, .keno-pick-btn.active { border-color: var(--accent); color: var(--accent); }

    /* KENO PAYOUT LINE */
    .keno-payout-line { display:flex; gap:0; width:100%; margin-top:0.75rem; border-radius:8px; overflow:hidden; border:1px solid var(--border); }
    .keno-payout-slot { flex:1; text-align:center; padding:0.4rem 0.15rem; font-size:0.65rem; font-weight:700; background:var(--surface); border-right:1px solid var(--border); transition:all 0.2s; }
    .keno-payout-slot:last-child { border-right:none; }
    .keno-payout-slot .slot-hits { display:block; color:var(--muted); font-size:0.55rem; font-weight:600; margin-bottom:0.1rem; }
    .keno-payout-slot .slot-multi { display:block; }
    .keno-payout-slot.zero .slot-multi { color:var(--muted); opacity:0.4; }
    .keno-payout-slot.win .slot-multi { color:var(--green); }
    .keno-payout-slot.big .slot-multi { color:var(--accent); }
    .keno-payout-slot.active { background:rgba(34,197,94,0.15); }

    /* WHEEL - Winna style */
    .wheel-container { position: relative; width: 340px; height: 340px; margin: 1rem auto; }
    .wheel-canvas { width: 100%; height: 100%; }
    .wheel-pointer {
      position: absolute; top: -6px; left: 50%; transform: translateX(-50%);
      width: 0; height: 0; border-left: 14px solid transparent; border-right: 14px solid transparent;
      border-top: 24px solid #fff; z-index: 3; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.6));
    }
    .wheel-center {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #222 0%, #111 100%);
      border: 2px solid #444; display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 0.85rem; z-index: 2; color: #fff;
    }
    .wheel-result-text { font-size: 1.5rem; font-weight: 800; margin-top: 0.5rem; text-align: center; }

    /* PLINKO */
    .plinko-container { position: relative; width: 100%; max-width: 500px; margin: 0 auto; }
    .plinko-canvas { width: 100%; border-radius: 10px; background: #0d0d0d; border: 1px solid #1a1a1a; }
    .plinko-risk-row { display: flex; gap: 0.25rem; margin: 0.5rem 0; }
    .plinko-risk-btn {
      padding: 0.3rem 0.6rem; border-radius: 6px; border: 1px solid var(--border);
      background: var(--surface2); color: var(--muted); font-size: 0.75rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .plinko-risk-btn:hover, .plinko-risk-btn.active { border-color: var(--accent); color: var(--accent); }
    .plinko-rows-row { display: flex; align-items: center; gap: 0.5rem; margin: 0.3rem 0; }
    .plinko-result-text { font-size: 1.3rem; font-weight: 800; margin-top: 0.3rem; }

    /* HILO */
    .hilo-cards { display: flex; gap: 1rem; align-items: center; justify-content: center; margin: 1rem 0; }
    .hilo-card {
      width: 110px; height: 160px; background: var(--surface2); border: 2px solid var(--border);
      border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-weight: 800; transition: all 0.3s; position: relative;
    }
    .hilo-card .card-rank { font-size: 2.2rem; }
    .hilo-card .card-suit { font-size: 1.5rem; margin-top: 0.15rem; }
    .hilo-card.red .card-rank, .hilo-card.red .card-suit { color: var(--red); }
    .hilo-card.black .card-rank, .hilo-card.black .card-suit { color: var(--text); }
    .hilo-card.next { border-style: dashed; border-color: var(--muted); }
    .hilo-card.next .card-rank { color: var(--muted); }
    .hilo-card.win { border-color: var(--green); }
    .hilo-card.lose { border-color: var(--red); }
    .hilo-choices { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .hilo-choice {
      padding: 0.5rem 1.5rem; border-radius: 8px; border: 2px solid var(--border);
      background: transparent; color: var(--text); font-weight: 600; font-size: 0.9rem;
      cursor: pointer; transition: all 0.2s;
    }
    .hilo-choice:hover { border-color: var(--accent); }
    .hilo-choice:disabled { opacity: 0.4; cursor: not-allowed; }
    .hilo-streak { font-size: 0.85rem; color: var(--muted); margin-top: 0.3rem; }
    .hilo-streak span { color: var(--green); font-weight: 700; }
    .hilo-multi { font-size: 1.5rem; font-weight: 800; color: var(--accent); margin: 0.25rem 0; }

    /* RUNE TOWER */
    .tower-grid {
      display: flex; flex-direction: column-reverse; gap: 4px; width: 100%; max-width: 320px; margin: 0.5rem auto;
    }
    .tower-floor { display: grid; gap: 4px; }
    .tower-floor.cols-2 { grid-template-columns: 1fr 1fr; }
    .tower-floor.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .tower-floor.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
    .tower-cell {
      height: 52px; background: var(--surface2); border: 1px solid var(--border);
      border-radius: 8px; display: flex; align-items: center; justify-content: center;
      font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.15s;
      user-select: none;
    }
    .tower-cell:hover:not(.revealed) { border-color: var(--accent); background: var(--accent-glow2); }
    .tower-cell.revealed.safe { background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.4); color: var(--green); }
    .tower-cell.revealed.trap { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.4); color: var(--red); }
    .tower-cell.revealed.shown { background: rgba(113,113,122,0.1); border-color: var(--border); color: var(--muted); }
    .tower-cell.locked { opacity: 0.3; cursor: not-allowed; }
    .tower-cell.current { border-color: var(--accent); }
    .tower-floor-label {
      font-size: 0.65rem; color: var(--muted); text-align: right; padding-right: 0.25rem;
      min-width: 30px;
    }
    .tower-info { display: flex; gap: 1.5rem; margin: 0.5rem 0; font-size: 0.85rem; }
    .tower-info span { color: var(--accent); font-weight: 600; }
    .tower-diff-row { display: flex; gap: 0.25rem; margin: 0.5rem 0; }
    .tower-diff-btn {
      padding: 0.3rem 0.6rem; border-radius: 6px; border: 1px solid var(--border);
      background: var(--surface2); color: var(--muted); font-size: 0.75rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .tower-diff-btn:hover, .tower-diff-btn.active { border-color: var(--accent); color: var(--accent); }

    /* HISTORY */
    .history-list { display: flex; flex-direction: column; gap: 0; }
    .history-item {
      display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center;
      font-size: 0.8rem; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border);
      background: var(--surface); transition: background 0.15s;
    }
    .history-item:nth-child(even) { background: var(--surface2); }
    .history-item:hover { background: rgba(255,255,255,0.03); }
    .history-game { color: var(--muted); font-weight: 500; }
    .history-result { font-weight: 600; text-align: right; }
    .history-result.win { color: var(--green); }
    .history-result.lose { color: var(--red); }

    /* PROVABLY FAIR PAGE */
    .fair-container { max-width: 620px; margin: 0 auto; padding: 2rem; }
    .fair-container h2 { font-size: 1.3rem; font-weight: 700; margin-bottom: 0.5rem; }
    .fair-container h3 { font-size: 1rem; font-weight: 700; margin: 1.5rem 0 0.5rem; color: var(--accent); }
    .fair-container p { color: var(--muted); font-size: 0.85rem; line-height: 1.7; margin-bottom: 0.75rem; }
    .fair-container code {
      background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
      padding: 0.15rem 0.4rem; font-size: 0.8rem; color: var(--accent);
    }
    .fair-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
      padding: 1.25rem; margin: 1rem 0;
    }
    .fair-card label { display: block; font-size: 0.8rem; color: var(--muted); margin-bottom: 0.3rem; }
    .fair-card input, .fair-card textarea {
      width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
      padding: 0.5rem 0.75rem; color: var(--text); font-size: 0.85rem; font-family: monospace;
      outline: none; margin-bottom: 0.75rem; resize: vertical;
    }
    .fair-card input:focus, .fair-card textarea:focus { border-color: var(--accent); }
    .verify-result {
      padding: 0.75rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600; display: none;
    }
    .verify-result.pass { display: block; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); color: var(--green); }
    .verify-result.fail { display: block; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: var(--red); }
    .shield-icon {
      display: inline-flex; align-items: center; gap: 0.3rem; background: rgba(34,197,94,0.1);
      border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 0.3rem 0.7rem;
      font-size: 0.8rem; font-weight: 600; color: var(--green); margin-bottom: 1rem;
    }

    /* WALLETS PAGE */
    .wallets-container { max-width: 620px; margin: 0 auto; padding: 2rem; }
    .wallets-container h2 { font-size: 1.3rem; font-weight: 700; margin-bottom: 0.5rem; }
    .wallets-container p { color: var(--muted); font-size: 0.85rem; line-height: 1.7; margin-bottom: 0.75rem; }
    .wallet-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
      padding: 1.5rem; margin-bottom: 1.25rem;
    }
    .wallet-card h3 { font-size: 1rem; font-weight: 700; margin-bottom: 0.3rem; display: flex; align-items: center; gap: 0.4rem; }
    .wallet-card .wallet-purpose { color: var(--muted); font-size: 0.8rem; margin-bottom: 1rem; line-height: 1.5; }
    .wallet-addr-box {
      display: flex; align-items: center; gap: 0.5rem; background: var(--bg);
      border: 1px solid var(--border); border-radius: 8px; padding: 0.6rem 0.75rem;
    }
    .wallet-addr-box input {
      flex: 1; background: none; border: none; color: var(--text); font-size: 0.75rem;
      font-family: monospace; outline: none;
    }
    .wallet-addr-box button {
      background: var(--accent); border: none; color: #fff; padding: 0.3rem 0.6rem;
      border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer;
      white-space: nowrap;
    }
    .wallet-tag {
      display: inline-block; padding: 0.15rem 0.5rem; border-radius: 6px;
      font-size: 0.7rem; font-weight: 700; letter-spacing: 0.03em;
    }
    .wallet-tag.rune { background: rgba(255,95,31,0.15); color: var(--accent); }
    .wallet-tag.btc { background: rgba(245,158,11,0.15); color: var(--gold); }
    .wallet-tag.ord { background: rgba(168,85,247,0.15); color: var(--purple); }

    /* FOOTER */
    footer {
      border-top: 1px solid var(--border); padding: 2rem; text-align: center;
      color: var(--muted); font-size: 0.75rem; margin-top: 3rem;
    }
    footer a { color: var(--muted); text-decoration: none; }
    footer a:hover { color: var(--text); }
    .footer-links { display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; align-items: center; }
    .footer-links a { font-weight: 500; }
    .tip-spunk-btn { display:inline-flex; align-items:center; gap:0.5rem; padding:0.65rem 1.6rem; border:none; border-radius:999px; font-weight:800; font-size:1rem; cursor:pointer; color:#fff; background:linear-gradient(135deg,#a855f7,#7c3aed,#c026d3); box-shadow:0 0 16px rgba(168,85,247,0.6),0 0 32px rgba(168,85,247,0.3),inset 0 1px 0 rgba(255,255,255,0.2); transition:all 0.2s; text-decoration:none; animation:tipGlow 2s ease-in-out infinite; letter-spacing:0.5px; }
    @keyframes tipGlow { 0%,100% { box-shadow:0 0 16px rgba(168,85,247,0.6),0 0 32px rgba(168,85,247,0.3); } 50% { box-shadow:0 0 24px rgba(192,38,211,0.8),0 0 48px rgba(168,85,247,0.5),0 0 64px rgba(124,58,237,0.3); } }
    .tip-spunk-btn:hover { box-shadow:0 0 30px rgba(192,38,211,0.9),0 0 60px rgba(168,85,247,0.5); transform:scale(1.1); }
    .tip-spunk-btn .tip-icon { font-size:1.2rem; animation:tipPulse 1.5s ease-in-out infinite; }
    @keyframes tipPulse { 0%,100% { transform:scale(1); } 50% { transform:scale(1.3); } }
    .tip-spunk-btn.tip-nav { padding:0.45rem 1rem; font-size:0.85rem; white-space:nowrap; }
    .tip-modal-overlay { display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); justify-content:center; align-items:center; }
    .tip-modal-overlay.active { display:flex; }
    .tip-modal { background:var(--card); border:2px solid #7c3aed; border-radius:1rem; padding:2rem; max-width:400px; width:90%; text-align:center; box-shadow:0 0 40px rgba(168,85,247,0.3); }
    .tip-modal h3 { margin:0 0 0.5rem; font-size:1.5rem; color:#c084fc; }
    .tip-modal h3 .tip-title-text { background:linear-gradient(135deg,#a855f7,#c084fc,#e879f9); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .tip-modal p { color:var(--muted); margin:0.5rem 0 1rem; font-size:0.9rem; }
    .tip-addr { background:#111; border:1px solid #7c3aed; border-radius:0.5rem; padding:0.75rem; font-family:monospace; font-size:0.72rem; word-break:break-all; color:#c084fc; cursor:pointer; margin-bottom:1rem; transition:all 0.2s; }
    .tip-addr:hover { background:#1a0a2e; border-color:#a855f7; }
    .tip-qr { margin:1rem auto; width:160px; height:160px; background:#fff; border-radius:0.5rem; display:flex; align-items:center; justify-content:center; padding:8px; }
    .tip-qr img { width:100%; height:100%; }

    /* WALLET */
    .wallet-btn {
      background: var(--accent); color: #fff; border: none; padding: 0.5rem 1.2rem;
      border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer;
      transition: all 0.15s; display: flex; align-items: center; gap: 0.4rem;
    }
    .wallet-btn:hover { opacity: 0.9; }
    .wallet-btn.connected {
      background: var(--surface); border: 1px solid var(--border); color: var(--text);
      font-size: 0.8rem;
    }
    .wallet-btn.connected:hover { border-color: var(--accent); }
    .wallet-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }
    .wallet-modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200;
      display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(4px);
    }
    .wallet-modal-overlay.show { display: flex; }
    .wallet-modal {
      background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
      padding: 2rem; width: 420px; max-width: 90vw; text-align: center;
    }
    .wallet-modal h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; }
    .wallet-modal p { color: var(--muted); font-size: 0.85rem; margin-bottom: 1.5rem; }
    .wallet-option {
      display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 1px solid var(--border);
      border-radius: 12px; cursor: pointer; transition: all 0.2s; margin-bottom: 0.5rem;
      background: var(--bg);
    }
    .wallet-option:hover { border-color: var(--accent); }
    .wallet-option-icon {
      width: 40px; height: 40px; border-radius: 10px; background: #ee7b30;
      display: flex; align-items: center; justify-content: center; font-weight: 800;
      font-size: 1.1rem; color: #fff; flex-shrink: 0;
    }
    .wallet-option-info { text-align: left; }
    .wallet-option-name { font-weight: 600; font-size: 0.95rem; }
    .wallet-option-desc { color: var(--muted); font-size: 0.75rem; margin-top: 0.1rem; }
    .wallet-modal-close {
      margin-top: 1rem; color: var(--muted); font-size: 0.8rem; cursor: pointer;
      background: none; border: none; transition: color 0.2s;
    }
    .wallet-modal-close:hover { color: var(--text); }
    .wallet-info {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 1rem; margin-bottom: 1rem; text-align: left;
    }
    .wallet-info-row {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.8rem; margin-bottom: 0.4rem;
    }
    .wallet-info-row:last-child { margin-bottom: 0; }
    .wallet-info-label { color: var(--muted); }
    .wallet-info-value { font-weight: 600; font-family: monospace; font-size: 0.75rem; }

    /* WELCOME TOAST */
    .toast {
      position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
      background: var(--surface); border: 1px solid var(--accent); border-radius: 12px;
      padding: 1rem 1.5rem; z-index: 300; font-size: 0.9rem; font-weight: 600;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4); transition: top 0.4s ease;
      max-width: 90vw; text-align: center;
    }
    .toast.show { top: 1rem; }
    .toast .toast-amount { color: var(--accent); }

    /* SHARE & EARN BUTTON */
    .share-btn {
      background: transparent; border: 1px solid var(--border); color: var(--text);
      padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s; display: none; align-items: center; gap: 0.3rem;
    }
    .share-btn:hover { border-color: var(--accent); color: var(--accent); }
    .share-btn.visible { display: flex; }

    /* REFERRAL MODAL */
    .referral-modal-content { text-align: left; }
    .referral-link-box {
      display: flex; align-items: center; gap: 0.5rem; background: var(--bg);
      border: 1px solid var(--border); border-radius: 8px; padding: 0.6rem 0.75rem;
      margin: 0.75rem 0;
    }
    .referral-link-box input {
      flex: 1; background: none; border: none; color: var(--text); font-size: 0.8rem;
      font-family: monospace; outline: none;
    }
    .referral-link-box button {
      background: var(--accent); border: none; color: #fff; padding: 0.3rem 0.6rem;
      border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer;
      white-space: nowrap;
    }
    .referral-stat {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.85rem;
    }
    .referral-stat:last-child { border-bottom: none; }
    .referral-stat-label { color: var(--muted); }
    .referral-stat-value { font-weight: 700; color: var(--accent); }

    /* TIER BADGES */
    .tier-badge {
      display: inline-block; padding: 0.15rem 0.5rem; border-radius: 6px;
      font-size: 0.7rem; font-weight: 700; letter-spacing: 0.03em;
    }
    .tier-badge.starter { background: rgba(113,113,122,0.2); color: var(--muted); }
    .tier-badge.bronze { background: rgba(234,179,8,0.15); color: var(--yellow); }
    .tier-badge.silver { background: rgba(168,162,158,0.2); color: #a8a29e; }
    .tier-badge.gold { background: rgba(245,158,11,0.2); color: var(--gold); }
    .tier-badge.vip { background: rgba(168,85,247,0.2); color: var(--purple); }

    /* LEADERBOARD */
    .leaderboard-section {
      max-width: 560px; margin: 0 auto 2rem; padding: 0 2rem;
    }
    .leaderboard-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
      padding: 1.25rem; margin-top: 1rem;
    }
    .stat-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;
    }
    .stat-item {
      background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
      padding: 1rem; text-align: center;
    }
    .stat-val { font-size: 1.4rem; font-weight: 800; margin-bottom: 0.25rem; }
    .stat-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .lb-tabs { display:flex; gap:0; margin-bottom:0.75rem; }
    .lb-tab { flex:1; padding:0.5rem; border:none; background:var(--surface2); color:var(--muted); font-size:0.8rem; font-weight:600; cursor:pointer; border-bottom:2px solid transparent; }
    .lb-tab:first-child { border-radius:8px 0 0 0; }
    .lb-tab:last-child { border-radius:0 8px 0 0; }
    .lb-tab.active { color:var(--accent); border-bottom-color:var(--accent); background:var(--surface); }
    .wager-entry { display:flex; align-items:center; gap:0.5rem; padding:0.5rem 0; border-bottom:1px solid var(--border); }
    .wager-entry:last-child { border-bottom:none; }
    .wager-rank { min-width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.75rem; font-weight:800; }
    .wager-rank.wr1 { background:linear-gradient(135deg,#ffd700,#ffb300); color:#000; }
    .wager-rank.wr2 { background:linear-gradient(135deg,#c0c0c0,#a0a0a0); color:#000; }
    .wager-rank.wr3 { background:linear-gradient(135deg,#cd7f32,#b06820); color:#000; }
    .wager-rank.wr4 { background:var(--surface2); color:var(--muted); }
    .wager-name { flex:1; font-size:0.82rem; font-weight:600; }
    .wager-amount { font-size:0.8rem; font-weight:700; color:var(--accent); }
    .wager-prize { font-size:0.7rem; color:var(--green); font-weight:600; }
    .rank-progress { margin-top:0.75rem; }
    .rank-bar-bg { background:var(--surface2); border-radius:6px; height:10px; overflow:hidden; margin-top:0.3rem; }
    .rank-bar-fill { height:100%; border-radius:6px; transition:width 0.5s ease; }
    .rank-next { font-size:0.75rem; color:var(--muted); margin-top:0.3rem; }
    .leaderboard-card h3 {
      font-size: 0.95rem; font-weight: 700; margin-bottom: 0.75rem;
      display: flex; align-items: center; gap: 0.4rem;
    }
    .leaderboard-entry {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.82rem;
    }
    .leaderboard-entry:last-child { border-bottom: none; }
    .leaderboard-rank {
      width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center;
      justify-content: center; font-weight: 800; font-size: 0.75rem; flex-shrink: 0;
    }
    .leaderboard-rank.r1 { background: rgba(245,158,11,0.2); color: var(--gold); }
    .leaderboard-rank.r2 { background: rgba(168,162,158,0.2); color: #a8a29e; }
    .leaderboard-rank.r3 { background: rgba(234,179,8,0.15); color: var(--yellow); }
    .leaderboard-rank.r4 { background: var(--border); color: var(--muted); }
    .leaderboard-addr { flex: 1; font-family: monospace; font-size: 0.75rem; color: var(--muted); }
    .leaderboard-count { font-weight: 700; color: var(--accent); }
    .leaderboard-empty { color: var(--muted); font-size: 0.8rem; text-align: center; padding: 1rem; }

    /* FIRST 100 BANNER */
    .first100-banner {
      max-width: 900px; margin: 0 auto; padding: 0 2rem 1.5rem;
    }
    .first100-card {
      background: linear-gradient(135deg, rgba(255,95,31,0.08), rgba(168,85,247,0.08));
      border: 1px solid var(--accent); border-radius: 14px;
      padding: 1.25rem 1.5rem; display: flex; align-items: center; justify-content: space-between;
      gap: 1rem; flex-wrap: wrap; transition: border-color 0.2s, box-shadow 0.2s;
    }
    .first100-card:hover { box-shadow: 0 0 20px rgba(255,95,31,0.15); }
    .first100-left h3 { font-size: 1rem; font-weight: 700; margin-bottom: 0.2rem; }
    .first100-left h3 span { color: var(--accent); }
    .first100-left p { font-size: 0.8rem; color: var(--muted); line-height: 1.5; }
    .first100-counter {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 0.6rem 1rem; text-align: center; min-width: 100px;
    }
    .first100-counter .count { font-size: 1.5rem; font-weight: 800; color: var(--accent); }
    .first100-counter .label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }

    /* TIERS DISPLAY */
    .tiers-section {
      margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border);
    }
    .tiers-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.4rem; margin-top: 0.5rem;
    }
    .tier-card {
      background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
      padding: 0.5rem; text-align: center; font-size: 0.7rem;
    }
    .tier-card .tier-name { font-weight: 700; margin-bottom: 0.15rem; }
    .tier-card .tier-req { color: var(--muted); }
    .tier-card .tier-reward { color: var(--green); font-weight: 600; margin-top: 0.15rem; }
    .tier-card.active { border-color: var(--accent); background: var(--accent-glow2); }

    /* AUTOBET */
    .mode-tabs { display:flex; gap:0; margin-bottom:0.75rem; }
    .mode-tab { flex:1; padding:0.5rem; border:1px solid var(--border); background:var(--bg); color:var(--muted); font-size:0.8rem; font-weight:600; cursor:pointer; text-align:center; transition:all 0.2s; }
    .mode-tab:first-child { border-radius:8px 0 0 8px; }
    .mode-tab:last-child { border-radius:0 8px 8px 0; }
    .mode-tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .autobet-panel { display:none; background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:0.75rem; margin-top:0.5rem; }
    .autobet-panel.show { display:block; }
    .autobet-row { display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; }
    .autobet-row:last-child { margin-bottom:0; }
    .autobet-label { font-size:0.75rem; color:var(--muted); min-width:90px; }
    .autobet-input { flex:1; background:var(--surface); border:1px solid var(--border); border-radius:6px; padding:0.4rem 0.6rem; color:var(--text); font-size:0.8rem; font-weight:600; outline:none; }
    .autobet-input:focus { border-color:var(--accent); }
    .autobet-select { flex:1; background:var(--surface); border:1px solid var(--border); border-radius:6px; padding:0.4rem 0.6rem; color:var(--text); font-size:0.8rem; font-weight:600; outline:none; cursor:pointer; -webkit-appearance:none; }
    .autobet-btn { width:100%; padding:0.55rem; border-radius:8px; font-size:0.8rem; font-weight:700; cursor:pointer; border:none; color:#fff; transition:all 0.2s; }
    .autobet-btn.start { background:var(--green); }
    .autobet-btn.stop { background:var(--red); animation: autobetPulse 1.5s infinite; }
    @keyframes autobetPulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }

    /* TURBO MODE */
    .turbo-toggle { display:flex; align-items:center; gap:0.4rem; margin-bottom:0.75rem; cursor:pointer; font-size:0.8rem; color:var(--muted); user-select:none; }
    .turbo-toggle input { display:none; }
    .turbo-switch { width:32px; height:18px; border-radius:9px; background:var(--border); position:relative; transition:background 0.2s; flex-shrink:0; }
    .turbo-switch::after { content:''; width:14px; height:14px; border-radius:50%; background:var(--muted); position:absolute; top:2px; left:2px; transition:all 0.2s; }
    .turbo-toggle input:checked + .turbo-switch { background:var(--accent); }
    .turbo-toggle input:checked + .turbo-switch::after { left:16px; background:#fff; }

    /* HERO FLASH */
    .hero-flash {
      display:inline-block; padding:0.5rem 1.2rem; border-radius:20px; font-size:0.85rem; font-weight:700;
      background:linear-gradient(90deg, var(--accent), #ff8c42, var(--accent)); background-size:200% 100%;
      animation:heroFlash 2s ease-in-out infinite; color:#fff; margin-top:1rem; letter-spacing:0.02em;
      box-shadow:0 0 20px rgba(255,95,31,0.3), 0 0 40px rgba(255,95,31,0.15);
    }
    @keyframes heroFlash {
      0% { background-position:0% 50%; box-shadow:0 0 20px rgba(255,95,31,0.3), 0 0 40px rgba(255,95,31,0.15); }
      50% { background-position:100% 50%; box-shadow:0 0 30px rgba(255,95,31,0.5), 0 0 60px rgba(255,95,31,0.25); }
      100% { background-position:0% 50%; box-shadow:0 0 20px rgba(255,95,31,0.3), 0 0 40px rgba(255,95,31,0.15); }
    }
    .hero-flash-pulse { animation:heroFlash 2s ease-in-out infinite, heroScale 1.5s ease-in-out infinite; }
    @keyframes heroScale { 0%,100% { transform:scale(1); } 50% { transform:scale(1.05); } }

    /* LIMBO RESULTS BAR */
    .limbo-history { display:flex; gap:5px; overflow-x:auto; padding:0.4rem 0.5rem; margin-bottom:0.75rem; scrollbar-width:none; background:var(--bg); border:1px solid var(--border); border-radius:8px; min-height:32px; align-items:center; width:100%; }
    .limbo-history::-webkit-scrollbar { display:none; }
    .limbo-history:empty::before { content:'Previous results appear here'; color:var(--muted); font-size:0.7rem; opacity:0.5; }
    .limbo-history-item { flex-shrink:0; padding:0.2rem 0.6rem; border-radius:4px; font-size:0.72rem; font-weight:700; line-height:1.2; }
    .limbo-history-item.win { background:rgba(34,197,94,0.15); color:var(--green); }
    .limbo-history-item.lose { background:rgba(239,68,68,0.12); color:var(--red); }

    /* KENO BALL ANIMATION */
    .keno-drawn-area { display:flex; flex-wrap:wrap; gap:6px; justify-content:center; margin:0.75rem 0; min-height:44px; }
    .keno-ball { width:42px; height:42px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:0.85rem; animation:kenoBallDrop 0.4s cubic-bezier(0.34,1.56,0.64,1); position:relative; }
    .keno-ball.hit { background:linear-gradient(135deg, #22c55e, #16a34a); color:#fff; box-shadow:0 0 16px rgba(34,197,94,0.5), 0 0 40px rgba(34,197,94,0.15); border:2px solid rgba(34,197,94,0.6); }
    .keno-ball.miss { background:var(--surface2); color:var(--muted); border:1px solid var(--border); opacity:0.5; }
    .keno-ball .ball-win { position:absolute; top:-16px; left:50%; transform:translateX(-50%); font-size:0.65rem; color:var(--green); font-weight:700; white-space:nowrap; animation:ballWinPop 0.5s ease-out; }
    @keyframes kenoBallDrop { 0% { transform:scale(0) translateY(-30px); opacity:0; } 60% { transform:scale(1.2) translateY(0); opacity:1; } 100% { transform:scale(1) translateY(0); opacity:1; } }
    @keyframes ballWinPop { 0% { opacity:0; transform:translateX(-50%) translateY(5px); } 100% { opacity:1; transform:translateX(-50%) translateY(0); } }

    @media (max-width: 900px) {
      .game-grid { grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
    }
    /* DICE OVER/UNDER TOGGLE */
    .dice-mode-toggle { display:flex; gap:0; margin-bottom:0.75rem; width:100%; }
    .dice-mode-btn { flex:1; padding:0.6rem; border:2px solid var(--border); background:var(--bg); color:var(--muted); font-size:0.9rem; font-weight:700; cursor:pointer; text-align:center; transition:all 0.2s; letter-spacing:0.02em; }
    .dice-mode-btn:first-child { border-radius:10px 0 0 10px; }
    .dice-mode-btn:last-child { border-radius:0 10px 10px 0; }
    .dice-mode-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .dice-mode-btn:hover:not(.active) { border-color:var(--accent); color:var(--text); }

    /* LIVE WINS TICKER */
    .live-ticker-wrap { max-width:1100px; margin:0 auto; padding:0 2rem 1.5rem; overflow:hidden; }
    .live-ticker-label { font-size:0.7rem; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:0.4rem; display:flex; align-items:center; gap:0.4rem; }
    .live-ticker-label .live-dot { width:6px; height:6px; border-radius:50%; background:var(--green); animation:livePulse 1.5s infinite; }
    @keyframes livePulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
    .live-ticker { display:flex; gap:1rem; overflow:hidden; white-space:nowrap; mask-image:linear-gradient(90deg,transparent,#000 5%,#000 95%,transparent); -webkit-mask-image:linear-gradient(90deg,transparent,#000 5%,#000 95%,transparent); }
    .live-ticker-inner { display:flex; gap:1rem; animation:tickerScroll 30s linear infinite; }
    @keyframes tickerScroll { 0% { transform:translateX(0); } 100% { transform:translateX(-50%); } }
    .ticker-item { flex-shrink:0; font-size:0.75rem; color:var(--muted); padding:0.35rem 0.75rem; background:var(--surface); border:1px solid var(--border); border-radius:8px; }
    .ticker-item .ticker-win { color:var(--green); font-weight:700; }
    .ticker-item .ticker-game { color:var(--accent); font-weight:600; }

    /* BIG WIN OVERLAY */
    .bigwin-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:500; display:none; align-items:center; justify-content:center; backdrop-filter:blur(8px); }
    .bigwin-overlay.show { display:flex; }
    .bigwin-card { background:linear-gradient(135deg,#111 0%,#1a1a1a 100%); border:2px solid var(--accent); border-radius:20px; padding:2.5rem; text-align:center; max-width:420px; width:90vw; position:relative; overflow:hidden; animation:bigwinPop 0.4s ease-out; }
    @keyframes bigwinPop { 0% { transform:scale(0.8); opacity:0; } 100% { transform:scale(1); opacity:1; } }
    .bigwin-card::before { content:''; position:absolute; inset:-50%; background:conic-gradient(from 0deg,transparent,rgba(255,95,31,0.1),transparent,rgba(255,95,31,0.05),transparent); animation:bigwinSpin 4s linear infinite; }
    @keyframes bigwinSpin { 100% { transform:rotate(360deg); } }
    .bigwin-card > * { position:relative; z-index:1; }
    .bigwin-emoji { font-size:3.5rem; margin-bottom:0.5rem; }
    .bigwin-title { font-size:1.5rem; font-weight:800; color:#fff; margin-bottom:0.25rem; }
    .bigwin-amount { font-size:2.5rem; font-weight:800; color:var(--green); margin:0.5rem 0; }
    .bigwin-multi { font-size:1.1rem; color:var(--accent); font-weight:700; margin-bottom:1rem; }
    .bigwin-bonus { font-size:0.8rem; color:var(--muted); margin-bottom:1rem; }
    .bigwin-share { width:100%; padding:0.75rem; border-radius:10px; background:#000; border:1px solid #333; color:#fff; font-size:0.9rem; font-weight:700; cursor:pointer; transition:all 0.2s; margin-bottom:0.5rem; display:flex; align-items:center; justify-content:center; gap:0.4rem; }
    .bigwin-share:hover { background:#111; border-color:#555; }
    .bigwin-dismiss { background:none; border:none; color:var(--muted); font-size:0.8rem; cursor:pointer; padding:0.5rem; }
    .bigwin-dismiss:hover { color:var(--text); }

    /* CONFETTI PARTICLES */
    .confetti-particle { position:fixed; width:8px; height:8px; z-index:501; pointer-events:none; animation:confettiFall 2.5s ease-in forwards; }
    @keyframes confettiFall { 0% { opacity:1; transform:translateY(0) rotate(0deg); } 100% { opacity:0; transform:translateY(100vh) rotate(720deg); } }

    /* PLAYER RANK BADGE */
    .player-rank-badge { display:none; align-items:center; gap:0.3rem; border-radius:8px; padding:0.3rem 0.6rem; font-size:0.7rem; font-weight:800; cursor:pointer; letter-spacing:0.03em; text-transform:uppercase; }
    .player-rank-badge.show { display:flex; }
    .player-rank-badge.rank-bronze { background:linear-gradient(135deg,rgba(205,127,50,0.2),rgba(205,127,50,0.1)); border:1px solid rgba(205,127,50,0.4); color:#cd7f32; }
    .player-rank-badge.rank-silver { background:linear-gradient(135deg,rgba(192,192,192,0.2),rgba(192,192,192,0.1)); border:1px solid rgba(192,192,192,0.4); color:#c0c0c0; }
    .player-rank-badge.rank-gold { background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,215,0,0.1)); border:1px solid rgba(255,215,0,0.4); color:#ffd700; }
    .player-rank-badge.rank-platinum { background:linear-gradient(135deg,rgba(168,85,247,0.2),rgba(59,130,246,0.15)); border:1px solid rgba(168,85,247,0.5); color:#a78bfa; animation:platGlow 2s ease-in-out infinite; }
    @keyframes platGlow { 0%,100% { box-shadow:0 0 4px rgba(168,85,247,0.2); } 50% { box-shadow:0 0 14px rgba(168,85,247,0.4); } }

    /* WIN STREAK BADGE */
    .streak-badge { display:none; align-items:center; gap:0.3rem; background:linear-gradient(135deg,rgba(255,95,31,0.15),rgba(245,158,11,0.15)); border:1px solid rgba(255,95,31,0.3); border-radius:8px; padding:0.3rem 0.6rem; font-size:0.75rem; font-weight:700; color:var(--accent); cursor:pointer; animation:streakGlow 2s ease-in-out infinite; }
    .streak-badge.show { display:flex; }
    @keyframes streakGlow { 0%,100% { box-shadow:0 0 4px rgba(255,95,31,0.2); } 50% { box-shadow:0 0 12px rgba(255,95,31,0.4); } }

    /* DAILY BONUS WHEEL */
    .daily-spin-section { max-width:900px; margin:0 auto; padding:0 2rem 1.5rem; }
    .daily-spin-card { background:linear-gradient(135deg,rgba(168,85,247,0.08),rgba(255,95,31,0.08)); border:1px solid var(--purple); border-radius:14px; padding:1.25rem 1.5rem; display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap; }
    .daily-spin-left h3 { font-size:1rem; font-weight:700; margin-bottom:0.2rem; }
    .daily-spin-left h3 span { color:var(--purple); }
    .daily-spin-left p { font-size:0.8rem; color:var(--muted); line-height:1.5; }
    .daily-spin-btn { background:var(--purple); color:#fff; border:none; padding:0.6rem 1.5rem; border-radius:10px; font-size:0.9rem; font-weight:700; cursor:pointer; transition:all 0.15s; white-space:nowrap; }
    .daily-spin-btn:hover { opacity:0.9; }
    .daily-spin-btn:disabled { opacity:0.4; cursor:not-allowed; }
    .daily-spin-modal { position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:400; display:none; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
    .daily-spin-modal.show { display:flex; }
    .daily-spin-modal-inner { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:2rem; width:400px; max-width:90vw; text-align:center; }
    .daily-spin-modal-inner h3 { font-size:1.1rem; font-weight:700; margin-bottom:0.5rem; }
    .daily-spin-result { font-size:2rem; font-weight:800; color:var(--purple); margin:1rem 0; }
    .daily-spin-bonus { font-size:0.8rem; color:var(--muted); margin-bottom:1rem; }

    /* PRIZE SHOWCASE */
    .prize-section { max-width:1100px; margin:0 auto; padding:2rem 2rem 3rem; position:relative; }
    .prize-section::before { content:''; position:absolute; top:0; left:50%; transform:translateX(-50%); width:80%; height:1px; background:linear-gradient(90deg,transparent,var(--accent),var(--purple),var(--gold),transparent); }
    .prize-section-header { text-align:center; margin-bottom:2rem; }
    .prize-section-header h2 { font-size:1.8rem; font-weight:800; letter-spacing:-0.02em; margin-bottom:0.5rem; }
    .prize-section-header h2 span { background:linear-gradient(90deg,var(--accent),var(--purple),var(--gold)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    .prize-section-header p { color:var(--muted); font-size:0.85rem; }
    .prize-section-header .prize-wallet-link { display:inline-block; margin-top:0.4rem; font-size:0.7rem; color:var(--muted); font-family:monospace; cursor:pointer; padding:0.25rem 0.6rem; background:var(--surface); border:1px solid var(--border); border-radius:6px; transition:all 0.2s; }
    .prize-section-header .prize-wallet-link:hover { border-color:var(--accent); color:var(--accent); }
    .prize-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:1rem; }
    .prize-card { background:linear-gradient(135deg,#151520,#1a1a2e); border:1px solid #2a2a3e; border-radius:16px; overflow:hidden; transition:all 0.3s; cursor:pointer; position:relative; }
    .prize-card:hover { border-color:var(--accent); transform:translateY(-5px) scale(1.02); box-shadow:0 12px 32px rgba(255,95,31,0.15), 0 0 0 1px rgba(255,95,31,0.1); }
    .prize-card::before { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(255,95,31,0.05),rgba(168,85,247,0.05)); opacity:0; transition:opacity 0.3s; z-index:0; }
    .prize-card:hover::before { opacity:1; }
    .prize-img { width:100%; aspect-ratio:1; display:flex; align-items:center; justify-content:center; font-size:4rem; position:relative; overflow:hidden; background:#0a0a12; }
    .prize-img-bg { position:absolute; inset:0; opacity:0.15; }
    .prize-img-bg.bg1 { background:radial-gradient(circle at 30% 40%,#ff5f1f,transparent 60%),radial-gradient(circle at 70% 60%,#a855f7,transparent 60%); }
    .prize-img-bg.bg2 { background:radial-gradient(circle at 60% 30%,#3b82f6,transparent 60%),radial-gradient(circle at 40% 70%,#22c55e,transparent 60%); }
    .prize-img-bg.bg3 { background:radial-gradient(circle at 50% 50%,#eab308,transparent 50%),radial-gradient(circle at 20% 80%,#ff5f1f,transparent 60%); }
    .prize-img-bg.bg4 { background:radial-gradient(circle at 40% 40%,#ec4899,transparent 60%),radial-gradient(circle at 60% 60%,#a855f7,transparent 60%); }
    .prize-img > span:not(.prize-badge) { position:relative; z-index:1; filter:drop-shadow(0 4px 12px rgba(0,0,0,0.5)); animation:prizeFloat 3s ease-in-out infinite; }
    @keyframes prizeFloat { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-6px); } }
    .prize-card:nth-child(2) .prize-img > span:not(.prize-badge) { animation-delay:0.5s; }
    .prize-card:nth-child(3) .prize-img > span:not(.prize-badge) { animation-delay:1s; }
    .prize-card:nth-child(4) .prize-img > span:not(.prize-badge) { animation-delay:1.5s; }
    .prize-badge { position:absolute; top:0.6rem; right:0.6rem; padding:0.25rem 0.6rem; border-radius:6px; font-size:0.65rem; font-weight:700; letter-spacing:0.04em; z-index:2; }
    .prize-badge.win-this { background:linear-gradient(90deg,var(--accent),#ff8c42); color:#fff; box-shadow:0 2px 8px rgba(255,95,31,0.4); animation:badgePulse 2s ease-in-out infinite; font-size:0.7rem; padding:0.3rem 0.7rem; }
    @keyframes badgePulse { 0%,100% { box-shadow:0 2px 8px rgba(255,95,31,0.4); transform:scale(1); } 50% { box-shadow:0 4px 20px rgba(255,95,31,0.8); transform:scale(1.05); } }
    .prize-badge.coming { background:rgba(168,85,247,0.2); color:var(--purple); border:1px solid rgba(168,85,247,0.3); }
    .prize-info { padding:0.75rem 0.85rem; position:relative; z-index:1; }
    .prize-info h4 { font-size:0.85rem; font-weight:700; margin-bottom:0.15rem; color:#fff; }
    .prize-info p { font-size:0.65rem; color:var(--muted); }
    .prize-info .prize-share-hint { font-size:0.6rem; color:var(--accent); margin-top:0.3rem; opacity:0; transition:opacity 0.2s; }
    .prize-card:hover .prize-share-hint { opacity:1; }
    .prize-cta { text-align:center; margin-top:1.25rem; }
    .prize-cta-btn { display:inline-flex; align-items:center; gap:0.5rem; background:linear-gradient(90deg,var(--accent),#ff8c42); color:#fff; border:none; padding:0.7rem 1.5rem; border-radius:10px; font-size:0.9rem; font-weight:700; cursor:pointer; transition:all 0.2s; box-shadow:0 4px 16px rgba(255,95,31,0.3); }
    .prize-cta-btn:hover { transform:translateY(-2px); box-shadow:0 6px 24px rgba(255,95,31,0.4); }
    .prize-cta-btn svg { width:16px; height:16px; fill:#fff; }

    /* MILESTONE TOAST (enhanced) */
    .toast-milestone { border-color:var(--green) !important; }
    .toast-milestone .toast-share-btn { display:inline-flex; align-items:center; gap:0.3rem; margin-top:0.5rem; padding:0.3rem 0.7rem; border-radius:6px; border:1px solid #333; background:#000; color:#fff; font-size:0.7rem; font-weight:600; cursor:pointer; }

    @media (max-width: 900px) {
      .prize-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 640px) {
      nav { padding: 0.75rem 1rem; }
      .nav-center { display: none; }
      .hamburger { display: flex; }
      .game-container { padding: 1.5rem 1rem; }
      .game-grid { padding: 0 1rem 3rem; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
      .game-card { min-height: 140px; padding: 1.1rem 0.75rem 1.8rem; border-radius: 10px; }
      .game-card-icon { font-size: 2.2rem; }
      .game-card h3 { font-size: 0.82rem; }
      .game-card-edge { font-size: 0.6rem; padding: 0.12rem 0.5rem; }
      .hero { padding: 3rem 1.5rem 2rem; }
      .mine-cell { width: 52px; height: 52px; font-size: 1.1rem; }
      .mines-grid { width: 290px; gap: 5px; }
      .coin { width: 120px; height: 120px; font-size: 2.8rem; }
      .die { width: 80px; height: 80px; font-size: 2rem; }
      .first100-card { flex-direction: column; text-align: center; }
      .faucet-card { flex-direction: column; text-align: center; }
      .tiers-grid { grid-template-columns: repeat(2, 1fr); }
      .nav-right { gap: 0.4rem; }
      .share-btn { display: none !important; }
      .wallet-btn { font-size: 0.7rem; padding: 0.4rem 0.6rem; }
      .balance-display { font-size: 0.75rem; padding: 0.3rem 0.5rem; }
      .keno-grid { grid-template-columns: repeat(5, 1fr); }
      .hilo-card { width: 85px; height: 125px; }
      .hilo-card .card-rank { font-size: 1.6rem; }
      .wheel-container { width: 260px; height: 260px; }
      .originals-header { padding: 0 1rem 0.75rem; }
      .game-title { font-size: 1.4rem; }
      .game-area { padding: 1.75rem; min-height: 240px; }
      .limbo-display { font-size: 3.5rem; }
      .crash-graph { height: 200px; }
      .prize-grid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
      .prize-section { padding: 1.5rem 1rem 2rem; }
      .prize-section-header h2 { font-size: 1.3rem; }
      .prize-card .prize-img { font-size: 3rem; }
      .prize-info h4 { font-size: 0.75rem; }
      .prize-cta-btn { font-size: 0.8rem; padding: 0.6rem 1.2rem; }
      .daily-spin-card { flex-direction:column; text-align:center; }
      .streak-badge { font-size:0.65rem; padding:0.2rem 0.4rem; }
      .bigwin-card { padding:1.5rem; }
      .bigwin-amount { font-size:2rem; }
      .tip-spunk-btn.tip-nav { padding:0.35rem 0.7rem; font-size:0.75rem; }
      .footer-links { gap: 0.75rem; flex-wrap: wrap; justify-content: center; }
      .tip-modal { padding: 1.5rem; }
      .tip-modal h3 { font-size: 1.2rem; }
      .live-ticker-wrap { font-size: 0.7rem; }
      .dice-mode-toggle { gap: 0.25rem; }
      .dice-mode-btn { padding: 0.4rem 1rem; font-size: 0.75rem; }
    }
  </style>
</head>
<body>

<nav>
  <div class="logo" onclick="showPage('home')">spunk<span>.bet</span></div>
  <div class="nav-center">
    <button class="nav-tab active" onclick="showPage('home')">Games</button>
    <button class="nav-tab" onclick="showPage('leaderboard-page')">Leaderboard</button>
    <button class="nav-tab" onclick="showPage('history-page')">History</button>
    <button class="nav-tab" onclick="showPage('wallets-page')">Wallets</button>
    <button class="nav-tab" onclick="showPage('fair-page')">Provably Fair</button>
  </div>
  <button class="hamburger" id="hamburger-btn" onclick="toggleMobileMenu()">
    <span></span><span></span><span></span>
  </button>
  <div class="nav-right">
    <div class="player-rank-badge" id="player-rank-badge" onclick="showPage('leaderboard-page')"></div>
    <div class="streak-badge" id="streak-badge" onclick="shareStreakOnX()">&#128293; <span id="streak-count">0</span> Streak</div>
    <div class="balance-display"><span id="balance-display">0</span> SPUNK•BET</div>
    <button class="tip-spunk-btn tip-nav" onclick="openTipModal()">🧡 Tip</button>
    <button class="share-btn" id="share-btn" onclick="openReferralModal()">Share &amp; Earn</button>
    <button class="wallet-btn" id="wallet-btn" onclick="handleWalletClick()">Connect Wallet</button>
  </div>
</nav>

<!-- Mobile Menu -->
<div class="mobile-menu" id="mobile-menu">
  <button onclick="showPage('home'); toggleMobileMenu()">Games</button>
  <button onclick="showPage('leaderboard-page'); toggleMobileMenu()">Leaderboard</button>
  <button onclick="showPage('history-page'); toggleMobileMenu()">History</button>
  <button onclick="showPage('wallets-page'); toggleMobileMenu()">Wallets</button>
  <button onclick="showPage('fair-page'); toggleMobileMenu()">Provably Fair</button>
  <button onclick="openReferralModal(); toggleMobileMenu()" id="mobile-share-btn" style="display:none;">Share &amp; Earn</button>
  <button class="tip-spunk-btn" style="margin:0.5rem auto;width:80%;" onclick="openTipModal(); toggleMobileMenu()">🧡 Tip Spunk</button>
</div>

<!-- Welcome Toast -->
<div class="toast" id="welcome-toast"></div>

<!-- Wallet Modal -->
<div class="wallet-modal-overlay" id="wallet-modal">
  <div class="wallet-modal">
    <h3>Connect Wallet</h3>
    <p>Connect your Bitcoin wallet to play with SPUNK•BET rune</p>
    <div class="wallet-option" onclick="connectXverse()">
      <div class="wallet-option-icon" style="background:#ee7b30;">X</div>
      <div class="wallet-option-info">
        <div class="wallet-option-name">Xverse</div>
        <div class="wallet-option-desc">Bitcoin, Ordinals, Runes & Stacks</div>
      </div>
    </div>
    <div class="wallet-option" onclick="connectUnisat()">
      <div class="wallet-option-icon" style="background:#000;border:1px solid #333;">U</div>
      <div class="wallet-option-info">
        <div class="wallet-option-name">Unisat</div>
        <div class="wallet-option-desc">Bitcoin, Ordinals, BRC-20 & Runes</div>
      </div>
    </div>
    <div class="wallet-option" onclick="connectMagicEden()">
      <div class="wallet-option-icon" style="background:#e42575;">M</div>
      <div class="wallet-option-info">
        <div class="wallet-option-name">Magic Eden</div>
        <div class="wallet-option-desc">Bitcoin, Ordinals & Runes</div>
      </div>
    </div>
    <div id="wallet-install-hint" style="display:none; margin-top:0.75rem; padding:0.75rem; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
      <p style="font-size:0.8rem; color:var(--muted); margin:0;" id="wallet-install-text">Wallet not detected. Install the wallet extension and refresh.</p>
    </div>
    <button class="wallet-modal-close" onclick="closeWalletModal()">Cancel</button>
  </div>
</div>

<!-- Wallet Details Modal -->
<div class="wallet-modal-overlay" id="wallet-details-modal">
  <div class="wallet-modal">
    <h3>Wallet Connected</h3>
    <div class="wallet-info" id="wallet-info-details"></div>
    <div id="wallet-tier-display" style="margin-bottom:1rem;"></div>
    <button class="btn" style="width:100%; margin-bottom:0.5rem;" onclick="disconnectWallet()">Disconnect</button>
    <button class="wallet-modal-close" onclick="closeWalletDetails()">Close</button>
  </div>
</div>

<!-- Referral Modal -->
<div class="wallet-modal-overlay" id="referral-modal">
  <div class="wallet-modal">
    <h3>Share &amp; Earn SPUNK•BET</h3>
    <p>Earn 7,777 SPUNK•BET for every friend who connects. First 100 referrers get bonus rewards!</p>
    <div class="referral-modal-content">
      <div style="font-size:0.8rem; color:var(--muted); margin-bottom:0.25rem;">Your referral link</div>
      <div class="referral-link-box">
        <input type="text" id="referral-link-input" readonly>
        <button onclick="copyReferralLink()">Copy</button>
      </div>
      <div class="referral-stat">
        <span class="referral-stat-label">Your code</span>
        <span class="referral-stat-value" id="referral-code">&mdash;</span>
      </div>
      <div class="referral-stat">
        <span class="referral-stat-label">Friends referred</span>
        <span class="referral-stat-value" id="referral-count">0</span>
      </div>
      <div class="referral-stat">
        <span class="referral-stat-label">Your tier</span>
        <span id="referral-tier"></span>
      </div>
      <div class="referral-stat">
        <span class="referral-stat-label">SPUNK•BET earned</span>
        <span class="referral-stat-value" id="referral-earned">0</span>
      </div>
      <div class="tiers-section">
        <div style="font-size:0.75rem; color:var(--muted); font-weight:600;">REFERRAL TIERS</div>
        <div class="tiers-grid" id="tiers-grid"></div>
      </div>
    </div>
    <button class="btn" style="width:100%; margin-bottom:0.5rem; background:#000; border:1px solid #333;" onclick="shareReferralOnX()">Share on 𝕏</button>
    <button class="wallet-modal-close" onclick="closeReferralModal()">Close</button>
  </div>
</div>

<!-- HOME -->
<div id="home" class="page active">
  <section class="hero">
    <h1>Play. Bet. <span>Win.</span></h1>
    <p>Provably fair casino games powered by the SPUNK•BET rune on Bitcoin. No accounts, no KYC. Connect and play.</p>
    <div style="display:flex;gap:0.75rem;justify-content:center;flex-wrap:wrap;margin-top:0.5rem;">
      <div class="shield-icon" style="cursor:pointer;margin:0;" onclick="showPage('fair-page')">Provably Fair</div>
      <div class="hero-flash hero-flash-pulse" onclick="claimFaucet()" style="cursor:pointer;margin:0;">FREE SPUNK•BET — Play Instantly</div>
    </div>
  </section>

  <!-- Visitor Counter -->
  <div style="display:flex;justify-content:center;gap:1.5rem;padding:0.5rem 1rem;font-size:0.7rem;color:var(--muted);">
    <span id="visitor-counter"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);margin-right:4px;animation:livePulse 1.5s infinite;vertical-align:middle;"></span> <span id="online-count">0</span> playing now</span>
    <span>|</span>
    <span id="total-visits-display"><span style="color:var(--accent);font-weight:600;" id="total-visits-count">0</span> total visits</span>
  </div>

  <!-- Live Wins Ticker -->
  <div class="live-ticker-wrap" id="live-ticker-wrap" style="display:none;">
    <div class="live-ticker-label"><span class="live-dot"></span> LIVE WINS</div>
    <div class="live-ticker">
      <div class="live-ticker-inner" id="live-ticker-inner"></div>
    </div>
  </div>

  <!-- Faucet Button (hidden, triggered by hero flash) -->
  <button class="faucet-btn" id="faucet-btn" onclick="claimFaucet()" style="display:none;">Claim</button>

  <!-- First 100 Referrers Banner -->
  <div class="first100-banner" id="first100-banner">
    <div class="first100-card">
      <div class="first100-left">
        <h3>First 100 Referrers Get <span>Bonus SPUNK•BET</span></h3>
        <p>Share your referral link and be among the first 100 to refer a friend. Early referrers earn 2x bonus rewards!</p>
        <button class="btn" style="margin-top:0.6rem;padding:0.45rem 1.2rem;font-size:0.8rem;" onclick="shareFirst100()">Share &amp; Claim Your Spot</button>
      </div>
      <div class="first100-counter">
        <div class="count" id="first100-count">100</div>
        <div class="label">Spots Left</div>
      </div>
    </div>
  </div>

  <div class="originals-header">
    <h2>Originals</h2>
    <span class="tag">10 GAMES</span>
  </div>

  <div class="game-grid">
    <div class="game-card" onclick="openGame('keno')">
      <div class="game-card-edge">1,000x</div>
      <div class="game-card-icon">&#127183;</div>
      <h3>Keno</h3>
      <p class="game-card-desc">Pick your numbers</p>
    </div>
    <div class="game-card" onclick="openGame('limbo')">
      <div class="game-card-edge">&#8734;x</div>
      <div class="game-card-icon">&#127756;</div>
      <h3>Limbo</h3>
      <p class="game-card-desc">Beat the target</p>
    </div>
    <div class="game-card" onclick="openGame('dice')">
      <div class="game-card-edge">up to 99x</div>
      <div class="game-card-icon">&#127922;</div>
      <h3>Dice</h3>
      <p class="game-card-desc">Roll under target</p>
    </div>
    <div class="game-card" onclick="openGame('coinflip')">
      <div class="game-card-edge">1.98x</div>
      <div class="game-card-icon">&#x1FA99;</div>
      <h3>Coin Flip</h3>
      <p class="game-card-desc">50/50 classic</p>
    </div>
    <div class="game-card" onclick="openGame('plinko')">
      <div class="game-card-edge">1,000x</div>
      <div class="game-card-icon">&#9899;</div>
      <h3>Plinko</h3>
      <p class="game-card-desc">Drop the ball</p>
    </div>
    <div class="game-card" onclick="openGame('mines')">
      <div class="game-card-edge">24.75x</div>
      <div class="game-card-icon">&#128163;</div>
      <h3>Mines</h3>
      <p class="game-card-desc">Avoid the bombs</p>
    </div>
    <div class="game-card" onclick="openGame('wheel')">
      <div class="game-card-edge">50x</div>
      <div class="game-card-icon">&#127905;</div>
      <h3>Wheel</h3>
      <p class="game-card-desc">Spin to win</p>
    </div>
    <div class="game-card" onclick="openGame('hilo')">
      <div class="game-card-edge">&#8734;x</div>
      <div class="game-card-icon">&#127136;</div>
      <h3>HiLo</h3>
      <p class="game-card-desc">Higher or lower</p>
    </div>
    <div class="game-card" onclick="openGame('crash')">
      <div class="game-card-edge">&#8734;x</div>
      <div class="game-card-icon">&#128200;</div>
      <h3>Crash</h3>
      <p class="game-card-desc">Cash out in time</p>
    </div>
    <div class="game-card" onclick="openGame('tower')">
      <div class="game-card-edge">500x</div>
      <div class="game-card-icon">&#127960;</div>
      <h3>Rune Tower</h3>
      <p class="game-card-desc">Climb the tower</p>
    </div>
  </div>

  <!-- Daily Bonus Spin -->
  <div class="daily-spin-section" id="daily-spin-section">
    <div class="daily-spin-card">
      <div class="daily-spin-left">
        <h3>Free Daily <span>Wheel Spin</span></h3>
        <p>Spin the wheel every day for free SPUNK•BET runes! Share on X for 2x the prize. Come back daily!</p>
      </div>
      <button class="daily-spin-btn" id="daily-spin-btn" onclick="openDailySpin()">Spin Now</button>
    </div>
  </div>

  <!-- Prize Wallet Showcase -->
  <div class="prize-section">
    <div class="prize-section-header">
      <h2>Win Real <span>Ordinal Prizes</span></h2>
      <p style="font-size:0.95rem;color:var(--text);margin-bottom:0.3rem;">Play games, hit milestones, and win Bitcoin ordinals.</p>
      <p style="font-size:0.8rem;">Real inscriptions. Real prizes. Yours to keep forever on-chain.</p>
      <span class="prize-wallet-link" onclick="navigator.clipboard.writeText('bc1p27l6s82w5dek9yffjtlyj58ue2sndxm6zszpcz9zcwqpd4v86n9s5l37xm');showToast('Prize wallet copied!')">Prize Wallet: bc1p27l6...s5l37xm</span>
    </div>
    <div class="prize-grid" id="prize-grid">
      <div style="grid-column:1/-1;text-align:center;padding:2rem 0;color:var(--muted);" id="prize-loading">Scanning prize wallet...</div>
    </div>
    <div class="prize-cta" style="display:flex;gap:0.75rem;justify-content:center;flex-wrap:wrap;">
      <button class="prize-cta-btn" onclick="sharePrizeOnX()"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg> Share Prizes &amp; Tag Friends</button>
      <a href="https://magiceden.us/u/bc1p27l6s82w5dek9yffjtlyj58ue2sndxm6zszpcz9zcwqpd4v86n9s5l37xm" target="_blank" class="prize-cta-btn" style="background:linear-gradient(90deg,#7c3aed,#a855f7);text-decoration:none;display:inline-flex;align-items:center;gap:0.5rem;">🔍 Verify on Magic Eden</a>
    </div>
  </div>
</div>

<!-- Daily Spin Modal -->
<div class="daily-spin-modal" id="daily-spin-modal">
  <div class="daily-spin-modal-inner">
    <h3>Daily Bonus Spin</h3>
    <p style="color:var(--muted);font-size:0.85rem;">Tap to spin!</p>
    <div id="daily-spin-display" style="font-size:4rem;margin:1rem 0;cursor:pointer;" onclick="executeDailySpin()">&#127905;</div>
    <div class="daily-spin-result" id="daily-spin-result" style="display:none;"></div>
    <div class="daily-spin-bonus" id="daily-spin-bonus" style="display:none;">Share on X for 2x the prize!</div>
    <button class="btn" id="daily-spin-share-btn" style="width:100%;margin-bottom:0.5rem;background:#000;border:1px solid #333;display:none;" onclick="shareDailySpinOnX()">Share on X for 2x Bonus</button>
    <button class="wallet-modal-close" onclick="closeDailySpin()">Close</button>
  </div>
</div>

<!-- Big Win Overlay -->
<div class="bigwin-overlay" id="bigwin-overlay">
  <div class="bigwin-card">
    <div class="bigwin-emoji" id="bigwin-emoji">&#127881;</div>
    <div class="bigwin-title">BIG WIN!</div>
    <div class="bigwin-amount" id="bigwin-amount">+0</div>
    <div class="bigwin-multi" id="bigwin-multi"></div>
    <div class="bigwin-bonus">Share on X &amp; earn 2,500 bonus SPUNK•BET! Win card auto-saves.</div>
    <button class="bigwin-share" onclick="shareBigWinOnX()"><svg viewBox="0 0 24 24" width="16" height="16" fill="#fff"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg> Share win + attach image on X</button>
    <button class="bigwin-dismiss" onclick="closeBigWin()">No thanks</button>
  </div>
</div>

<!-- COIN FLIP -->
<div id="coinflip" class="page">
  <div class="game-container">
    <button class="game-back" onclick="showPage('home')">&larr; Back to games</button>
    <div class="game-title">&#x1FA99; Coin Flip</div>
    <div class="game-payout-badge"><span class="payout-label">Max Payout</span><span class="payout-value">1.98x</span></div>
    <div class="bet-controls">
      <div class="bet-row">
        <span class="bet-label">Bet (SPUNK•BET)</span>
        <input type="number" class="bet-input" id="cf-bet" value="100" min="100">
        <div class="bet-quick">
          <button onclick="setBet('cf-bet','half')">&#189;</button>
          <button onclick="setBet('cf-bet','double')">2x</button>
          <button onclick="setBet('cf-bet','max')">Max</button>
        </div>
      </div>
      <div class="bet-row">
        <span class="bet-label">Pick</span>
        <div class="flip-choices">
          <button class="flip-choice selected" id="cf-heads" onclick="pickSide('heads')">Heads</button>
          <button class="flip-choice" id="cf-tails" onclick="pickSide('tails')">Tails</button>
        </div>
      </div>
      <div class="mode-tabs">
        <button class="mode-tab active" onclick="setAutoMode('coinflip',false,this)">Manual</button>
        <button class="mode-tab" onclick="setAutoMode('coinflip',true,this)">Auto</button>
      </div>
      <div class="autobet-panel" id="autobet-coinflip"></div>
      <label class="turbo-toggle"><input type="checkbox" id="turbo-coinflip" onchange="toggleTurbo('coinflip')"><span class="turbo-switch"></span>Turbo</label>
    </div>
    <div id="cf-result" class="result"></div>
    <div class="game-area">
      <div class="coin" id="cf-coin">?</div>
      <div class="seed-display" id="cf-seed" onclick="copySeed('cf-seed')" title="Click to copy seed hash"></div>
    </div>
    <button class="btn" style="width:100%; padding:0.75rem;" onclick="flipCoin()">Flip Coin</button>
  </div>
</div>

<!-- DICE -->
<div id="dice" class="page">
  <div class="game-container">
    <button class="game-back" onclick="showPage('home')">&larr; Back to games</button>
    <div class="game-title">&#127922; Dice</div>
    <div class="game-payout-badge"><span class="payout-label">Max Payout</span><span class="payout-value" id="dice-payout-badge">2.00x</span></div>
    <div class="bet-controls">
      <div class="bet-row">
        <span class="bet-label">Bet (SPUNK•BET)</span>
        <input type="number" class="bet-input" id="dice-bet" value="100" min="100">
        <div class="bet-quick">
          <button onclick="setBet('dice-bet','half')">&#189;</button>
          <button onclick="setBet('dice-bet','double')">2x</button>
          <button onclick="setBet('dice-bet','max')">Max</button>
        </div>
      </div>
      <div class="mode-tabs">
        <button class="mode-tab active" onclick="setAutoMode('dice',false,this)">Manual</button>
        <button class="mode-tab" onclick="setAutoMode('dice',true,this)">Auto</button>
      </div>
      <div class="autobet-panel" id="autobet-dice"></div>
      <label class="turbo-toggle"><input type="checkbox" id="turbo-dice" onchange="toggleTurbo('dice')"><span class="turbo-switch"></span>Turbo</label>
    </div>
    <div id="dice-result" class="result"></div>
    <div class="game-area">
      <div class="dice-mode-toggle">
        <button class="dice-mode-btn active" id="dice-under-btn" onclick="setDiceMode('under')">ROLL UNDER</button>
        <button class="dice-mode-btn" id="dice-over-btn" onclick="setDiceMode('over')">ROLL OVER</button>
      </div>
      <div class="dice-target">Roll <span id="dice-mode-label">under</span> <input type="number" id="dice-target-input" class="bet-input" style="width:60px;display:inline-block;text-align:center;padding:0.2rem 0.4rem;font-size:1rem;font-weight:700;" value="50" min="5" max="95" oninput="syncDiceTarget()"> <span id="dice-target-val" style="display:none;">50</span> to win</div>
      <div class="dice-display">
        <div class="die" id="dice-die">&#8212;</div>
      </div>
      <div class="dice-slider-wrap">
        <input type="range" class="dice-slider" id="dice-slider" min="5" max="95" value="50" oninput="updateDiceSlider()">
        <div class="dice-labels"><span>5</span><span>50</span><span>95</span></div>
      </div>
      <div class="dice-multi">Win chance: <span id="dice-chance">49%</span> &middot; Payout: <span id="dice-payout" style="color:var(--green);font-weight:600">2.00x</span></div>
      <div class="seed-display" id="dice-seed" onclick="copySeed('dice-seed')" title="Click to copy seed hash"></div>
    </div>
    <button class="btn" style="width:100%; padding:0.75rem;" onclick="rollDice()">Roll Dice</button>
  </div>
</div>

<!-- MINES -->
<div id="mines" class="page">
  <div class="game-container">
    <button class="game-back" onclick="showPage('home')">&larr; Back to games</button>
    <div class="game-title">&#128163; Mines</div>
    <div class="game-payout-badge"><span class="payout-label">Max Payout</span><span class="payout-value">24.75x</span></div>
    <div class="bet-controls">
      <div class="bet-row">
        <span class="bet-label">Bet (SPUNK•BET)</span>
        <input type="number" class="bet-input" id="mines-bet" value="100" min="100">
        <div class="bet-quick">
          <button onclick="setBet('mines-bet','half')">&#189;</button>
          <button onclick="setBet('mines-bet','double')">2x</button>
          <button onclick="setBet('mines-bet','max')">Max</button>
        </div>
      </div>
      <div class="bet-row">
        <span class="bet-label">Mines</span>
        <div class="mines-count-row">
          <button class="mines-count-btn" onclick="changeMines(-1)">-</button>
          <input type="number" id="mines-count" class="bet-input" style="width:50px;text-align:center;padding:0.2rem 0.3rem;font-size:1rem;font-weight:700;" value="3" min="1" max="24" oninput="syncMinesCount()">
          <button class="mines-count-btn" onclick="changeMines(1)">+</button>
        </div>
      </div>
      <div class="mode-tabs">
        <button class="mode-tab active" onclick="setAutoMode('mines',false,this)">Manual</button>
        <button class="mode-tab" onclick="setAutoMode('mines',true,this)">Auto</button>
      </div>
      <div class="autobet-panel" id="autobet-mines"></div>
      <label class="turbo-toggle"><input type="checkbox" id="turbo-mines" onchange="toggleTurbo('mines')"><span class="turbo-switch"></span>Turbo</label>
    </div>
    <div id="mines-result" class="result"></div>
    <div class="game-area" style="padding:1.25rem;">
      <div class="mines-grid" id="mines-grid"></div>
      <div class="mines-info">
        <div>Revealed: <span id="mines-revealed">0</span></div>
        <div>Multiplier: <span id="mines-multi">1.00x</span></div>
        <div>Profit: <span id="mines-profit">+0</span> SPUNK•BET</div>
      </div>
      <div class="seed-display" id="mines-seed" onclick="copySeed('mines-seed')" title="Click to copy seed hash" style="width:100%;"></div>
    </div>
    <div style="display:flex;gap:0.5rem;">
      <button class="btn" style="flex:1; padding:0.75rem;" id="mines-start-btn" onclick="startMines()">Start Game</button>
      <button class="btn btn-green" style="flex:1; padding:0.75rem; display:none;" id="mines-cashout-btn" onclick="cashoutMines()">Cash Out</button>
    </div>
  </div>
</div>

<!-- CRASH -->
<div id="crash" class="page">
  <div class="game-container">
    <button class="game-back" onclick="showPage('home')">&larr; Back to games</button>
    <div class="game-title">&#128200; Crash</div>
    <div class="game-payout-badge"><span class="payout-label">Max Payout</span><span class="payout-value">Unlimited</span></div>
    <div class="bet-controls">
      <div class="bet-row">
        <span class="bet-label">Bet (SPUNK•BET)</span>
        <input type="number" class="bet-input" id="crash-bet" value="100" min="100">
        <div class="bet-quick">
          <button onclick="setBet('crash-bet','half')">&#189;</button>
          <button onclick="setBet('crash-bet','double')">2x</button>
          <button onclick="setBet('crash-bet','max')">Max</button>
        </div>
      </div>
      <div class="mode-tabs">
        <button class="mode-tab active" onclick="setAutoMode('crash',false,this)">Manual</button>
        <button class="mode-tab" onclick="setAutoMode('crash',true,this)">Auto</button>
      </div>
      <div class="autobet-panel" id="autobet-crash"></div>
      <label class="turbo-toggle"><input type="checkbox" id="turbo-crash" onchange="toggleTurbo('crash')"><span class="turbo-switch"></span>Turbo</label>
    </div>
    <div id="crash-result" class="result"></div>
    <div class="game-area" style="padding:1.25rem;">
      <div class="crash-graph"><canvas class="crash-canvas" id="crash-canvas"></canvas></div>
      <div class="crash-multi" id="crash-multi">1.00x</div>
      <div class="crash-status" id="crash-status">Place your bet and launch</div>
      <div class="seed-display" id="crash-seed" onclick="copySeed('crash-seed')" title="Click to copy seed hash" style="width:100%;"></div>
    </div>
    <div style="display:flex;gap:0.5rem;">
      <button class="btn" style="flex:1; padding:0.75rem;" id="crash-start-btn" onclick="startCrash()">Launch</button>
      <button class="btn btn-green" style="flex:1; padding:0.75rem; display:none;" id="crash-cashout-btn" onclick="cashoutCrash()">Cash Out</button>
    </div>
  </div>
</div>

<!-- LIMBO -->
<div id="limbo" class="page">
  <div class="game-container">
    <button class="game-back" onclick="showPage('home')">&larr; Back to games</button>
    <div class="game-title">&#127756; Limbo</div>
    <div class="game-payout-badge"><span class="payout-label">Max Payout</span><span class="payout-value">Unlimited</span></div>
    <div class="bet-controls">
      <div class="bet-row">
        <span class="bet-label">Bet (SPUNK•BET)</span>
        <input type="number" class="bet-input" id="limbo-bet" value="100" min="100">
        <div class="bet-quick">
          <button onclick="setBet('limbo-bet','half')">&#189;</button>
          <button onclick="setBet('limbo-bet','double')">2x</button>
          <button onclick="setBet('limbo-bet','max')">Max</button>
        </div>
      </div>
      <div class="bet-row">
        <span class="bet-label">Target</span>
        <input type="number" class="bet-input" id="limbo-target" value="2" min="1.01" max="1000000" step="0.01" oninput="updateLimboDisplay()">
        <div class="bet-quick">
          <button onclick="setLimboTarget(1.5)">1.5x</button>
          <button onclick="setLimboTarget(2)">2x</button>
          <button onclick="setLimboTarget(10)">10x</button>
          <button onclick="setLimboTarget(100)">100x</button>
        </div>
      </div>
      <div class="mode-tabs">
        <button class="mode-tab active" onclick="setAutoMode('limbo',false,this)">Manual</button>
        <button class="mode-tab" onclick="setAutoMode('limbo',true,this)">Auto</button>
      </div>
      <div class="autobet-panel" id="autobet-limbo"></div>
      <label class="turbo-toggle"><input type="checkbox" id="turbo-limbo" onchange="toggleTurbo('limbo')"><span class="turbo-switch"></span>Turbo</label>
    </div>
    <div id="limbo-result" class="result"></div>
    <div class="game-area">
      <div class="limbo-history" id="limbo-history"></div>
      <div class="limbo-target-display">Target: <span id="limbo-target-display">2.00x</span></div>
      <div class="limbo-display idle" id="limbo-display">1.00x</div>
      <div style="font-size:0.8rem; color:var(--muted)">Win chance: <span id="limbo-chance">49.0%</span></div>
      <div class="seed-display" id="limbo-seed" onclick="copySeed('limbo-seed')" title="Click to copy seed hash"></div>
    </div>
    <button class="btn" style="width:100%; padding:0.75rem;" onclick="playLimbo()">Play</button>
  </div>
</div>

<!-- KENO -->
<div id="keno" class="page">
  <div class="game-container">
    <button class="game-back" onclick="showPage('home')">&larr; Back to games</button>
    <div class="game-title">&#127183; Keno</div>
    <div class="game-payout-badge"><span class="payout-label">Max Payout</span><span class="payout-value">1,000x</span></div>
    <div class="bet-controls">
      <div class="bet-row">
        <span class="bet-label">Bet (SPUNK•BET)</span>
        <input type="number" class="bet-input" id="keno-bet" value="100" min="100">
        <div class="bet-quick">
          <button onclick="setBet('keno-bet','half')">&#189;</button>
          <button onclick="setBet('keno-bet','double')">2x</button>
          <button onclick="setBet('keno-bet','max')">Max</button>
        </div>
      </div>
      <div class="bet-row">
        <span class="bet-label">Picks</span>
        <div class="keno-picks">
          <button class="keno-pick-btn" onclick="kenoAutoSelect(1)">1</button>
          <button class="keno-pick-btn" onclick="kenoAutoSelect(3)">3</button>
          <button class="keno-pick-btn active" onclick="kenoAutoSelect(5)">5</button>
          <button class="keno-pick-btn" onclick="kenoAutoSelect(7)">7</button>
          <button class="keno-pick-btn" onclick="kenoAutoSelect(10)">10</button>
        </div>
      </div>
      <div class="bet-row">
        <span class="bet-label">Risk</span>
        <div class="keno-picks">
          <button class="plinko-risk-btn active" id="keno-risk-low" onclick="setKenoRisk('low')">Low</button>
          <button class="plinko-risk-btn" id="keno-risk-med" onclick="setKenoRisk('medium')">Medium</button>
          <button class="plinko-risk-btn" id="keno-risk-high" onclick="setKenoRisk('high')">High</button>
        </div>
      </div>
      <div class="mode-tabs">
        <button class="mode-tab active" onclick="setAutoMode('keno',false,this)">Manual</button>
        <button class="mode-tab" onclick="setAutoMode('keno',true,this)">Auto</button>
      </div>
      <div class="autobet-panel" id="autobet-keno"></div>
      <label class="turbo-toggle"><input type="checkbox" id="turbo-keno" onchange="toggleTurbo('keno')"><span class="turbo-switch"></span>Turbo</label>
    </div>
    <div id="keno-result" class="result"></div>
    <div class="game-area" style="padding:1rem;">
      <div class="keno-drawn-area" id="keno-drawn-area"></div>
      <div class="keno-info">Selected: <span id="keno-selected-count">0</span>/10 &middot; Hits needed for payout: <span id="keno-hits-needed">1</span></div>
      <div class="keno-grid" id="keno-grid"></div>
      <div class="seed-display" id="keno-seed" onclick="copySeed('keno-seed')" title="Click to copy seed hash" style="width:100%;"></div>
    </div>
    <div style="display:flex;gap:0.5rem;">
      <button class="btn btn-outline" style="flex:1; padding:0.75rem;" onclick="initKenoGrid()">Clear</button>
      <button class="btn" style="flex:1; padding:0.75rem;" onclick="playKenoAnimated()">Play Keno</button>
    </div>
    <div class="keno-payout-line" id="keno-payout-line"></div>
  </div>
</div>

<!-- WHEEL -->
<div id="wheel" class="page">
  <div class="game-container">
    <button class="game-back" onclick="showPage('home')">&larr; Back to games</button>
    <div class="game-title">&#127905; Wheel</div>
    <div class="game-payout-badge"><span class="payout-label">Max Payout</span><span class="payout-value">50x</span></div>
    <div class="bet-controls">
      <div class="bet-row">
        <span class="bet-label">Bet (SPUNK•BET)</span>
        <input type="number" class="bet-input" id="wheel-bet" value="100" min="100">
        <div class="bet-quick">
          <button onclick="setBet('wheel-bet','half')">&#189;</button>
          <button onclick="setBet('wheel-bet','double')">2x</button>
          <button onclick="setBet('wheel-bet','max')">Max</button>
        </div>
      </div>
      <div class="bet-row">
        <span class="bet-label">Risk</span>
        <div class="keno-picks">
          <button class="plinko-risk-btn active" id="wheel-risk-low" onclick="setWheelRisk('low')">Low</button>
          <button class="plinko-risk-btn" id="wheel-risk-med" onclick="setWheelRisk('medium')">Medium</button>
          <button class="plinko-risk-btn" id="wheel-risk-high" onclick="setWheelRisk('high')">High</button>
        </div>
      </div>
      <div class="mode-tabs">
        <button class="mode-tab active" onclick="setAutoMode('wheel',false,this)">Manual</button>
        <button class="mode-tab" onclick="setAutoMode('wheel',true,this)">Auto</button>
      </div>
      <div class="autobet-panel" id="autobet-wheel"></div>
      <label class="turbo-toggle"><input type="checkbox" id="turbo-wheel" onchange="toggleTurbo('wheel')"><span class="turbo-switch"></span>Turbo</label>
    </div>
    <div id="wheel-result" class="result"></div>
    <div class="game-area" style="padding:1.25rem;">
      <div class="wheel-container">
        <div class="wheel-pointer"></div>
        <canvas class="wheel-canvas" id="wheel-canvas" width="560" height="560"></canvas>
        <div class="wheel-center" id="wheel-center">SPIN</div>
      </div>
      <div class="wheel-result-text" id="wheel-result-text"></div>
      <div class="seed-display" id="wheel-seed" onclick="copySeed('wheel-seed')" title="Click to copy seed hash" style="width:100%;"></div>
    </div>
    <button class="btn" style="width:100%; padding:0.75rem;" id="wheel-spin-btn" onclick="spinWheel()">Spin</button>
  </div>
</div>

<!-- PLINKO -->
<div id="plinko" class="page">
  <div class="game-container">
    <button class="game-back" onclick="showPage('home')">&larr; Back to games</button>
    <div class="game-title">&#9899; Plinko</div>
    <div class="game-payout-badge"><span class="payout-label">Max Payout</span><span class="payout-value">1,000x</span></div>
    <div class="bet-controls">
      <div class="bet-row">
        <span class="bet-label">Bet (SPUNK•BET)</span>
        <input type="number" class="bet-input" id="plinko-bet" value="100" min="100">
        <div class="bet-quick">
          <button onclick="setBet('plinko-bet','half')">&#189;</button>
          <button onclick="setBet('plinko-bet','double')">2x</button>
          <button onclick="setBet('plinko-bet','max')">Max</button>
        </div>
      </div>
      <div class="bet-row">
        <span class="bet-label">Risk</span>
        <div class="plinko-risk-row">
          <button class="plinko-risk-btn active" id="plinko-risk-low" onclick="setPlinkoRisk('low')">Low</button>
          <button class="plinko-risk-btn" id="plinko-risk-med" onclick="setPlinkoRisk('medium')">Medium</button>
          <button class="plinko-risk-btn" id="plinko-risk-high" onclick="setPlinkoRisk('high')">High</button>
        </div>
      </div>
      <div class="bet-row">
        <span class="bet-label">Rows</span>
        <div class="plinko-rows-row">
          <button class="mines-count-btn" onclick="changePlinkoRows(-1)">-</button>
          <input type="number" id="plinko-rows" class="bet-input" style="width:50px;text-align:center;padding:0.2rem 0.3rem;font-size:1rem;font-weight:700;" value="12" min="8" max="16" oninput="syncPlinkoRows()">
          <button class="mines-count-btn" onclick="changePlinkoRows(1)">+</button>
        </div>
      </div>
      <div class="mode-tabs">
        <button class="mode-tab active" onclick="setAutoMode('plinko',false,this)">Manual</button>
        <button class="mode-tab" onclick="setAutoMode('plinko',true,this)">Auto</button>
      </div>
      <div class="autobet-panel" id="autobet-plinko"></div>
      <label class="turbo-toggle"><input type="checkbox" id="turbo-plinko" onchange="toggleTurbo('plinko')"><span class="turbo-switch"></span>Turbo</label>
    </div>
    <div id="plinko-result" class="result"></div>
    <div class="game-area" style="padding:1rem;">
      <div class="plinko-container">
        <canvas class="plinko-canvas" id="plinko-canvas" width="800" height="700"></canvas>
      </div>
      <div class="plinko-result-text" id="plinko-result-text"></div>
      <div class="seed-display" id="plinko-seed" onclick="copySeed('plinko-seed')" title="Click to copy seed hash" style="width:100%;"></div>
    </div>
    <button class="btn" style="width:100%; padding:0.75rem;" id="plinko-drop-btn" onclick="dropPlinko()">Drop Ball</button>
  </div>
</div>

<!-- HILO -->
<div id="hilo" class="page">
  <div class="game-container">
    <button class="game-back" onclick="showPage('home')">&larr; Back to games</button>
    <div class="game-title">&#127136; HiLo</div>
    <div class="game-payout-badge"><span class="payout-label">Max Payout</span><span class="payout-value">Unlimited</span></div>
    <div class="bet-controls">
      <div class="bet-row">
        <span class="bet-label">Bet (SPUNK•BET)</span>
        <input type="number" class="bet-input" id="hilo-bet" value="100" min="100">
        <div class="bet-quick">
          <button onclick="setBet('hilo-bet','half')">&#189;</button>
          <button onclick="setBet('hilo-bet','double')">2x</button>
          <button onclick="setBet('hilo-bet','max')">Max</button>
        </div>
      </div>
      <div class="mode-tabs">
        <button class="mode-tab active" onclick="setAutoMode('hilo',false,this)">Manual</button>
        <button class="mode-tab" onclick="setAutoMode('hilo',true,this)">Auto</button>
      </div>
      <div class="autobet-panel" id="autobet-hilo"></div>
      <label class="turbo-toggle"><input type="checkbox" id="turbo-hilo" onchange="toggleTurbo('hilo')"><span class="turbo-switch"></span>Turbo</label>
    </div>
    <div id="hilo-result" class="result"></div>
    <div class="game-area">
      <div class="hilo-cards">
        <div class="hilo-card" id="hilo-current">
          <div class="card-rank">?</div>
          <div class="card-suit"></div>
        </div>
        <div style="font-size:1.5rem;color:var(--muted)">&#8594;</div>
        <div class="hilo-card next" id="hilo-next">
          <div class="card-rank">?</div>
          <div class="card-suit"></div>
        </div>
      </div>
      <div class="hilo-multi" id="hilo-multi">1.00x</div>
      <div class="hilo-streak">Streak: <span id="hilo-streak">0</span></div>
      <div class="hilo-choices" id="hilo-choices">
        <button class="hilo-choice" id="hilo-hi-btn" onclick="guessHiLo('hi')">&#9650; Higher</button>
        <button class="hilo-choice" id="hilo-lo-btn" onclick="guessHiLo('lo')">&#9660; Lower</button>
      </div>
      <div class="seed-display" id="hilo-seed" onclick="copySeed('hilo-seed')" title="Click to copy seed hash" style="width:100%;"></div>
    </div>
    <div style="display:flex;gap:0.5rem;">
      <button class="btn" style="flex:1; padding:0.75rem;" id="hilo-start-btn" onclick="startHiLo()">Deal</button>
      <button class="btn btn-green" style="flex:1; padding:0.75rem; display:none;" id="hilo-cashout-btn" onclick="cashoutHiLo()">Cash Out</button>
    </div>
  </div>
</div>

<!-- RUNE TOWER -->
<div id="tower" class="page">
  <div class="game-container">
    <button class="game-back" onclick="showPage('home')">&larr; Back to games</button>
    <div class="game-title">&#127960; Rune Tower</div>
    <div class="game-payout-badge"><span class="payout-label">Max Payout</span><span class="payout-value">500x</span></div>
    <div class="bet-controls">
      <div class="bet-row">
        <span class="bet-label">Bet (SPUNK•BET)</span>
        <input type="number" class="bet-input" id="tower-bet" value="100" min="100">
        <div class="bet-quick">
          <button onclick="setBet('tower-bet','half')">&#189;</button>
          <button onclick="setBet('tower-bet','double')">2x</button>
          <button onclick="setBet('tower-bet','max')">Max</button>
        </div>
      </div>
      <div class="bet-row">
        <span class="bet-label">Difficulty</span>
        <div class="tower-diff-row">
          <button class="tower-diff-btn active" id="tower-easy" onclick="setTowerDiff('easy')">Easy</button>
          <button class="tower-diff-btn" id="tower-medium" onclick="setTowerDiff('medium')">Medium</button>
          <button class="tower-diff-btn" id="tower-hard" onclick="setTowerDiff('hard')">Hard</button>
          <button class="tower-diff-btn" id="tower-expert" onclick="setTowerDiff('expert')">Expert</button>
        </div>
      </div>
      <div class="mode-tabs">
        <button class="mode-tab active" onclick="setAutoMode('tower',false,this)">Manual</button>
        <button class="mode-tab" onclick="setAutoMode('tower',true,this)">Auto</button>
      </div>
      <div class="autobet-panel" id="autobet-tower"></div>
      <label class="turbo-toggle"><input type="checkbox" id="turbo-tower" onchange="toggleTurbo('tower')"><span class="turbo-switch"></span>Turbo</label>
    </div>
    <div id="tower-result" class="result"></div>
    <div class="game-area" style="padding:1rem;">
      <div class="tower-info">
        <div>Floor: <span id="tower-floor">0</span></div>
        <div>Multiplier: <span id="tower-multi">1.00x</span></div>
        <div>Profit: <span id="tower-profit">+0</span></div>
      </div>
      <div class="tower-grid" id="tower-grid"></div>
      <div class="seed-display" id="tower-seed" onclick="copySeed('tower-seed')" title="Click to copy seed hash" style="width:100%;"></div>
    </div>
    <div style="display:flex;gap:0.5rem;">
      <button class="btn" style="flex:1; padding:0.75rem;" id="tower-start-btn" onclick="startTower()">Start Climb</button>
      <button class="btn btn-green" style="flex:1; padding:0.75rem; display:none;" id="tower-cashout-btn" onclick="cashoutTower()">Cash Out</button>
    </div>
  </div>
</div>

<!-- LEADERBOARD PAGE -->
<div id="leaderboard-page" class="page">
  <div class="game-container">
    <h2 style="font-size:1.3rem;font-weight:700;margin-bottom:0.25rem;">Leaderboard & Ranks</h2>
    <p style="color:var(--muted);font-size:0.85rem;margin-bottom:1rem;">Wager more to rank up. Top players win daily & weekly SPUNK prizes automatically.</p>

    <!-- Your Rank Card -->
    <div class="leaderboard-card" style="margin-bottom:1rem;border-color:var(--accent);box-shadow:0 0 20px rgba(255,95,31,0.08);">
      <h3>Your Rank</h3>
      <div id="player-rank-card"></div>
    </div>

    <!-- Live Stats -->
    <div class="leaderboard-card" style="margin-bottom:1rem;">
      <h3>Live Stats</h3>
      <div id="leaderboard-stats"></div>
    </div>

    <!-- Wager Leaderboard (Daily / Weekly) -->
    <div class="leaderboard-card" style="margin-bottom:1rem;">
      <h3>Wager Leaderboard</h3>
      <div class="lb-tabs">
        <button class="lb-tab active" onclick="switchLBTab('daily',this)">Daily</button>
        <button class="lb-tab" onclick="switchLBTab('weekly',this)">Weekly</button>
        <button class="lb-tab" onclick="switchLBTab('alltime',this)">All Time</button>
      </div>
      <div id="wager-leaderboard"></div>
      <div id="wager-prizes" style="margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid var(--border);"></div>
    </div>

    <!-- Rank Tiers -->
    <div class="leaderboard-card" style="margin-bottom:1rem;">
      <h3>Rank Tiers</h3>
      <div id="rank-tiers"></div>
    </div>

    <!-- Referral Leaderboard -->
    <div class="leaderboard-card">
      <h3>Top Referrers</h3>
      <div id="leaderboard-list"></div>
    </div>
    <div class="leaderboard-card" style="margin-top:1rem;">
      <h3>Referral Tier Rewards</h3>
      <div class="tiers-grid" id="leaderboard-tiers"></div>
    </div>
  </div>
</div>

<!-- HISTORY PAGE -->
<div id="history-page" class="page">
  <div class="game-container">
    <div style="display:flex;gap:0;margin-bottom:1rem;">
      <button class="mode-tab active" id="hist-tab-all" onclick="switchHistoryTab('all',this)">All Bets</button>
      <button class="mode-tab" id="hist-tab-mine" onclick="switchHistoryTab('mine',this)">My Bets</button>
    </div>
    <div id="history-all-list" class="history-list" style="font-size:0.85rem;">
      <div style="color:var(--muted);text-align:center;padding:2rem;">Loading live bets...</div>
    </div>
    <div id="history-full-list" class="history-list" style="font-size:0.85rem;display:none;">
      <div style="color:var(--muted);text-align:center;padding:2rem;">No bets yet. Go play!</div>
    </div>
  </div>
</div>

<!-- WALLETS PAGE -->
<div id="wallets-page" class="page">
  <div class="wallets-container">
    <h2>Spunk.Bet Wallets</h2>
    <p>These are the official Spunk.Bet wallets. Send runes, BTC, or ordinals to fund rewards, prizes, and payouts for players.</p>

    <div class="wallet-card">
      <h3>House Wallet <span class="wallet-tag rune">RUNES</span> <span class="wallet-tag btc">BTC</span></h3>
      <div class="wallet-purpose">Funds SPUNK•BET rune payouts for faucet claims, referral rewards, and game winnings. Also accepts BTC for operational costs.</div>
      <div class="wallet-addr-box">
        <input type="text" value="bc1pkepg42ctsvsxk499qu02qqyyz88gwjchnjpsu22wmng9rhpfv3jqw2t2hm" readonly id="house-wallet-addr">
        <button onclick="copyWalletAddr('house-wallet-addr')">Copy</button>
      </div>
    </div>

    <div class="wallet-card" style="border-color:#a855f7;box-shadow:0 0 20px rgba(168,85,247,0.1);">
      <h3>Prize Wallet <span class="wallet-tag ord">ORDINALS</span></h3>
      <div class="wallet-purpose">Holds ordinal inscriptions for giveaways, tournament prizes, and special events. Ordinals sent here will be used as player rewards.</div>
      <div class="wallet-addr-box">
        <input type="text" value="bc1p27l6s82w5dek9yffjtlyj58ue2sndxm6zszpcz9zcwqpd4v86n9s5l37xm" readonly id="prize-wallet-addr">
        <button onclick="copyWalletAddr('prize-wallet-addr')">Copy</button>
      </div>
      <!-- Prize Preview in Wallets Page (auto-populated) -->
      <div style="margin-top:1.25rem;padding-top:1rem;border-top:1px solid #2a2a3e;">
        <h4 style="font-size:0.9rem;font-weight:700;margin-bottom:0.75rem;text-align:center;">
          <span style="background:linear-gradient(90deg,var(--accent),var(--purple),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Current Prizes You Can Win</span>
        </h4>
        <div id="wallet-prize-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;">
          <div style="grid-column:1/-1;text-align:center;padding:1rem 0;color:var(--muted);font-size:0.8rem;">Scanning prize wallet...</div>
        </div>
        <div style="text-align:center;margin-top:0.75rem;">
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;justify-content:center;">
            <button class="prize-cta-btn" style="font-size:0.8rem;padding:0.5rem 1.2rem;" onclick="sharePrizeOnX()"><svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:#fff;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg> Share & Win</button>
            <a href="https://magiceden.us/u/bc1p27l6s82w5dek9yffjtlyj58ue2sndxm6zszpcz9zcwqpd4v86n9s5l37xm" target="_blank" class="prize-cta-btn" style="font-size:0.8rem;padding:0.5rem 1.2rem;background:linear-gradient(90deg,#7c3aed,#a855f7);text-decoration:none;display:inline-flex;align-items:center;gap:0.4rem;">🔍 Verify on Magic Eden</a>
          </div>
        </div>
      </div>
    </div>

    <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.25rem;margin-top:1rem;">
      <h3 style="font-size:0.9rem;font-weight:700;margin-bottom:0.5rem;color:var(--green);">Transparency</h3>
      <p style="font-size:0.8rem;color:var(--muted);line-height:1.6;margin:0;">All wallet balances are publicly verifiable on-chain. These are taproot (P2TR) addresses on Bitcoin mainnet. You can verify balances using any Bitcoin block explorer.</p>
    </div>
  </div>
</div>

<!-- PROVABLY FAIR PAGE -->
<div id="fair-page" class="page">
  <div class="fair-container">
    <div class="shield-icon">Provably Fair</div>
    <h2>How We Prove Every Game is Fair</h2>
    <p>Every bet on Spunk.bet uses a provably fair system. Before each game, we generate a seed that determines the outcome. You can verify any bet after it's played.</p>

    <h3>How It Works</h3>
    <p><strong>1. Before the game:</strong> A random server seed is generated and its SHA-256 hash is shown to you. This commits us to the outcome before you bet.</p>
    <p><strong>2. You play:</strong> Your client seed (generated from your session) is combined with the server seed to produce the game result.</p>
    <p><strong>3. After the game:</strong> The raw server seed is revealed. You can hash it yourself to verify it matches the hash shown before the game.</p>

    <h3>The Math</h3>
    <p>The game result is derived from: <code>HMAC-SHA256(serverSeed, clientSeed + nonce)</code>. The first 8 hex characters are converted to a number between 0 and 1, which maps to the game outcome (coin side, dice roll, mine positions, crash point).</p>

    <h3>Verify a Bet</h3>
    <div class="fair-card">
      <label>Server Seed (revealed after game)</label>
      <input type="text" id="verify-server" placeholder="Paste the revealed server seed">
      <label>Server Seed Hash (shown before game)</label>
      <input type="text" id="verify-hash" placeholder="Paste the hash that was displayed">
      <label>Client Seed</label>
      <input type="text" id="verify-client" placeholder="Your client seed">
      <label>Nonce</label>
      <input type="number" id="verify-nonce" placeholder="Game number" value="0">
      <button class="btn" style="width:100%;" onclick="verifyBet()">Verify</button>
      <div class="verify-result" id="verify-result" style="margin-top:0.75rem;"></div>
    </div>

    <h3>Your Current Seeds</h3>
    <div class="fair-card">
      <label>Client Seed (yours)</label>
      <input type="text" id="my-client-seed" readonly>
      <label>Next Server Seed Hash (our commitment)</label>
      <input type="text" id="my-server-hash" readonly>
      <label>Games Played (nonce)</label>
      <input type="text" id="my-nonce" readonly>
      <button class="btn btn-outline" style="width:100%; margin-top:0.25rem;" onclick="rotateClientSeed()">Rotate Client Seed</button>
    </div>
  </div>
</div>

<footer>
  <div class="footer-links" style="margin-bottom:0.5rem;">
    <a href="javascript:openGame('dice')">Dice</a>
    <a href="javascript:openGame('coinflip')">Coin Flip</a>
    <a href="javascript:openGame('plinko')">Plinko</a>
    <a href="javascript:openGame('mines')">Mines</a>
    <a href="javascript:openGame('wheel')">Wheel</a>
    <a href="javascript:openGame('crash')">Crash</a>
    <a href="javascript:openGame('limbo')">Limbo</a>
    <a href="javascript:openGame('keno')">Keno</a>
    <a href="javascript:openGame('hilo')">HiLo</a>
    <a href="javascript:openGame('tower')">Tower</a>
  </div>
  <div class="footer-links">
    <a href="https://spunkart.com" target="_blank">SpunkArt.com</a>
    <a href="https://x.com/SpunkArt13" target="_blank">@SpunkArt13</a>
    <button class="tip-spunk-btn" onclick="openTipModal()"><span class="tip-icon">🧡</span> Tip Spunk</button>
    <a href="https://magiceden.us/ordinals/marketplace/spunkart" target="_blank">SpunkArt ME</a>
  </div>
  <p>spunk.bet &mdash; powered by SPUNK•BET rune on Bitcoin</p>
  <p style="margin-top:0.5rem; opacity:0.5;">Playing with SPUNK•BET rune tokens &middot; All games are provably fair</p>
  <div style="margin-top:1.25rem; padding:1rem 1.5rem; border:1px solid #ff5f1f33; border-radius:12px; max-width:500px; margin-left:auto; margin-right:auto; background:rgba(255,95,31,0.03);">
    <p style="font-size:0.85rem; color:var(--text); margin:0 0 0.4rem; font-weight:700;">Free games. Real prizes. Open source. 🧡</p>
    <p style="font-size:0.75rem; color:var(--muted); margin:0; line-height:1.5;">Code is <a href="https://github.com/Spunkeroo/spunk-bet" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:600;">open source on GitHub</a>. Bugs or ideas? DM <a href="https://x.com/SpunkArt13" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:600;">@SpunkArt13</a></p>
  </div>
  <div style="margin-top:1.5rem; padding-top:1rem; border-top:1px solid #222; max-width:600px; margin-left:auto; margin-right:auto;">
    <p style="font-size:0.7rem; opacity:0.4; line-height:1.6;">
      <strong>Disclaimer:</strong> spunk.bet is an entertainment platform for fun only. All gameplay uses SPUNK•BET rune tokens and carries no guaranteed monetary value. We are not responsible for any losses, errors, bugs, or technical issues. Play at your own risk. No refunds. By using this site you acknowledge that this is a game, not financial advice, and you accept full responsibility for your actions. Must be 18+ or of legal age in your jurisdiction. This site does not collect personal data beyond what is stored locally in your browser.
    </p>
  </div>
</footer>

<!-- Tip Modal -->
<div class="tip-modal-overlay" id="tip-modal" onclick="if(event.target===this)closeTipModal()">
  <div class="tip-modal">
    <h3>🧡 <span class="tip-title-text">Tip Spunk</span></h3>
    <p style="font-size:0.9rem;color:var(--text);line-height:1.6;margin-bottom:1rem;">One person, one AI, built in a day. Play for fun, win real ordinals, no BTC needed. Grateful for every player and every tip — you're what keeps this alive. Much love 🧡</p>
    <div class="tip-addr" id="tip-addr" onclick="copyTipAddr()">bc1q05ay5x4lwjl8pphy83j8wg08nwq2jdvnlw8ekl</div>
    <div style="font-size:0.75rem;color:var(--muted);margin-bottom:1rem;">Tap address to copy</div>
    <button class="btn" style="width:100%;background:#111;border:1px solid #333;" onclick="closeTipModal()">Close</button>
  </div>
</div>

<script>
// ===== PROVABLY FAIR SYSTEM =====
// Uses SHA-256 HMAC for seed-based outcome generation
// Server seed is committed (hashed) before each game, revealed after

function generateRandomHex(bytes) {
  const arr = new Uint8Array(bytes);
  crypto.getRandomValues(arr);
  return Array.from(arr, b => b.toString(16).padStart(2, '0')).join('');
}

async function sha256(message) {
  const encoder = new TextEncoder();
  const data = encoder.encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hashBuffer), b => b.toString(16).padStart(2, '0')).join('');
}

async function hmacSha256(key, message) {
  const encoder = new TextEncoder();
  const keyData = encoder.encode(key);
  const msgData = encoder.encode(message);
  const cryptoKey = await crypto.subtle.importKey('raw', keyData, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']);
  const sig = await crypto.subtle.sign('HMAC', cryptoKey, msgData);
  return Array.from(new Uint8Array(sig), b => b.toString(16).padStart(2, '0')).join('');
}

// Provably fair state
let pfState = {
  clientSeed: '',
  serverSeed: '',
  serverSeedHash: '',
  nonce: 0
};

async function initProvablyFair() {
  const saved = localStorage.getItem('spunkbet_pf');
  if (saved) {
    try { pfState = JSON.parse(saved); } catch(e) {}
  }
  if (!pfState.clientSeed) {
    pfState.clientSeed = generateRandomHex(16);
  }
  if (!pfState.serverSeed) {
    await rotateServerSeed();
  }
  savePFState();
  updatePFDisplay();
}

async function rotateServerSeed() {
  pfState.serverSeed = generateRandomHex(32);
  pfState.serverSeedHash = await sha256(pfState.serverSeed);
}

function savePFState() {
  localStorage.setItem('spunkbet_pf', JSON.stringify(pfState));
}

async function rotateClientSeed() {
  pfState.clientSeed = generateRandomHex(16);
  pfState.nonce = 0;
  await rotateServerSeed();
  savePFState();
  updatePFDisplay();
  showToast('Client seed rotated. Server seed reset.');
}

function updatePFDisplay() {
  const cs = document.getElementById('my-client-seed');
  const sh = document.getElementById('my-server-hash');
  const nc = document.getElementById('my-nonce');
  if (cs) cs.value = pfState.clientSeed;
  if (sh) sh.value = pfState.serverSeedHash;
  if (nc) nc.value = pfState.nonce;
}

// Get a provably fair random number between 0 and 1
async function fairRandom() {
  const hash = await hmacSha256(pfState.serverSeed, pfState.clientSeed + ':' + pfState.nonce);
  pfState.nonce++;
  // Use first 8 hex chars = 4 bytes = 32 bits
  const num = parseInt(hash.substring(0, 8), 16);
  return num / 0x100000000; // 0 to 0.999...
}

// Show seed info on a game's seed display element
async function showGameSeed(elementId, serverSeed, serverSeedHash) {
  const el = document.getElementById(elementId);
  if (!el) return;
  el.innerHTML = 'Seed hash: ' + serverSeedHash.substring(0, 16) + '... | Server seed: ' + serverSeed.substring(0, 8) + '... <span style="color:var(--accent)">(click to copy full data)</span>';
  el.dataset.fullSeed = JSON.stringify({ serverSeed, serverSeedHash, clientSeed: pfState.clientSeed, nonce: pfState.nonce - 1 });
}

function copySeed(elementId) {
  const el = document.getElementById(elementId);
  if (!el || !el.dataset.fullSeed) return;
  navigator.clipboard.writeText(el.dataset.fullSeed).then(() => {
    showToast('Seed data copied! Paste into Provably Fair verifier.');
  });
}

async function verifyBet() {
  const server = document.getElementById('verify-server').value.trim();
  const hash = document.getElementById('verify-hash').value.trim();
  const client = document.getElementById('verify-client').value.trim();
  const nonce = document.getElementById('verify-nonce').value.trim();
  const resultEl = document.getElementById('verify-result');

  if (!server || !hash) {
    resultEl.className = 'verify-result fail';
    resultEl.textContent = 'Please enter server seed and hash.';
    return;
  }

  const computedHash = await sha256(server);
  if (computedHash === hash) {
    let extra = '';
    if (client) {
      const hmac = await hmacSha256(server, client + ':' + nonce);
      const num = parseInt(hmac.substring(0, 8), 16) / 0x100000000;
      extra = ' | Outcome value: ' + num.toFixed(8) + ' (HMAC: ' + hmac.substring(0, 16) + '...)';
    }
    resultEl.className = 'verify-result pass';
    resultEl.textContent = 'VERIFIED: Server seed matches the committed hash.' + extra;
  } else {
    resultEl.className = 'verify-result fail';
    resultEl.textContent = 'FAILED: Hash mismatch. Expected ' + computedHash.substring(0, 16) + '... but got ' + hash.substring(0, 16) + '...';
  }
}

// ===== STATE =====
let balance = 0;
let history = [];
let cfSide = 'heads';

// ===== REFERRAL TIER CONFIG =====
const TIERS = [
  { name: 'Starter', min: 0, reward: 7777, css: 'starter' },
  { name: 'Bronze', min: 3, reward: 7777, css: 'bronze' },
  { name: 'Silver', min: 5, reward: 10000, css: 'silver' },
  { name: 'Gold', min: 10, reward: 15000, css: 'gold' },
  { name: 'VIP', min: 25, reward: 25000, css: 'vip' },
];

function getTier(count) {
  let tier = TIERS[0];
  for (const t of TIERS) {
    if (count >= t.min) tier = t;
  }
  return tier;
}

function getTierReward(referrerCount) {
  const totalReferrers = getTotalReferrerCount();
  const tier = getTier(referrerCount);
  const isFirst100 = totalReferrers <= 100;
  return isFirst100 ? tier.reward * 2 : tier.reward;
}

function getTotalReferrerCount() {
  let ledger = {};
  try { ledger = JSON.parse(localStorage.getItem('spunkbet_referral_ledger') || '{}'); } catch(e) {}
  return Object.keys(ledger).length;
}

// ===== FAUCET =====
function canClaimFaucet() {
  const lastClaim = localStorage.getItem('spunkbet_faucet_time');
  if (!lastClaim) return true;
  const elapsed = Date.now() - parseInt(lastClaim);
  return elapsed > 24 * 60 * 60 * 1000; // 24 hours
}

function updateFaucetButton() {
  const btn = document.getElementById('faucet-btn');
  if (!btn) return;
  if (canClaimFaucet()) {
    btn.disabled = false;
    const amount = getFaucetAmount();
    btn.textContent = 'Claim ' + amount.toLocaleString() + ' SPUNK\u2022BET';
  } else {
    btn.disabled = true;
    const lastClaim = parseInt(localStorage.getItem('spunkbet_faucet_time'));
    const nextClaim = lastClaim + 24 * 60 * 60 * 1000;
    const remaining = nextClaim - Date.now();
    const hours = Math.floor(remaining / (60 * 60 * 1000));
    const mins = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
    btn.textContent = 'Claim again in ' + hours + 'h ' + mins + 'm';
  }
}

function getFaucetAmount() {
  return walletState.connected ? 10000 : 2000;
}

function claimFaucet() {
  if (!canClaimFaucet()) {
    const lastClaim = parseInt(localStorage.getItem('spunkbet_faucet_time'));
    const nextClaim = lastClaim + 24 * 60 * 60 * 1000;
    const remaining = nextClaim - Date.now();
    const hours = Math.floor(remaining / (60 * 60 * 1000));
    const mins = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
    showToast('Faucet resets in <span class="toast-amount">' + hours + 'h ' + mins + 'm</span>. Come back soon!');
    return;
  }
  if (typeof trackEvent === 'function') trackEvent('faucet_claim');
  const amount = getFaucetAmount();
  balance += amount;
  localStorage.setItem('spunkbet_faucet_time', Date.now().toString());
  updateBalance();
  saveState();
  updateFaucetButton();
  if (walletState.connected) {
    showToast('Claimed <span class="toast-amount">' + amount.toLocaleString() + ' SPUNK\u2022BET</span>! Go play some games.');
    claimFaucetOnChain();
  } else {
    showToast('Claimed <span class="toast-amount">' + amount.toLocaleString() + ' SPUNK\u2022BET</span>! Connect wallet for 5x more tokens.');
  }
}

// ===== LOCALSTORAGE PERSISTENCE =====
function saveState() {
  localStorage.setItem('spunkbet_balance', balance.toString());
  localStorage.setItem('spunkbet_history', JSON.stringify(history));
  if (walletState.connected) {
    localStorage.setItem('spunkbet_wallet', JSON.stringify(walletState));
  }
}

function loadState() {
  const savedBalance = localStorage.getItem('spunkbet_balance');
  if (savedBalance !== null) balance = parseInt(savedBalance) || 0;

  const savedHistory = localStorage.getItem('spunkbet_history');
  if (savedHistory) {
    try { history = JSON.parse(savedHistory); } catch(e) { history = []; }
  }

  const savedWallet = localStorage.getItem('spunkbet_wallet');
  if (savedWallet) {
    try {
      const w = JSON.parse(savedWallet);
      if (w.connected) {
        walletState = w;
        updateWalletButton();
        updateShareButton();
      }
    } catch(e) {}
  }

  // Auto-gift tokens to new visitors so they can play instantly
  if (!localStorage.getItem('spunkbet_welcomed')) {
    localStorage.setItem('spunkbet_welcomed', '1');
    balance += 2000;
    saveState();
    setTimeout(() => {
      showToast('Welcome! <span class="toast-amount">2,000 SPUNK\u2022BET</span> free to play. Connect wallet for 5x more!');
    }, 500);
  }

  updateBalance();
  renderHistory();
  updateFirst100();
  renderLeaderboard();
  updateFaucetButton();
  updateFaucetDisplay();
}

function updateFaucetDisplay() {
  const desc = document.getElementById('faucet-desc');
  if (!desc) return;
  if (walletState.connected) {
    desc.textContent = 'Get 10,000 free SPUNK\u2022BET tokens every 24 hours. Wallet connected \u2014 you get the full amount!';
  } else {
    desc.textContent = 'Get 2,000 free tokens to play, or connect your wallet for 10,000! Claim every 24 hours.';
  }
}

// ===== REFERRAL CAPTURE =====
function captureReferral() {
  const params = new URLSearchParams(window.location.search);
  const ref = params.get('ref');
  if (ref && ref.length >= 6) {
    if (!localStorage.getItem('spunkbet_referrer')) {
      localStorage.setItem('spunkbet_referrer', ref);
    }
  }
}

// ===== REFERRAL TRACKING =====
function processReferralOnConnect(address) {
  const claimKey = 'spunkbet_claimed_' + address;
  if (localStorage.getItem(claimKey)) return;

  const referrer = localStorage.getItem('spunkbet_referrer');
  const selfRef = address.slice(0, 8);
  const isReferred = referrer && referrer !== selfRef;

  localStorage.setItem(claimKey, Date.now().toString());

  if (isReferred) {
    trackReferral(referrer, address);
    showToast('Welcome! You were referred by <span class="toast-amount">' + referrer + '</span>. Share your own link to earn SPUNK\u2022BET!');
    // Send on-chain referral reward to the referrer
    claimReferralOnChain(address);
  } else {
    showToast('Welcome to <span class="toast-amount">Spunk.bet</span>! Share your referral link to earn SPUNK\u2022BET.');
  }

  updateFirst100();
  renderLeaderboard();
  saveState();
}

function trackReferral(referrerCode, newAddress) {
  let ledger = {};
  try { ledger = JSON.parse(localStorage.getItem('spunkbet_referral_ledger') || '{}'); } catch(e) {}
  if (!ledger[referrerCode]) ledger[referrerCode] = [];
  if (ledger[referrerCode].some(e => e.address === newAddress)) return;
  ledger[referrerCode].push({ address: newAddress, time: Date.now() });
  localStorage.setItem('spunkbet_referral_ledger', JSON.stringify(ledger));
}

function getReferralCount() {
  if (!walletState.connected) return 0;
  const code = walletState.paymentAddress.slice(0, 8);
  let ledger = {};
  try { ledger = JSON.parse(localStorage.getItem('spunkbet_referral_ledger') || '{}'); } catch(e) {}
  return (ledger[code] || []).length;
}

function getReferralEarnings() {
  const count = getReferralCount();
  if (count === 0) return 0;
  let total = 0;
  const tier = getTier(count);
  total = tier.reward * count;
  const totalReferrers = getTotalReferrerCount();
  if (totalReferrers <= 100) total *= 2;
  return total;
}

// ===== FIRST 100 REFERRERS =====
function updateFirst100() {
  const total = getTotalReferrerCount();
  const remaining = Math.max(0, 100 - total);
  const el = document.getElementById('first100-count');
  if (el) el.textContent = remaining;
  const banner = document.getElementById('first100-banner');
  if (banner) banner.style.display = remaining > 0 ? '' : 'none';
}

// ===== LEADERBOARD =====
function renderLeaderboard() {
  // Combine real local referrals with community data
  let ledger = {};
  try { ledger = JSON.parse(localStorage.getItem('spunkbet_referral_ledger') || '{}'); } catch(e) {}

  const localEntries = Object.entries(ledger)
    .map(([code, refs]) => ({ code, count: refs.length, isLocal: true }));

  // Generate consistent community referrers (seeded by day so they persist)
  const dayNum = Math.floor(Date.now() / 86400000);
  function seededRand(seed) { let x = Math.sin(seed) * 10000; return x - Math.floor(x); }
  const communityNames = ['bc1q7x', 'bc1qm4', 'bc1pf9', 'bc1qr2', 'bc1pk8', 'bc1q5a', 'bc1pd3', 'bc1qw7', 'bc1pe6', 'bc1qt1', 'bc1q3v', 'bc1px9'];
  const communityEntries = communityNames.map((name, i) => ({
    code: name,
    count: Math.max(1, Math.floor(seededRand(dayNum + i * 137) * 18) + (i < 3 ? 8 : i < 6 ? 4 : 1)),
    isLocal: false
  }));

  // Merge: local entries override community entries, sort by count
  const allEntries = [...localEntries, ...communityEntries]
    .sort((a, b) => b.count - a.count)
    .slice(0, 10);

  const listEl = document.getElementById('leaderboard-list');
  if (!listEl) return;

  listEl.innerHTML = allEntries.map((e, i) => {
    const rankClass = i < 3 ? 'r' + (i + 1) : 'r4';
    const tier = getTier(e.count);
    const youBadge = e.isLocal ? ' <span style="color:var(--accent);font-size:0.7rem;">(You)</span>' : '';
    return '<div class="leaderboard-entry">' +
      '<div class="leaderboard-rank ' + rankClass + '">' + (i + 1) + '</div>' +
      '<div class="leaderboard-addr">' + e.code + '...' + youBadge + '</div>' +
      '<span class="tier-badge ' + tier.css + '">' + tier.name + '</span>' +
      '<div class="leaderboard-count">' + e.count + ' refs</div>' +
    '</div>';
  }).join('');

  // Render live stats below leaderboard
  const statsEl = document.getElementById('leaderboard-stats');
  if (statsEl) {
    const s = cumulativeStats || {};
    const live = window.liveStats;
    const hour = new Date().getHours();
    const curve = [3,2,2,1,1,1,2,3,5,7,9,11,13,14,15,16,18,20,22,21,18,14,10,6];

    if (live && live.today) {
      // Real Cloudflare Worker stats
      statsEl.innerHTML =
        '<div class="stat-grid">' +
          '<div class="stat-item"><div class="stat-val" style="color:var(--green)">' + (live.today.unique_visitors || 0) + '</div><div class="stat-label">Visitors Today</div></div>' +
          '<div class="stat-item"><div class="stat-val">' + (live.week.unique_visitors || 0) + '</div><div class="stat-label">This Week</div></div>' +
          '<div class="stat-item"><div class="stat-val" style="color:var(--accent)">' + (live.today.games_played || 0).toLocaleString() + '</div><div class="stat-label">Games Today</div></div>' +
          '<div class="stat-item"><div class="stat-val">' + (live.all_time.total_games || 0).toLocaleString() + '</div><div class="stat-label">All-Time Games</div></div>' +
          '<div class="stat-item"><div class="stat-val">' + (live.today.wager_volume || 0).toLocaleString() + '</div><div class="stat-label">Wagered Today</div></div>' +
          '<div class="stat-item"><div class="stat-val">' + (live.all_time.total_wagered || 0).toLocaleString() + '</div><div class="stat-label">All-Time Wagered</div></div>' +
          '<div class="stat-item"><div class="stat-val" style="color:var(--green)">' + (live.today.faucet_claims || 0) + '</div><div class="stat-label">Faucets Today</div></div>' +
          '<div class="stat-item"><div class="stat-val">' + (live.all_time.total_wallet_connects || 0) + '</div><div class="stat-label">Wallets Connected</div></div>' +
        '</div>' +
        '<div style="text-align:center;margin-top:0.5rem;font-size:0.65rem;color:var(--green);font-weight:600;">LIVE DATA</div>';
    } else {
      // Local-only fallback
      const online = curve[hour] + Math.floor(Math.random() * 4);
      statsEl.innerHTML =
        '<div class="stat-grid">' +
          '<div class="stat-item"><div class="stat-val" style="color:var(--green)">' + online + '</div><div class="stat-label">Playing Now</div></div>' +
          '<div class="stat-item"><div class="stat-val">' + (s.games_played || 0).toLocaleString() + '</div><div class="stat-label">Your Bets</div></div>' +
          '<div class="stat-item"><div class="stat-val">' + (s.total_wagered || 0).toLocaleString() + '</div><div class="stat-label">Total Wagered</div></div>' +
          '<div class="stat-item"><div class="stat-val" style="color:var(--accent)">' + (s.biggest_win || 0).toLocaleString() + '</div><div class="stat-label">Biggest Win</div></div>' +
        '</div>';
    }
  }

  renderTierCards('leaderboard-tiers', localEntries.length > 0 ? Math.max(...localEntries.map(e => e.count)) : -1);

  // Also render rank-related sections
  renderPlayerRankCard();
  renderWagerLeaderboard();
  renderRankTiers();
}

function renderTierCards(containerId, activeCount) {
  const el = document.getElementById(containerId);
  if (!el) return;
  el.innerHTML = TIERS.slice(1).map(t => {
    const isActive = activeCount >= t.min;
    const colorVar = t.css === 'gold' ? 'gold' : t.css === 'vip' ? 'purple' : t.css === 'silver' ? 'muted' : t.css === 'bronze' ? 'yellow' : 'muted';
    return '<div class="tier-card ' + (isActive ? 'active' : '') + '">' +
      '<div class="tier-name" style="color:var(--' + colorVar + ')">' + t.name + '</div>' +
      '<div class="tier-req">' + t.min + '+ refs</div>' +
      '<div class="tier-reward">+' + t.reward + '/ref</div>' +
    '</div>';
  }).join('');
}

// ===== TOAST =====
function showToast(html) {
  const toast = document.getElementById('welcome-toast');
  toast.innerHTML = html;
  setTimeout(() => toast.classList.add('show'), 50);
  setTimeout(() => toast.classList.remove('show'), 4500);
}

// ===== MOBILE MENU =====
function toggleMobileMenu() {
  const menu = document.getElementById('mobile-menu');
  const btn = document.getElementById('hamburger-btn');
  menu.classList.toggle('show');
  btn.classList.toggle('open');
}

// ===== NAVIGATION =====
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  if (id === 'home') document.querySelectorAll('.nav-tab')[0].classList.add('active');
  if (id === 'leaderboard-page') document.querySelectorAll('.nav-tab')[1].classList.add('active');
  if (id === 'history-page') document.querySelectorAll('.nav-tab')[2].classList.add('active');
  if (id === 'wallets-page') document.querySelectorAll('.nav-tab')[3].classList.add('active');
  if (id === 'fair-page') document.querySelectorAll('.nav-tab')[4].classList.add('active');
  if (id === 'leaderboard-page') renderLeaderboard();
  if (id === 'wallets-page') { renderPrizes('wallet-prize-grid'); scanPrizeWallet(); }
  if (id === 'fair-page') updatePFDisplay();
  window.scrollTo(0, 0);
  if (typeof trackPageView === 'function') trackPageView(id);
}

function openGame(id) {
  showPage(id);
  if (typeof trackGamePlay === 'function') trackGamePlay(id);
  if (id === 'dice') updateDiceSlider();
  if (id === 'mines') initMinesGrid();
  if (id === 'limbo') updateLimboDisplay();
  if (id === 'keno') { initKenoGrid(); renderKenoPayoutTable(); }
  if (id === 'wheel') { drawWheel(); }
  if (id === 'plinko') { drawPlinkoBoard(plinkoRows); }
  if (id === 'tower') initTowerGrid();
}

// ===== BALANCE =====
function updateBalance() {
  document.getElementById('balance-display').textContent = balance.toLocaleString();
}

const MIN_BET = 100;

function getBet(id) {
  const v = parseInt(document.getElementById(id).value) || 0;
  if (v < MIN_BET) {
    showToast('Minimum bet is <span class="toast-amount">' + MIN_BET + ' SPUNK•BET</span>');
    return 0;
  }
  return Math.min(v, balance);
}

function setBet(id, action) {
  const el = document.getElementById(id);
  let v = parseInt(el.value) || 100;
  if (action === 'half') v = Math.max(MIN_BET, Math.floor(v / 2));
  if (action === 'double') v = Math.min(balance, v * 2);
  if (action === 'max') v = balance;
  el.value = v;
}

function addHistory(game, bet, result, amount, seedData) {
  history.unshift({ game, bet, result, amount, time: new Date(), seed: seedData || null });
  if (history.length > 50) history.pop();

  const multiNum = bet > 0 ? (amount + bet) / bet : 0;
  if (result === 'win') {
    const multi = bet > 0 ? multiNum.toFixed(2) + 'x' : '';
    lastWin = { game, amount: Math.abs(amount), multi };
    // Win streak tracking
    winStreak++;
    localStorage.setItem('spunkbet_streak', winStreak.toString());
    updateStreakBadge();
    checkStreakMilestone();
    // Big win detection: 10x+ multiplier OR 50k+ profit
    if (multiNum >= 10 || amount >= 50000) {
      showBigWinOverlay(amount, multi, game);
    }
  } else {
    winStreak = 0;
    localStorage.setItem('spunkbet_streak', '0');
    updateStreakBadge();
  }
  // Update cumulative stats
  updateCumulativeStats(game, bet, result, amount, multiNum);
  // Track on Cloudflare Worker
  if (typeof trackGamePlay === 'function') trackGamePlay(game, bet, result);
  // Update live ticker
  updateLiveTicker(game, bet, result, amount);
  renderHistory();
  renderCommunityHistory();
  saveState();
}

function renderHistory() {
  const el = document.getElementById('history-full-list');
  if (history.length === 0) {
    el.innerHTML = '<div style="color:var(--muted);text-align:center;padding:2rem;">No bets yet.</div>';
    return;
  }
  el.innerHTML = history.map(h => {
    const isWin = h.result === 'win';
    const seedBtn = h.seed ? ' <span style="color:var(--accent);cursor:pointer;font-size:0.7rem;" data-seed="' + encodeURIComponent(JSON.stringify(h.seed)) + '" onclick="navigator.clipboard.writeText(decodeURIComponent(this.dataset.seed))">[copy seed]</span>' : '';
    return '<div class="history-item">' +
      '<span class="history-game">' + h.game + seedBtn + '</span>' +
      '<span>' + h.bet + ' SPUNK•BET</span>' +
      '<span class="history-result ' + h.result + '">' + (isWin ? '+' : '-') + Math.abs(h.amount).toLocaleString() + ' SPUNK•BET</span>' +
    '</div>';
  }).join('');
}

function switchHistoryTab(tab, tabEl) {
  document.querySelectorAll('#history-page .mode-tab').forEach(t => t.classList.remove('active'));
  tabEl.classList.add('active');
  document.getElementById('history-all-list').style.display = tab === 'all' ? '' : 'none';
  document.getElementById('history-full-list').style.display = tab === 'mine' ? '' : 'none';
}

// Simulated community bet feed
const COMMUNITY_GAMES = ['Keno','Limbo','Dice','Coin Flip','Plinko','Mines','Wheel','HiLo','Crash','Rune Tower'];
const COMMUNITY_NAMES = ['Player_','Anon_','Degen_','Whale_','Lucky_','Rune_','BTC_','Sat_','Punk_','Spunky_'];
let communityBets = [];

function generateCommunityBet() {
  const game = COMMUNITY_GAMES[Math.floor(Math.random() * COMMUNITY_GAMES.length)];
  const prefix = COMMUNITY_NAMES[Math.floor(Math.random() * COMMUNITY_NAMES.length)];
  const player = prefix + Math.floor(Math.random() * 9999).toString().padStart(4, '0');
  const betAmounts = [100, 200, 500, 1000, 2500, 5000, 10000, 25000, 50000];
  const bet = betAmounts[Math.floor(Math.random() * betAmounts.length)];
  const isWin = Math.random() < 0.45;
  const multi = isWin ? (1 + Math.random() * 9).toFixed(2) : 0;
  const amount = isWin ? Math.floor(bet * multi) - bet : -bet;
  return { player, game, bet, result: isWin ? 'win' : 'lose', amount, time: new Date() };
}

function renderCommunityHistory() {
  const el = document.getElementById('history-all-list');
  if (!el) return;
  // Mix real player bets with community bets
  const allBets = [
    ...history.map(h => ({ ...h, player: 'You' })),
    ...communityBets
  ].sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, 50);

  if (allBets.length === 0) {
    el.innerHTML = '<div style="color:var(--muted);text-align:center;padding:2rem;">No bets yet.</div>';
    return;
  }
  el.innerHTML = allBets.map(h => {
    const isWin = h.result === 'win';
    const playerStyle = h.player === 'You' ? 'color:var(--accent);font-weight:700;' : 'color:var(--muted);';
    return '<div class="history-item">' +
      '<span style="' + playerStyle + 'font-size:0.75rem;min-width:80px;">' + h.player + '</span>' +
      '<span class="history-game">' + h.game + '</span>' +
      '<span>' + h.bet.toLocaleString() + '</span>' +
      '<span class="history-result ' + h.result + '">' + (isWin ? '+' : '-') + Math.abs(h.amount).toLocaleString() + '</span>' +
    '</div>';
  }).join('');
}

// Generate initial community bets and keep adding
for (let i = 0; i < 20; i++) {
  const b = generateCommunityBet();
  b.time = new Date(Date.now() - Math.random() * 300000);
  communityBets.push(b);
}
setInterval(() => {
  communityBets.push(generateCommunityBet());
  if (communityBets.length > 40) communityBets.shift();
  renderCommunityHistory();
}, 4000 + Math.random() * 6000);

let lastWin = { game: '', amount: 0, multi: '' };

function showResult(id, win, msg) {
  const el = document.getElementById(id);
  el.className = 'result ' + (win ? 'win' : 'lose');
  if (win) {
    el.innerHTML = msg + ' <button class="share-x-btn" onclick="shareWinOnX()"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>Share Win</button>';
  } else {
    el.textContent = msg;
  }
}

function generateWinCard(options) {
  const o = options || {};
  const game = o.game || lastWin.game || 'SPUNK•BET';
  const amount = o.amount != null ? o.amount : lastWin.amount;
  const multi = o.multi || lastWin.multi || '';
  const refCode = walletState.connected ? walletState.paymentAddress.slice(0, 8) : '';
  const refLink = refCode ? 'spunk.bet?ref=' + refCode : 'spunk.bet';
  const isReferral = o.referralOnly;

  const c = document.createElement('canvas');
  c.width = 1200; c.height = 628;
  const ctx = c.getContext('2d');

  // Background
  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0, 0, 1200, 628);

  // Subtle grid pattern
  ctx.strokeStyle = 'rgba(255,255,255,0.02)';
  ctx.lineWidth = 1;
  for (let i = 0; i < 1200; i += 40) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, 628); ctx.stroke(); }
  for (let i = 0; i < 628; i += 40) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(1200, i); ctx.stroke(); }

  // Top accent bar
  const grad = ctx.createLinearGradient(0, 0, 1200, 0);
  grad.addColorStop(0, '#ff5f1f');
  grad.addColorStop(1, '#ff8c00');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, 1200, 5);

  // Logo
  ctx.font = 'bold 38px -apple-system, system-ui, sans-serif';
  ctx.fillStyle = '#fff';
  ctx.fillText('spunk', 60, 70);
  ctx.fillStyle = '#ff5f1f';
  ctx.fillText('.bet', 60 + ctx.measureText('spunk').width, 70);

  if (isReferral) {
    // Referral card
    ctx.font = 'bold 48px -apple-system, system-ui, sans-serif';
    ctx.fillStyle = '#fff';
    ctx.fillText('Free Crypto Casino', 60, 200);

    ctx.font = '600 32px -apple-system, system-ui, sans-serif';
    ctx.fillStyle = '#a1a1aa';
    ctx.fillText('No KYC \u00B7 Provably Fair \u00B7 Bitcoin', 60, 250);

    ctx.font = 'bold 64px -apple-system, system-ui, sans-serif';
    ctx.fillStyle = '#ff5f1f';
    ctx.fillText('10,000 FREE', 60, 360);
    ctx.font = 'bold 40px -apple-system, system-ui, sans-serif';
    ctx.fillStyle = '#ff5f1f';
    ctx.fillText('SPUNK\u2022BET TOKENS', 60, 410);

    ctx.font = 'bold 28px -apple-system, system-ui, sans-serif';
    ctx.fillStyle = '#fff';
    ctx.fillText('Fast. Fair. Free.', 60, 460);
    ctx.font = '500 20px -apple-system, system-ui, sans-serif';
    ctx.fillStyle = '#71717a';
    ctx.fillText('Free daily runes \u00B7 Ordinal prizes \u00B7 Free wheel spin every day', 60, 495);
  } else {
    // Win card - game tag
    ctx.font = '700 20px -apple-system, system-ui, sans-serif';
    ctx.fillStyle = '#71717a';
    ctx.fillText(game.toUpperCase(), 60, 150);

    // Win amount
    ctx.font = 'bold 96px -apple-system, system-ui, sans-serif';
    ctx.fillStyle = '#22c55e';
    const amtText = '+' + amount.toLocaleString();
    ctx.fillText(amtText, 60, 280);

    // SPUNK•BET label
    ctx.font = 'bold 36px -apple-system, system-ui, sans-serif';
    ctx.fillStyle = '#ff5f1f';
    ctx.fillText('SPUNK\u2022BET', 60, 330);

    // Multiplier badge
    if (multi) {
      ctx.textAlign = 'right';
      // Badge background
      const mw = ctx.measureText(multi).width + 40;
      const mx = 1140 - mw;
      ctx.fillStyle = 'rgba(255,95,31,0.15)';
      roundRect(ctx, mx, 220, mw, 70, 12);
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,95,31,0.3)';
      ctx.lineWidth = 2;
      roundRect(ctx, mx, 220, mw, 70, 12);
      ctx.stroke();
      ctx.font = 'bold 44px -apple-system, system-ui, sans-serif';
      ctx.fillStyle = '#ff5f1f';
      ctx.fillText(multi, 1140, 270);
      ctx.textAlign = 'left';
    }

    // Fast Fair Free tag
    ctx.font = 'bold 22px -apple-system, system-ui, sans-serif';
    ctx.fillStyle = '#ff5f1f';
    ctx.fillText('Fast. Fair. Free.', 60, 400);
    ctx.font = '500 18px -apple-system, system-ui, sans-serif';
    ctx.fillStyle = '#71717a';
    ctx.fillText('Free daily runes \u00B7 Real ordinal prizes \u00B7 Free daily wheel spin', 60, 430);
  }

  // Bottom bar with referral
  ctx.fillStyle = '#111';
  ctx.fillRect(0, 540, 1200, 88);
  ctx.fillStyle = 'rgba(255,95,31,0.08)';
  ctx.fillRect(0, 540, 1200, 88);

  ctx.font = 'bold 26px -apple-system, system-ui, sans-serif';
  ctx.fillStyle = '#fff';
  ctx.fillText(refLink, 60, 592);

  ctx.textAlign = 'right';
  ctx.font = '600 22px -apple-system, system-ui, sans-serif';
  ctx.fillStyle = '#ff5f1f';
  ctx.fillText('Claim free runes & play \u2192', 1140, 592);
  ctx.textAlign = 'left';

  return c;
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

// Rotating viral tweet templates — Fast. Fair. Free. + CTA + @SpunkArt13
const TWEET_TEMPLATES = [
  (g, amt, multi, link) => '+' + amt + ' SPUNK\u2022BET on ' + g + '! \uD83C\uDFB0\n\nFast. Fair. Free. Claim 10k tokens & play now \u2192 ' + link + '\n\n@SpunkArt13',
  (g, amt, multi, link) => 'Just hit ' + multi + ' on ' + g + '! +' + amt + ' SPUNK\u2022BET \uD83D\uDD25\n\nFree casino on Bitcoin. No KYC. Real ordinal prizes \u2192 ' + link + '\n\n@SpunkArt13',
  (g, amt, multi, link) => multi + ' multiplier on ' + g + '! +' + amt + ' SPUNK\u2022BET \uD83D\uDCB0\n\nFree daily runes + ordinal giveaways. Come play \u2192 ' + link + '\n\n@SpunkArt13',
  (g, amt, multi, link) => 'Won ' + amt + ' SPUNK\u2022BET on ' + g + '! \uD83C\uDF89\n\nFast. Fair. Free. A casino for everyone on Bitcoin \u2192 ' + link + '\n\n@SpunkArt13',
  (g, amt, multi, link) => '+' + amt + ' on ' + g + '! ' + multi + ' \uD83D\uDE80\n\nFree tokens daily, win real ordinals. Support @SpunkArt13 \u2192 ' + link,
  (g, amt, multi, link) => 'This casino gives you free runes daily + ordinal prizes \uD83E\uDD2F\n\nJust won ' + amt + ' SPUNK\u2022BET on ' + g + ' \u2192 ' + link + '\n\n@SpunkArt13',
];
function getViralTweet(game, amount, multi, link) {
  const idx = Math.floor(Math.random() * TWEET_TEMPLATES.length);
  return TWEET_TEMPLATES[idx](game, amount, multi, link);
}

// Auto-download win card image so user can attach to tweet
function downloadWinCard() {
  try {
    const canvas = generateWinCard();
    canvas.toBlob(function(blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'spunkbet-win.png';
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    }, 'image/png');
  } catch(e) {}
}

function shareWinOnX() {
  const refCode = walletState.connected ? walletState.paymentAddress.slice(0, 8) : '';
  const link = refCode ? 'https://spunk.bet?ref=' + refCode : 'https://spunk.bet';
  const text = getViralTweet(lastWin.game, lastWin.amount.toLocaleString(), lastWin.multi, link);
  // Try Web Share API first (auto-attaches image on mobile/desktop)
  try {
    const canvas = generateWinCard();
    canvas.toBlob(function(blob) {
      const file = new File([blob], 'spunkbet-win.png', { type: 'image/png' });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({ text: text, files: [file] }).catch(() => {
          // Fallback to X intent
          window.open('https://x.com/intent/tweet?text=' + encodeURIComponent(text), '_blank');
        });
      } else {
        // Copy image to clipboard if possible, then open X
        if (navigator.clipboard && navigator.clipboard.write) {
          navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]).then(() => {
            showToast('Win card copied to clipboard! Paste it in your tweet.');
          }).catch(() => {});
        } else {
          downloadWinCard();
          showToast('Win card saved! Attach it to your tweet.');
        }
        window.open('https://x.com/intent/tweet?text=' + encodeURIComponent(text), '_blank');
      }
    }, 'image/png');
  } catch(e) {
    downloadWinCard();
    window.open('https://x.com/intent/tweet?text=' + encodeURIComponent(text), '_blank');
    showToast('Win card saved! Attach it to your tweet.');
  }
  shareBonus();
}

// ===== COIN FLIP =====
function pickSide(side) {
  cfSide = side;
  document.getElementById('cf-heads').classList.toggle('selected', side === 'heads');
  document.getElementById('cf-tails').classList.toggle('selected', side === 'tails');
}

let coinFlipping = false;
async function flipCoin() {
  if (coinFlipping) return;
  const bet = getBet('cf-bet');
  if (bet <= 0 || bet > balance) return;
  coinFlipping = true;
  balance -= bet;
  updateBalance();

  // Capture current seed for this bet
  const seedBefore = { serverSeedHash: pfState.serverSeedHash, clientSeed: pfState.clientSeed, nonce: pfState.nonce };

  const coin = document.getElementById('cf-coin');
  coin.className = 'coin flipping';
  coin.textContent = '?';

  const rand = await fairRandom();
  const seedAfter = { ...seedBefore, serverSeed: pfState.serverSeed };

  // Rotate server seed for next game
  await rotateServerSeed();
  savePFState();

  const cfDelay = isTurbo('coinflip') ? 30 : 400;
  if (isTurbo('coinflip')) { coin.className = 'coin'; }
  setTimeout(() => {
    const result = rand < 0.5 ? 'heads' : 'tails';
    const win = result === cfSide;
    coin.className = 'coin ' + result;
    coin.textContent = result === 'heads' ? 'H' : 'T';

    showGameSeed('cf-seed', seedAfter.serverSeed, seedAfter.serverSeedHash);

    if (win) {
      const payout = Math.floor(bet * 1.98);
      balance += payout;
      showResult('cf-result', true, result.toUpperCase() + '! You won +' + (payout - bet).toLocaleString() + ' SPUNK•BET');
      addHistory('Coin Flip', bet, 'win', payout - bet, seedAfter);
    } else {
      showResult('cf-result', false, result.toUpperCase() + '. You lost ' + bet.toLocaleString() + ' SPUNK•BET');
      addHistory('Coin Flip', bet, 'lose', -bet, seedAfter);
    }
    updateBalance();
    saveState();
    coinFlipping = false;
  }, cfDelay);
}

// ===== DICE =====
let diceMode = 'under';

function setDiceMode(mode) {
  diceMode = mode;
  document.getElementById('dice-under-btn').classList.toggle('active', mode === 'under');
  document.getElementById('dice-over-btn').classList.toggle('active', mode === 'over');
  document.getElementById('dice-mode-label').textContent = mode;
  updateDiceSlider();
}

function syncDiceTarget() {
  const input = document.getElementById('dice-target-input');
  let val = parseInt(input.value);
  if (isNaN(val)) return;
  val = Math.min(95, Math.max(5, val));
  document.getElementById('dice-slider').value = val;
  updateDiceSlider();
}
function updateDiceSlider() {
  const slider = document.getElementById('dice-slider');
  const val = parseInt(slider.value);
  slider.style.setProperty('--val', val + '%');
  document.getElementById('dice-target-val').textContent = val;
  const input = document.getElementById('dice-target-input');
  if (input && document.activeElement !== input) input.value = val;
  let chance, payout;
  if (diceMode === 'under') {
    chance = val - 1;
    slider.style.background = 'linear-gradient(to right, var(--green) 0%, var(--green) ' + val + '%, var(--red) ' + val + '%, var(--red) 100%)';
  } else {
    chance = 100 - val;
    slider.style.background = 'linear-gradient(to right, var(--red) 0%, var(--red) ' + val + '%, var(--green) ' + val + '%, var(--green) 100%)';
  }
  document.getElementById('dice-chance').textContent = chance + '%';
  payout = chance > 0 ? (98 / chance).toFixed(2) : '0.00';
  document.getElementById('dice-payout').textContent = payout + 'x';
  const badge = document.getElementById('dice-payout-badge');
  if (badge) badge.textContent = payout + 'x';
}

let diceRolling = false;
async function rollDice() {
  if (diceRolling) return;
  const bet = getBet('dice-bet');
  if (bet > balance || bet <= 0) return;
  const target = parseInt(document.getElementById('dice-slider').value);
  const chance = diceMode === 'under' ? target - 1 : 100 - target;
  if (chance <= 0) { showToast('Adjust target — 0% win chance!'); return; }
  diceRolling = true;
  balance -= bet;
  updateBalance();

  const seedBefore = { serverSeedHash: pfState.serverSeedHash, clientSeed: pfState.clientSeed, nonce: pfState.nonce };
  const rand = await fairRandom();
  const seedAfter = { ...seedBefore, serverSeed: pfState.serverSeed };
  await rotateServerSeed();
  savePFState();

  const die = document.getElementById('dice-die');
  if (!isTurbo('dice')) { die.className = 'die rolling'; }
  die.textContent = '?';

  setTimeout(() => {
    const roll = Math.floor(rand * 100) + 1;
    const win = diceMode === 'under' ? roll < target : roll > target;
    die.className = 'die ' + (win ? 'hit' : 'miss');
    die.textContent = roll;
    const chance = diceMode === 'under' ? (target - 1) : (100 - target);
    const multi = chance > 0 ? (98 / chance) : 0;
    const modeLabel = diceMode === 'under' ? 'under' : 'over';

    showGameSeed('dice-seed', seedAfter.serverSeed, seedAfter.serverSeedHash);

    if (win) {
      const payout = Math.floor(bet * multi);
      balance += payout;
      showResult('dice-result', true, 'Rolled ' + roll + ' (' + modeLabel + ' ' + target + '). Won +' + (payout - bet).toLocaleString() + ' SPUNK•BET');
      addHistory('Dice', bet, 'win', payout - bet, seedAfter);
    } else {
      showResult('dice-result', false, 'Rolled ' + roll + ' (needed ' + modeLabel + ' ' + target + '). Lost ' + bet.toLocaleString() + ' SPUNK•BET');
      addHistory('Dice', bet, 'lose', -bet, seedAfter);
    }
    updateBalance();
    saveState();
    diceRolling = false;
  }, isTurbo('dice') ? 30 : 300);
}

// ===== MINES =====
let minesState = null;

function changeMines(d) {
  const el = document.getElementById('mines-count');
  let v = parseInt(el.value) + d;
  v = Math.min(24, Math.max(1, v));
  el.value = v;
}
function syncMinesCount() {
  const el = document.getElementById('mines-count');
  let v = parseInt(el.value);
  if (isNaN(v)) return;
  v = Math.min(24, Math.max(1, v));
  if (document.activeElement !== el) el.value = v;
}

function initMinesGrid() {
  const grid = document.getElementById('mines-grid');
  grid.innerHTML = '';
  for (let i = 0; i < 25; i++) {
    const cell = document.createElement('div');
    cell.className = 'mine-cell';
    cell.textContent = '';
    cell.dataset.index = i;
    grid.appendChild(cell);
  }
  document.getElementById('mines-revealed').textContent = '0';
  document.getElementById('mines-multi').textContent = '1.00x';
  document.getElementById('mines-profit').textContent = '+0';
  document.getElementById('mines-result').className = 'result';
  document.getElementById('mines-start-btn').style.display = '';
  document.getElementById('mines-cashout-btn').style.display = 'none';
  minesState = null;
}

function getMinesMulti(revealed, mineCount) {
  let multi = 1;
  for (let i = 0; i < revealed; i++) {
    multi *= (25 - mineCount - i) > 0 ? (25 - i) / (25 - mineCount - i) : 1;
  }
  return multi * 0.98;
}

let minesStarting = false;
async function startMines() {
  if (minesStarting || (minesState && minesState.active)) return;
  const bet = getBet('mines-bet');
  if (bet > balance || bet <= 0) return;
  minesStarting = true;
  const mineCount = parseInt(document.getElementById('mines-count').value);
  balance -= bet;
  updateBalance();
  saveState();
  initMinesGrid();

  const seedBefore = { serverSeedHash: pfState.serverSeedHash, clientSeed: pfState.clientSeed, nonce: pfState.nonce };

  // Generate mine positions using provably fair randomness
  const positions = [];
  const available = Array.from({length: 25}, (_, i) => i);
  for (let i = 0; i < mineCount; i++) {
    const rand = await fairRandom();
    const idx = Math.floor(rand * available.length);
    positions.push(available[idx]);
    available.splice(idx, 1);
  }

  const seedAfter = { ...seedBefore, serverSeed: pfState.serverSeed };
  await rotateServerSeed();
  savePFState();

  minesState = { bet, mineCount, mines: positions, revealed: 0, active: true, seedData: seedAfter };
  minesStarting = false;
  document.getElementById('mines-start-btn').style.display = 'none';
  document.getElementById('mines-cashout-btn').style.display = '';
  showGameSeed('mines-seed', seedAfter.serverSeed, seedAfter.serverSeedHash);

  document.querySelectorAll('.mine-cell').forEach(cell => {
    cell.onclick = () => revealMine(parseInt(cell.dataset.index));
  });
}

function revealMine(index) {
  if (!minesState || !minesState.active) return;
  const cell = document.querySelectorAll('.mine-cell')[index];
  if (cell.classList.contains('revealed')) return;
  if (minesState.mines.includes(index)) {
    cell.classList.add('revealed', 'bomb');
    cell.textContent = '\u{1F4A5}';
    minesState.active = false;
    minesState.mines.forEach(m => {
      const c = document.querySelectorAll('.mine-cell')[m];
      if (!c.classList.contains('revealed')) { c.classList.add('revealed', 'shown'); c.textContent = '\u{1F4A3}'; }
    });
    showResult('mines-result', false, 'BOOM! Lost ' + minesState.bet.toLocaleString() + ' SPUNK•BET');
    addHistory('Mines', minesState.bet, 'lose', -minesState.bet, minesState.seedData);
    document.getElementById('mines-cashout-btn').style.display = 'none';
    document.getElementById('mines-start-btn').style.display = '';
  } else {
    cell.classList.add('revealed', 'safe');
    cell.textContent = '\u{1F48E}';
    minesState.revealed++;
    const multi = getMinesMulti(minesState.revealed, minesState.mineCount);
    const profit = Math.floor(minesState.bet * multi) - minesState.bet;
    document.getElementById('mines-revealed').textContent = minesState.revealed;
    document.getElementById('mines-multi').textContent = multi.toFixed(2) + 'x';
    document.getElementById('mines-profit').textContent = '+' + profit.toLocaleString();
    if (minesState.revealed >= 25 - minesState.mineCount) cashoutMines();
  }
}

function cashoutMines() {
  if (!minesState || !minesState.active) return;
  minesState.active = false;
  const multi = getMinesMulti(minesState.revealed, minesState.mineCount);
  const payout = Math.floor(minesState.bet * multi);
  balance += payout;
  updateBalance();
  const profit = payout - minesState.bet;
  showResult('mines-result', true, 'Cashed out at ' + multi.toFixed(2) + 'x! Won +' + profit.toLocaleString() + ' SPUNK•BET');
  addHistory('Mines', minesState.bet, 'win', profit, minesState.seedData);
  minesState.mines.forEach(m => {
    const c = document.querySelectorAll('.mine-cell')[m];
    c.classList.add('revealed', 'shown'); c.textContent = '\u{1F4A3}';
  });
  document.getElementById('mines-cashout-btn').style.display = 'none';
  document.getElementById('mines-start-btn').style.display = '';
  saveState();
}

// ===== CRASH =====
let crashState = null;

let crashStarting = false;
async function startCrash() {
  if (crashStarting || (crashState && crashState.active)) return;
  const bet = getBet('crash-bet');
  if (bet > balance || bet <= 0) return;
  crashStarting = true;
  balance -= bet;
  updateBalance();
  saveState();

  const seedBefore = { serverSeedHash: pfState.serverSeedHash, clientSeed: pfState.clientSeed, nonce: pfState.nonce };
  const rand = await fairRandom();
  const seedAfter = { ...seedBefore, serverSeed: pfState.serverSeed };
  await rotateServerSeed();
  savePFState();

  const crashAt = Math.max(1, (0.97 / (1 - rand)));
  crashState = { bet, crashAt, multi: 1.00, active: true, cashed: false, startTime: Date.now(), seedData: seedAfter };
  crashStarting = false;
  document.getElementById('crash-start-btn').style.display = 'none';
  document.getElementById('crash-cashout-btn').style.display = '';
  document.getElementById('crash-result').className = 'result';
  document.getElementById('crash-multi').className = 'crash-multi live';
  document.getElementById('crash-status').textContent = 'Rising...';
  showGameSeed('crash-seed', seedAfter.serverSeed, seedAfter.serverSeedHash);

  const canvas = document.getElementById('crash-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth * 2;
  canvas.height = canvas.offsetHeight * 2;
  ctx.scale(2, 2);
  animateCrash(ctx, canvas);
}

function animateCrash(ctx, canvas) {
  if (!crashState) return;
  const w = canvas.width / 2, h = canvas.height / 2;
  const elapsed = (Date.now() - crashState.startTime) / 1000;
  const multi = Math.pow(Math.E, elapsed * 0.5);
  crashState.multi = Math.round(multi * 100) / 100;
  document.getElementById('crash-multi').textContent = crashState.multi.toFixed(2) + 'x';
  ctx.clearRect(0, 0, w, h);
  ctx.strokeStyle = crashState.cashed ? '#ff5f1f' : '#22c55e';
  ctx.lineWidth = 2;
  ctx.beginPath();
  const points = 100;
  for (let i = 0; i <= points; i++) {
    const t = (elapsed * i) / points;
    const m = Math.pow(Math.E, t * 0.5);
    const x = (i / points) * w;
    const maxM = Math.max(crashState.multi, 2);
    const y = h - ((m - 1) / (maxM - 1)) * (h - 20);
    if (i === 0) ctx.moveTo(x, Math.min(y, h));
    else ctx.lineTo(x, Math.min(y, h));
  }
  ctx.stroke();
  if (crashState.multi >= crashState.crashAt && !crashState.cashed) {
    crashState.active = false;
    document.getElementById('crash-multi').className = 'crash-multi crashed';
    document.getElementById('crash-multi').textContent = crashState.crashAt.toFixed(2) + 'x';
    document.getElementById('crash-status').textContent = 'Crashed!';
    document.getElementById('crash-cashout-btn').style.display = 'none';
    document.getElementById('crash-start-btn').style.display = '';
    showResult('crash-result', false, 'Crashed at ' + crashState.crashAt.toFixed(2) + 'x. Lost ' + crashState.bet.toLocaleString() + ' SPUNK•BET');
    addHistory('Crash', crashState.bet, 'lose', -crashState.bet, crashState.seedData);
    return;
  }
  if (crashState.cashed) return;
  requestAnimationFrame(() => animateCrash(ctx, canvas));
}

function cashoutCrash() {
  if (!crashState || !crashState.active) return;
  crashState.active = false;
  crashState.cashed = true;
  const payout = Math.floor(crashState.bet * crashState.multi);
  balance += payout;
  updateBalance();
  const profit = payout - crashState.bet;
  document.getElementById('crash-multi').className = 'crash-multi cashed';
  document.getElementById('crash-status').textContent = 'Cashed out at ' + crashState.multi.toFixed(2) + 'x';
  document.getElementById('crash-cashout-btn').style.display = 'none';
  document.getElementById('crash-start-btn').style.display = '';
  showResult('crash-result', true, 'Cashed at ' + crashState.multi.toFixed(2) + 'x! Won +' + profit.toLocaleString() + ' SPUNK•BET');
  addHistory('Crash', crashState.bet, 'win', profit, crashState.seedData);
  saveState();
}

// ===== LIMBO =====
function setLimboTarget(v) {
  document.getElementById('limbo-target').value = v;
  updateLimboDisplay();
}
function updateLimboDisplay() {
  const target = parseFloat(document.getElementById('limbo-target').value) || 2;
  document.getElementById('limbo-target-display').textContent = target.toFixed(2) + 'x';
  const chance = Math.min(98, (98 / target));
  document.getElementById('limbo-chance').textContent = chance.toFixed(1) + '%';
}
let limboPlaying = false;
async function playLimbo() {
  if (limboPlaying) return;
  const bet = getBet('limbo-bet');
  if (bet <= 0 || bet > balance) return;
  limboPlaying = true;
  const target = parseFloat(document.getElementById('limbo-target').value) || 2;
  if (target < 1.01) { showToast('Target must be at least 1.01x'); limboPlaying = false; return; }
  balance -= bet;
  updateBalance();

  const seedBefore = { serverSeedHash: pfState.serverSeedHash, clientSeed: pfState.clientSeed, nonce: pfState.nonce };
  const rand = await fairRandom();
  const seedAfter = { ...seedBefore, serverSeed: pfState.serverSeed };
  await rotateServerSeed(); savePFState();

  const result = Math.max(1, (0.98 / (1 - rand)));
  const display = document.getElementById('limbo-display');
  if (!isTurbo('limbo')) { display.className = 'limbo-display spinning'; display.textContent = '...'; }

  setTimeout(() => {
    const win = result >= target;
    display.className = 'limbo-display ' + (win ? 'win' : 'lose');
    display.textContent = result.toFixed(2) + 'x';
    addLimboHistory(result, target);
    showGameSeed('limbo-seed', seedAfter.serverSeed, seedAfter.serverSeedHash);
    if (win) {
      const payout = Math.floor(bet * target);
      balance += payout;
      showResult('limbo-result', true, 'Result: ' + result.toFixed(2) + 'x (target ' + target.toFixed(2) + 'x). Won +' + (payout - bet).toLocaleString() + ' SPUNK\u2022BET');
      addHistory('Limbo', bet, 'win', payout - bet, seedAfter);
    } else {
      showResult('limbo-result', false, 'Result: ' + result.toFixed(2) + 'x (needed ' + target.toFixed(2) + 'x). Lost ' + bet.toLocaleString() + ' SPUNK\u2022BET');
      addHistory('Limbo', bet, 'lose', -bet, seedAfter);
    }
    updateBalance(); saveState();
    limboPlaying = false;
  }, isTurbo('limbo') ? 30 : 250);
}

// ===== KENO =====
let kenoSelected = new Set();
function initKenoGrid() {
  kenoSelected.clear();
  const grid = document.getElementById('keno-grid');
  grid.innerHTML = '';
  const drawnArea = document.getElementById('keno-drawn-area');
  if (drawnArea) drawnArea.innerHTML = '';
  for (let i = 1; i <= 40; i++) {
    const cell = document.createElement('div');
    cell.className = 'keno-cell';
    cell.textContent = i;
    cell.onclick = () => toggleKenoCell(i, cell);
    grid.appendChild(cell);
  }
  document.getElementById('keno-selected-count').textContent = '0';
  document.getElementById('keno-result').className = 'result';
}
function toggleKenoCell(num, cell) {
  if (cell.classList.contains('drawn')) return;
  if (kenoSelected.has(num)) {
    kenoSelected.delete(num);
    cell.classList.remove('selected');
  } else {
    if (kenoSelected.size >= 10) { showToast('Maximum 10 picks'); return; }
    kenoSelected.add(num);
    cell.classList.add('selected');
  }
  document.getElementById('keno-selected-count').textContent = kenoSelected.size;
  document.getElementById('keno-hits-needed').textContent = Math.max(1, Math.ceil(kenoSelected.size * 0.3));
  renderKenoPayoutTable();
}
function kenoAutoSelect(count) {
  initKenoGrid();
  const nums = [];
  while (nums.length < count) {
    const n = Math.floor(Math.random() * 40) + 1;
    if (!nums.includes(n)) nums.push(n);
  }
  const cells = document.querySelectorAll('.keno-cell');
  nums.forEach(n => {
    kenoSelected.add(n);
    cells[n - 1].classList.add('selected');
  });
  document.getElementById('keno-selected-count').textContent = kenoSelected.size;
  document.getElementById('keno-hits-needed').textContent = Math.max(1, Math.ceil(count * 0.3));
  document.querySelectorAll('.keno-pick-btn').forEach(b => {
    b.classList.remove('active');
    if (parseInt(b.textContent) === count) b.classList.add('active');
  });
  renderKenoPayoutTable();
}
let kenoRisk = 'low';
const KENO_TABLES = {
  low: {
    1: [0, 3.6], 2: [0, 1.5, 5.1], 3: [0, 0, 2.2, 20],
    4: [0, 0, 1.5, 5, 50], 5: [0, 0, 0, 2, 10, 100],
    6: [0, 0, 0, 1.5, 4, 20, 200], 7: [0, 0, 0, 1, 2.5, 8, 50, 400],
    8: [0, 0, 0, 0, 2, 5, 20, 100, 500], 9: [0, 0, 0, 0, 1.5, 3, 10, 50, 200, 800],
    10: [0, 0, 0, 0, 1, 2, 5, 20, 80, 300, 1000]
  },
  medium: {
    1: [0, 5], 2: [0, 2, 9], 3: [0, 0, 3.5, 40],
    4: [0, 0, 2, 9, 100], 5: [0, 0, 0, 3, 18, 200],
    6: [0, 0, 0, 2, 7, 40, 400], 7: [0, 0, 0, 1.5, 4, 15, 100, 700],
    8: [0, 0, 0, 0, 3, 9, 40, 200, 1000], 9: [0, 0, 0, 0, 2, 5, 18, 100, 400, 1500],
    10: [0, 0, 0, 0, 1.5, 3, 9, 40, 150, 600, 2000]
  },
  high: {
    1: [0, 8], 2: [0, 0, 17], 3: [0, 0, 0, 80],
    4: [0, 0, 0, 5, 250], 5: [0, 0, 0, 0, 20, 500],
    6: [0, 0, 0, 0, 5, 50, 1000], 7: [0, 0, 0, 0, 3, 20, 200, 1500],
    8: [0, 0, 0, 0, 0, 10, 50, 500, 2500], 9: [0, 0, 0, 0, 0, 5, 25, 200, 800, 4000],
    10: [0, 0, 0, 0, 0, 3, 10, 50, 300, 1000, 5000]
  }
};
function setKenoRisk(risk) {
  kenoRisk = risk;
  ['low','medium','high'].forEach(r => {
    document.getElementById('keno-risk-' + (r === 'medium' ? 'med' : r)).classList.toggle('active', r === risk);
  });
  renderKenoPayoutTable();
}
function getKenoMultiplier(picks, hits) {
  const table = KENO_TABLES[kenoRisk];
  return (table[picks] && table[picks][hits]) || 0;
}
function renderKenoPayoutTable() {
  const container = document.getElementById('keno-payout-line');
  if (!container) return;
  const picks = kenoSelected.size || 5;
  const table = KENO_TABLES[kenoRisk];
  const multis = table[picks] || table[5];
  let html = '';
  for (let i = 0; i <= picks; i++) {
    const m = multis[i] || 0;
    const cls = m >= 50 ? 'big' : m > 0 ? 'win' : 'zero';
    html += '<div class="keno-payout-slot ' + cls + '"><span class="slot-hits">' + i + '/' + picks + '</span><span class="slot-multi">' + (m > 0 ? m + 'x' : '-') + '</span></div>';
  }
  container.innerHTML = html;
}
async function playKeno() {
  if (kenoSelected.size === 0) { showToast('Pick at least 1 number'); return; }
  const bet = getBet('keno-bet');
  if (bet <= 0 || bet > balance) return;
  balance -= bet;
  updateBalance();

  const seedBefore = { serverSeedHash: pfState.serverSeedHash, clientSeed: pfState.clientSeed, nonce: pfState.nonce };
  const drawn = [];
  const avail = Array.from({length: 40}, (_, i) => i + 1);
  for (let i = 0; i < 10; i++) {
    const rand = await fairRandom();
    const idx = Math.floor(rand * avail.length);
    drawn.push(avail[idx]);
    avail.splice(idx, 1);
  }
  const seedAfter = { ...seedBefore, serverSeed: pfState.serverSeed };
  await rotateServerSeed(); savePFState();

  const cells = document.querySelectorAll('.keno-cell');
  const drawnSet = new Set(drawn);
  let hits = 0;
  cells.forEach((cell, i) => {
    const num = i + 1;
    if (drawnSet.has(num)) {
      cell.classList.add('drawn');
      if (kenoSelected.has(num)) {
        cell.classList.add('hit');
        if (!cell.classList.contains('selected')) cell.classList.add('selected');
        cell.textContent = '\u2713';
        hits++;
      } else {
        cell.classList.add('miss');
      }
    } else if (kenoSelected.has(num)) {
      cell.classList.add('drawn', 'selected', 'miss');
    }
  });

  const multi = getKenoMultiplier(kenoSelected.size, hits);
  showGameSeed('keno-seed', seedAfter.serverSeed, seedAfter.serverSeedHash);
  if (multi > 0) {
    const payout = Math.floor(bet * multi);
    balance += payout;
    showResult('keno-result', true, hits + ' hits! ' + multi + 'x payout. Won +' + (payout - bet).toLocaleString() + ' SPUNK\u2022BET');
    addHistory('Keno', bet, 'win', payout - bet, seedAfter);
  } else {
    showResult('keno-result', false, hits + ' hits. Not enough to win. Lost ' + bet.toLocaleString() + ' SPUNK\u2022BET');
    addHistory('Keno', bet, 'lose', -bet, seedAfter);
  }
  updateBalance(); saveState();
}

// ===== WHEEL =====
let wheelRisk = 'low';
let wheelSpinning = false;
const WHEEL_SEGMENTS = {
  low:    [1.5, 1.2, 1.2, 1.5, 0, 1.2, 1.5, 1.2, 3, 1.2, 1.5, 1.2, 0, 1.2, 1.5, 1.2, 2, 1.2, 1.5, 1.2],
  medium: [2, 0, 1.5, 0, 3, 0, 1.5, 0, 2, 0, 5, 0, 1.5, 0, 2, 0, 1.5, 0, 10, 0],
  high:   [0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 5, 0, 0, 0, 0, 50, 0, 0, 0, 0]
};
const WHEEL_COLORS = {
  0: '#2d2d3d', 1.2: '#3b82f6', 1.5: '#6366f1', 2: '#8b5cf6',
  3: '#a855f7', 5: '#ec4899', 10: '#f59e0b', 50: '#22c55e'
};
function setWheelRisk(risk) {
  wheelRisk = risk;
  ['low','medium','high'].forEach(r => {
    document.getElementById('wheel-risk-' + (r === 'medium' ? 'med' : r)).classList.toggle('active', r === risk);
  });
  drawWheel();
}
function drawWheel(rotation) {
  const canvas = document.getElementById('wheel-canvas');
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const cx = w/2, cy = h/2, r = w/2 - 16;
  ctx.clearRect(0, 0, w, h);
  const segs = WHEEL_SEGMENTS[wheelRisk];
  const angle = (2 * Math.PI) / segs.length;
  const rot = rotation || 0;

  // Outer ring
  ctx.beginPath();
  ctx.arc(cx, cy, r + 8, 0, 2 * Math.PI);
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 3;
  ctx.stroke();

  // Draw segments
  segs.forEach((val, i) => {
    const start = i * angle + rot - Math.PI/2;
    const end = start + angle;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, start, end);
    ctx.closePath();
    ctx.fillStyle = WHEEL_COLORS[val] || '#1a1a1a';
    ctx.fill();
    // Segment border
    ctx.strokeStyle = '#0d0d0d';
    ctx.lineWidth = 2;
    ctx.stroke();
  });

  // Inner shadow ring
  const grad = ctx.createRadialGradient(cx, cy, r * 0.85, cx, cy, r);
  grad.addColorStop(0, 'transparent');
  grad.addColorStop(1, 'rgba(0,0,0,0.3)');
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, 2 * Math.PI);
  ctx.fillStyle = grad;
  ctx.fill();

  // Labels
  segs.forEach((val, i) => {
    const start = i * angle + rot - Math.PI/2;
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(start + angle / 2);
    ctx.fillStyle = '#fff';
    ctx.font = 'bold ' + (val >= 10 ? '15' : '13') + 'px -apple-system, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.shadowColor = 'rgba(0,0,0,0.5)';
    ctx.shadowBlur = 3;
    ctx.fillText(val > 0 ? val + 'x' : '0x', r * 0.72, 0);
    ctx.restore();
  });

  // Center hub
  ctx.beginPath();
  ctx.arc(cx, cy, 32, 0, 2 * Math.PI);
  const hubGrad = ctx.createRadialGradient(cx, cy - 5, 0, cx, cy, 32);
  hubGrad.addColorStop(0, '#222');
  hubGrad.addColorStop(1, '#111');
  ctx.fillStyle = hubGrad;
  ctx.fill();
  ctx.strokeStyle = '#444';
  ctx.lineWidth = 2;
  ctx.stroke();
}
async function spinWheel() {
  if (wheelSpinning) return;
  const bet = getBet('wheel-bet');
  if (bet <= 0 || bet > balance) return;
  balance -= bet; updateBalance();
  wheelSpinning = true;
  document.getElementById('wheel-spin-btn').disabled = true;

  const seedBefore = { serverSeedHash: pfState.serverSeedHash, clientSeed: pfState.clientSeed, nonce: pfState.nonce };
  const rand = await fairRandom();
  const seedAfter = { ...seedBefore, serverSeed: pfState.serverSeed };
  await rotateServerSeed(); savePFState();

  const segs = WHEEL_SEGMENTS[wheelRisk];
  const winIndex = Math.floor(rand * segs.length);
  const segAngle = (2 * Math.PI) / segs.length;
  const targetAngle = -(winIndex * segAngle + segAngle / 2);
  const spins = Math.round(3 + Math.random() * 2);
  const totalRotation = spins * 2 * Math.PI + targetAngle;
  const duration = 2800;
  const startTime = Date.now();

  function animateSpin() {
    const elapsed = Date.now() - startTime;
    const progress = Math.min(1, elapsed / duration);
    const ease = 1 - Math.pow(1 - progress, 3);
    const currentRotation = ease * totalRotation;
    drawWheel(currentRotation);
    if (progress < 1) {
      requestAnimationFrame(animateSpin);
    } else {
      const val = segs[winIndex];
      document.getElementById('wheel-center').textContent = val > 0 ? val + 'x' : '0';
      showGameSeed('wheel-seed', seedAfter.serverSeed, seedAfter.serverSeedHash);
      if (val > 0) {
        const payout = Math.floor(bet * val);
        balance += payout;
        document.getElementById('wheel-result-text').style.color = 'var(--green)';
        document.getElementById('wheel-result-text').textContent = val + 'x! +' + (payout - bet).toLocaleString();
        showResult('wheel-result', true, 'Landed on ' + val + 'x! Won +' + (payout - bet).toLocaleString() + ' SPUNK\u2022BET');
        addHistory('Wheel', bet, 'win', payout - bet, seedAfter);
      } else {
        document.getElementById('wheel-result-text').style.color = 'var(--red)';
        document.getElementById('wheel-result-text').textContent = '0x - Bust!';
        showResult('wheel-result', false, 'Landed on 0. Lost ' + bet.toLocaleString() + ' SPUNK\u2022BET');
        addHistory('Wheel', bet, 'lose', -bet, seedAfter);
      }
      updateBalance(); saveState();
      wheelSpinning = false;
      document.getElementById('wheel-spin-btn').disabled = false;
    }
  }
  requestAnimationFrame(animateSpin);
}

// ===== PLINKO =====
let plinkoRisk = 'low';
let plinkoRows = 12;
let plinkoDropping = false;
let plinkoBalls = []; // active balls: { path, step, finalSlot, bet, multi, seedAfter, done }
let plinkoAnimRunning = false;
const PLINKO_MULTIS = {
  low: {
    8:[5.6,2.1,1.1,1,0.5,1,1.1,2.1,5.6],
    9:[5.6,2,1.6,1,0.7,0.7,1,1.6,2,5.6],
    10:[8.9,3,1.4,1.1,1,0.5,1,1.1,1.4,3,8.9],
    11:[8.4,3,1.9,1.3,1,0.7,0.7,1,1.3,1.9,3,8.4],
    12:[10,3,1.6,1.4,1.1,1,0.5,1,1.1,1.4,1.6,3,10],
    13:[8.1,4,3,1.9,1.2,0.9,0.7,0.7,0.9,1.2,1.9,3,4,8.1],
    14:[7.1,4,1.9,1.4,1.3,1.1,1,0.5,1,1.1,1.3,1.4,1.9,4,7.1],
    15:[15,8,3,2,1.5,1.1,1,0.7,0.7,1,1.1,1.5,2,3,8,15],
    16:[16,9,2,1.4,1.4,1.2,1.1,1,0.5,1,1.1,1.2,1.4,1.4,2,9,16]
  },
  medium: {
    8:[13,3,1.3,0.7,0.4,0.7,1.3,3,13],
    9:[18,4,1.7,0.9,0.5,0.5,0.9,1.7,4,18],
    10:[22,5,2,1.4,0.6,0.4,0.6,1.4,2,5,22],
    11:[24,6,3,1.8,0.7,0.5,0.5,0.7,1.8,3,6,24],
    12:[33,11,4,2,1.1,0.6,0.3,0.6,1.1,2,4,11,33],
    13:[43,13,6,3,1.3,0.7,0.4,0.4,0.7,1.3,3,6,13,43],
    14:[58,15,7,4,1.9,1,0.5,0.2,0.5,1,1.9,4,7,15,58],
    15:[88,18,11,5,3,1.3,0.5,0.3,0.3,0.5,1.3,3,5,11,18,88],
    16:[110,41,10,5,3,1.5,1,0.5,0.3,0.5,1,1.5,3,5,10,41,110]
  },
  high: {
    8:[29,4,1.5,0.3,0.2,0.3,1.5,4,29],
    9:[43,7,2,0.6,0.2,0.2,0.6,2,7,43],
    10:[76,10,3,0.9,0.3,0.2,0.3,0.9,3,10,76],
    11:[120,14,5.2,1.4,0.4,0.2,0.2,0.4,1.4,5.2,14,120],
    12:[170,24,8.1,2,0.7,0.2,0.2,0.2,0.7,2,8.1,24,170],
    13:[284,37,11,4,1,0.2,0.2,0.2,0.2,1,4,11,37,284],
    14:[420,56,18,5,1.9,0.3,0.2,0.2,0.2,0.3,1.9,5,18,56,420],
    15:[620,83,27,8,3,0.5,0.2,0.2,0.2,0.2,0.5,3,8,27,83,620],
    16:[1000,130,26,9,4,2,0.2,0.2,0.2,0.2,0.2,2,4,9,26,130,1000]
  }
};
function setPlinkoRisk(risk) {
  plinkoRisk = risk;
  ['low','medium','high'].forEach(r => {
    document.getElementById('plinko-risk-' + (r === 'medium' ? 'med' : r)).classList.toggle('active', r === risk);
  });
}
function changePlinkoRows(d) {
  plinkoRows = Math.min(16, Math.max(8, plinkoRows + d));
  document.getElementById('plinko-rows').value = plinkoRows;
  drawPlinkoBoard(plinkoRows);
}
function syncPlinkoRows() {
  const el = document.getElementById('plinko-rows');
  let v = parseInt(el.value);
  if (isNaN(v)) return;
  v = Math.min(16, Math.max(8, v));
  plinkoRows = v;
  if (document.activeElement !== el) el.value = v;
  drawPlinkoBoard(plinkoRows);
}
function drawPlinkoBoard(rows) {
  const canvas = document.getElementById('plinko-canvas');
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);
  // Dark background with subtle gradient
  const bgGrad = ctx.createLinearGradient(0, 0, 0, h);
  bgGrad.addColorStop(0, '#0a0a0f');
  bgGrad.addColorStop(1, '#0d0d12');
  ctx.fillStyle = bgGrad;
  ctx.fillRect(0, 0, w, h);
  const padTop = 30, padBot = 60;
  const rowH = (h - padTop - padBot) / (rows + 1);
  const spacing = (w * 0.78) / (rows + 2);
  // Collect active ball positions for peg glow
  const ballPositions = [];
  plinkoBalls.forEach(ball => {
    const visPath = ball.path.slice(0, Math.min(ball.step + 1, ball.path.length));
    if (visPath.length > 0) ballPositions.push(visPath[visPath.length - 1]);
  });
  // Draw pegs with glow effect
  for (let r = 0; r < rows; r++) {
    const pegsInRow = r + 3;
    const rowWidth = spacing * pegsInRow;
    const startX = (w - rowWidth) / 2 + spacing / 2;
    for (let p = 0; p < pegsInRow; p++) {
      const x = startX + p * spacing;
      const y = padTop + (r + 1) * rowH;
      // Check if any ball is near this peg
      let glowing = false;
      for (const bp of ballPositions) {
        const dx = bp.x - x, dy = bp.y - y;
        if (dx * dx + dy * dy < spacing * spacing * 0.3) { glowing = true; break; }
      }
      if (glowing) {
        ctx.beginPath();
        ctx.arc(x, y, 8, 0, 2 * Math.PI);
        ctx.fillStyle = 'rgba(255,95,31,0.15)';
        ctx.fill();
      }
      ctx.beginPath();
      ctx.arc(x, y, rows > 12 ? 3 : 4, 0, 2 * Math.PI);
      ctx.fillStyle = glowing ? '#ff8c42' : '#3a3a4a';
      ctx.fill();
    }
  }
  // Draw multiplier buckets
  const multis = PLINKO_MULTIS[plinkoRisk][rows] || PLINKO_MULTIS[plinkoRisk][12];
  const slotCount = multis.length;
  const slotW = (w * 0.88) / slotCount;
  const slotStartX = (w - slotW * slotCount) / 2;
  const slotY = h - padBot + 4;
  const mid = Math.floor(slotCount / 2);
  const hitSlots = new Set();
  plinkoBalls.forEach(b => { if (b.done) hitSlots.add(b.finalSlot); });
  multis.forEach((m, i) => {
    const x = slotStartX + i * slotW;
    const isHit = hitSlots.has(i);
    const dist = Math.abs(i - mid) / mid;
    // Color gradient: edges=red, mid=yellow, center=green (like winna/stake)
    let r, g, b;
    if (dist > 0.7) { r = 255; g = 60; b = 30; }
    else if (dist > 0.4) { r = 234; g = 179; b = 8; }
    else { r = 34; g = 197; b = 94; }
    const alpha = isHit ? 0.65 : 0.2;
    ctx.fillStyle = `rgba(${r},${g},${b},${alpha})`;
    ctx.beginPath();
    ctx.roundRect(x + 1, slotY, slotW - 2, 34, 5);
    ctx.fill();
    if (isHit) {
      ctx.shadowColor = `rgba(${r},${g},${b},0.6)`;
      ctx.shadowBlur = 12;
      ctx.strokeStyle = `rgb(${r},${g},${b})`;
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.shadowBlur = 0;
    }
    ctx.fillStyle = isHit ? '#fff' : `rgb(${r},${g},${b})`;
    ctx.font = 'bold ' + (slotCount > 14 ? '8' : slotCount > 11 ? '10' : '12') + 'px -apple-system, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(m + 'x', x + slotW / 2, slotY + 22);
  });
  // Draw all active balls with trail
  plinkoBalls.forEach(ball => {
    const visPath = ball.path.slice(0, Math.min(ball.step + 1, ball.path.length));
    // Trail glow (last 5 positions)
    const trailStart = Math.max(0, visPath.length - 6);
    for (let i = trailStart; i < visPath.length - 1; i++) {
      const alpha = 0.05 + ((i - trailStart) / 6) * 0.25;
      ctx.beginPath();
      ctx.arc(visPath[i].x, visPath[i].y, 5, 0, 2 * Math.PI);
      ctx.fillStyle = `rgba(255,140,66,${alpha})`;
      ctx.fill();
    }
    // Main ball with glow
    if (visPath.length > 0) {
      const pos = visPath[visPath.length - 1];
      ctx.shadowColor = 'rgba(255,95,31,0.5)';
      ctx.shadowBlur = 10;
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, 8, 0, 2 * Math.PI);
      const ballGrad = ctx.createRadialGradient(pos.x - 2, pos.y - 2, 1, pos.x, pos.y, 8);
      ballGrad.addColorStop(0, '#ffb347');
      ballGrad.addColorStop(1, '#ff5f1f');
      ctx.fillStyle = ballGrad;
      ctx.fill();
      ctx.shadowBlur = 0;
    }
  });
}
function startPlinkoAnimLoop() {
  if (plinkoAnimRunning) return;
  plinkoAnimRunning = true;
  const rows = plinkoRows;
  let lastStep = 0;
  function tick(ts) {
    if (plinkoBalls.length === 0) { plinkoAnimRunning = false; return; }
    const turbo = isTurbo('plinko');
    const stepDelay = turbo ? 18 : 40;
    if (ts - lastStep >= stepDelay) {
      lastStep = ts;
      plinkoBalls.forEach(ball => {
        if (!ball.done) {
          ball.step++;
          if (ball.step >= ball.path.length) {
            ball.done = true;
            const multi = ball.multi;
            showGameSeed('plinko-seed', ball.seedAfter.serverSeed, ball.seedAfter.serverSeedHash);
            const payout = Math.floor(ball.bet * multi);
            balance += payout;
            if (multi >= 1) {
              document.getElementById('plinko-result-text').style.color = 'var(--green)';
              document.getElementById('plinko-result-text').textContent = multi + 'x! +' + (payout - ball.bet).toLocaleString();
              showResult('plinko-result', true, multi + 'x! Won +' + (payout - ball.bet).toLocaleString() + ' SPUNK\u2022BET');
              addHistory('Plinko', ball.bet, 'win', payout - ball.bet, ball.seedAfter);
            } else {
              document.getElementById('plinko-result-text').style.color = 'var(--red)';
              document.getElementById('plinko-result-text').textContent = multi + 'x \u2212' + (ball.bet - payout).toLocaleString();
              showResult('plinko-result', false, multi + 'x. Lost ' + (ball.bet - payout).toLocaleString() + ' SPUNK\u2022BET');
              addHistory('Plinko', ball.bet, 'lose', -(ball.bet - payout), ball.seedAfter);
            }
            updateBalance(); saveState();
            setTimeout(() => {
              plinkoBalls = plinkoBalls.filter(b => b !== ball);
              if (plinkoBalls.length === 0) drawPlinkoBoard(rows);
            }, 250);
          }
        }
      });
    }
    drawPlinkoBoard(rows);
    if (plinkoBalls.some(b => !b.done) || plinkoBalls.length > 0) {
      requestAnimationFrame(tick);
    } else {
      plinkoAnimRunning = false;
    }
  }
  requestAnimationFrame(tick);
}
async function dropPlinko() {
  const bet = getBet('plinko-bet');
  if (bet <= 0 || bet > balance) return;
  balance -= bet; updateBalance();

  const rows = plinkoRows;
  const seedBefore = { serverSeedHash: pfState.serverSeedHash, clientSeed: pfState.clientSeed, nonce: pfState.nonce };
  const directions = [];
  for (let i = 0; i < rows; i++) {
    const r = await fairRandom();
    directions.push(r < 0.5 ? 0 : 1);
  }
  const seedAfter = { ...seedBefore, serverSeed: pfState.serverSeed };
  await rotateServerSeed(); savePFState();

  const canvas = document.getElementById('plinko-canvas');
  const w = canvas.width, h = canvas.height;
  const padTop = 40, padBot = 70;
  const rowH = (h - padTop - padBot) / (rows + 1);
  const spacing = (w * 0.75) / (rows + 2);
  let slot = 0;
  const path = [{ x: w / 2, y: 15 }];
  for (let r = 0; r < rows; r++) {
    if (directions[r] === 1) slot++;
    const pegsInRow = r + 3;
    const rowWidth = spacing * pegsInRow;
    const startX = (w - rowWidth) / 2 + spacing / 2;
    path.push({ x: startX + slot * spacing, y: padTop + (r + 1) * rowH + 8 });
  }
  const multis = PLINKO_MULTIS[plinkoRisk][rows] || PLINKO_MULTIS[plinkoRisk][12];
  const slotCount = multis.length;
  const slotW = (w * 0.88) / slotCount;
  const slotStartX = (w - slotW * slotCount) / 2;
  const finalSlot = Math.min(slot, slotCount - 1);
  path.push({ x: slotStartX + finalSlot * slotW + slotW / 2, y: h - padBot + 24 });

  plinkoBalls.push({ path, step: 0, finalSlot, bet, multi: multis[finalSlot], seedAfter, done: false });
  startPlinkoAnimLoop();
}

// ===== HILO =====
let hiloState = null;
const CARD_RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const CARD_SUITS = ['\u2665','\u2666','\u2663','\u2660'];
function cardValue(rank) { return CARD_RANKS.indexOf(rank) + 1; }
function renderCard(elId, rank, suit, extraClass) {
  const el = document.getElementById(elId);
  const isRed = suit === '\u2665' || suit === '\u2666';
  el.className = 'hilo-card ' + (isRed ? 'red' : 'black') + (extraClass ? ' ' + extraClass : '');
  el.querySelector('.card-rank').textContent = rank;
  el.querySelector('.card-suit').textContent = suit;
}
async function startHiLo() {
  const bet = getBet('hilo-bet');
  if (bet <= 0 || bet > balance) return;
  balance -= bet; updateBalance(); saveState();

  const seedBefore = { serverSeedHash: pfState.serverSeedHash, clientSeed: pfState.clientSeed, nonce: pfState.nonce };
  const rand = await fairRandom();
  const cardIdx = Math.floor(rand * 52);
  const rank = CARD_RANKS[cardIdx % 13];
  const suit = CARD_SUITS[Math.floor(cardIdx / 13)];

  hiloState = {
    bet, currentRank: rank, currentSuit: suit, streak: 0, multi: 1.00, active: true,
    seedBefore, firstSeed: pfState.serverSeed
  };
  renderCard('hilo-current', rank, suit);
  document.getElementById('hilo-next').className = 'hilo-card next';
  document.getElementById('hilo-next').querySelector('.card-rank').textContent = '?';
  document.getElementById('hilo-next').querySelector('.card-suit').textContent = '';
  document.getElementById('hilo-multi').textContent = '1.00x';
  document.getElementById('hilo-streak').textContent = '0';
  document.getElementById('hilo-result').className = 'result';
  document.getElementById('hilo-start-btn').style.display = 'none';
  document.getElementById('hilo-cashout-btn').style.display = '';
  document.getElementById('hilo-hi-btn').disabled = false;
  document.getElementById('hilo-lo-btn').disabled = false;

  // Calculate odds display
  const val = cardValue(rank);
  const hiChance = (13 - val + 1) / 13;
  const loChance = val / 13;
  document.getElementById('hilo-hi-btn').textContent = '\u25B2 Higher (' + Math.round(hiChance * 100) + '%)';
  document.getElementById('hilo-lo-btn').textContent = '\u25BC Lower (' + Math.round(loChance * 100) + '%)';
}
async function guessHiLo(guess) {
  if (!hiloState || !hiloState.active) return;
  document.getElementById('hilo-hi-btn').disabled = true;
  document.getElementById('hilo-lo-btn').disabled = true;

  const rand = await fairRandom();
  const cardIdx = Math.floor(rand * 52);
  const newRank = CARD_RANKS[cardIdx % 13];
  const newSuit = CARD_SUITS[Math.floor(cardIdx / 13)];
  const oldVal = cardValue(hiloState.currentRank);
  const newVal = cardValue(newRank);

  const correct = (guess === 'hi' && newVal >= oldVal) || (guess === 'lo' && newVal <= oldVal);

  setTimeout(() => {
    renderCard('hilo-next', newRank, newSuit, correct ? 'win' : 'lose');
    if (correct) {
      hiloState.streak++;
      const odds = guess === 'hi' ? (13 - oldVal + 1) / 13 : oldVal / 13;
      hiloState.multi *= (0.98 / odds);
      hiloState.multi = Math.round(hiloState.multi * 100) / 100;
      document.getElementById('hilo-multi').textContent = hiloState.multi.toFixed(2) + 'x';
      document.getElementById('hilo-streak').textContent = hiloState.streak;
      // Shift cards
      setTimeout(() => {
        hiloState.currentRank = newRank;
        hiloState.currentSuit = newSuit;
        renderCard('hilo-current', newRank, newSuit);
        document.getElementById('hilo-next').className = 'hilo-card next';
        document.getElementById('hilo-next').querySelector('.card-rank').textContent = '?';
        document.getElementById('hilo-next').querySelector('.card-suit').textContent = '';
        document.getElementById('hilo-hi-btn').disabled = false;
        document.getElementById('hilo-lo-btn').disabled = false;
        const val = cardValue(newRank);
        document.getElementById('hilo-hi-btn').textContent = '\u25B2 Higher (' + Math.round(((13 - val) / 13) * 100) + '%)';
        document.getElementById('hilo-lo-btn').textContent = '\u25BC Lower (' + Math.round(((val - 1) / 13) * 100) + '%)';
      }, 600);
    } else {
      hiloState.active = false;
      const seedAfter = { ...hiloState.seedBefore, serverSeed: hiloState.firstSeed };
      showGameSeed('hilo-seed', seedAfter.serverSeed, seedAfter.serverSeedHash);
      showResult('hilo-result', false, newRank + newSuit + ' was not ' + (guess === 'hi' ? 'higher' : 'lower') + '. Lost ' + hiloState.bet.toLocaleString() + ' SPUNK\u2022BET');
      addHistory('HiLo', hiloState.bet, 'lose', -hiloState.bet, seedAfter);
      document.getElementById('hilo-cashout-btn').style.display = 'none';
      document.getElementById('hilo-start-btn').style.display = '';
      rotateServerSeed().then(() => savePFState());
    }
  }, 300);
}
function cashoutHiLo() {
  if (!hiloState || !hiloState.active) return;
  hiloState.active = false;
  const payout = Math.floor(hiloState.bet * hiloState.multi);
  balance += payout;
  const profit = payout - hiloState.bet;
  const seedAfter = { ...hiloState.seedBefore, serverSeed: hiloState.firstSeed };
  showGameSeed('hilo-seed', seedAfter.serverSeed, seedAfter.serverSeedHash);
  showResult('hilo-result', true, 'Cashed out at ' + hiloState.multi.toFixed(2) + 'x! Won +' + profit.toLocaleString() + ' SPUNK\u2022BET');
  addHistory('HiLo', hiloState.bet, 'win', profit, seedAfter);
  document.getElementById('hilo-cashout-btn').style.display = 'none';
  document.getElementById('hilo-start-btn').style.display = '';
  updateBalance(); saveState();
  rotateServerSeed().then(() => savePFState());
}

// ===== RUNE TOWER =====
let towerState = null;
let towerDiff = 'easy';
const TOWER_CONFIG = {
  easy: { cols: 4, traps: 1, floors: 10 },
  medium: { cols: 3, traps: 1, floors: 10 },
  hard: { cols: 2, traps: 1, floors: 10 },
  expert: { cols: 3, traps: 2, floors: 8 }
};
function setTowerDiff(diff) {
  if (towerState && towerState.active) return;
  towerDiff = diff;
  ['easy','medium','hard','expert'].forEach(d => {
    document.getElementById('tower-' + d).classList.toggle('active', d === diff);
  });
  initTowerGrid();
}
function getTowerMulti(floor, diff) {
  const cfg = TOWER_CONFIG[diff];
  const safeOdds = (cfg.cols - cfg.traps) / cfg.cols;
  return Math.pow(0.98 / safeOdds, floor);
}
function initTowerGrid() {
  const cfg = TOWER_CONFIG[towerDiff];
  const grid = document.getElementById('tower-grid');
  grid.innerHTML = '';
  for (let f = 0; f < cfg.floors; f++) {
    const floor = document.createElement('div');
    floor.className = 'tower-floor cols-' + cfg.cols;
    floor.dataset.floor = f;
    for (let c = 0; c < cfg.cols; c++) {
      const cell = document.createElement('div');
      cell.className = 'tower-cell' + (f > 0 ? ' locked' : '');
      cell.dataset.floor = f;
      cell.dataset.col = c;
      cell.textContent = f === 0 ? '' : '';
      floor.appendChild(cell);
    }
    grid.appendChild(floor);
  }
  document.getElementById('tower-floor').textContent = '0';
  document.getElementById('tower-multi').textContent = '1.00x';
  document.getElementById('tower-profit').textContent = '+0';
  document.getElementById('tower-result').className = 'result';
  document.getElementById('tower-start-btn').style.display = '';
  document.getElementById('tower-cashout-btn').style.display = 'none';
  towerState = null;
}
let towerStarting = false;
async function startTower() {
  if (towerStarting || (towerState && towerState.active)) return;
  const bet = getBet('tower-bet');
  if (bet <= 0 || bet > balance) return;
  towerStarting = true;
  balance -= bet; updateBalance(); saveState();

  const cfg = TOWER_CONFIG[towerDiff];
  const seedBefore = { serverSeedHash: pfState.serverSeedHash, clientSeed: pfState.clientSeed, nonce: pfState.nonce };

  // Generate trap positions for each floor
  const traps = [];
  for (let f = 0; f < cfg.floors; f++) {
    const floorTraps = [];
    const avail = Array.from({length: cfg.cols}, (_, i) => i);
    for (let t = 0; t < cfg.traps; t++) {
      const rand = await fairRandom();
      const idx = Math.floor(rand * avail.length);
      floorTraps.push(avail[idx]);
      avail.splice(idx, 1);
    }
    traps.push(floorTraps);
  }
  const seedAfter = { ...seedBefore, serverSeed: pfState.serverSeed };
  await rotateServerSeed(); savePFState();

  initTowerGrid();
  towerState = { bet, diff: towerDiff, traps, currentFloor: 0, active: true, seedData: seedAfter, config: cfg };
  towerStarting = false;
  // Unlock floor 0
  document.querySelectorAll('.tower-cell[data-floor="0"]').forEach(cell => {
    cell.classList.remove('locked');
    cell.onclick = () => climbTower(parseInt(cell.dataset.floor), parseInt(cell.dataset.col));
  });
  document.getElementById('tower-start-btn').style.display = 'none';
  document.getElementById('tower-cashout-btn').style.display = '';
  showGameSeed('tower-seed', seedAfter.serverSeed, seedAfter.serverSeedHash);
}
function climbTower(floor, col) {
  if (!towerState || !towerState.active || floor !== towerState.currentFloor) return;
  const cell = document.querySelector('.tower-cell[data-floor="' + floor + '"][data-col="' + col + '"]');
  if (!cell || cell.classList.contains('revealed')) return;

  const isTrapped = towerState.traps[floor].includes(col);
  if (isTrapped) {
    cell.classList.add('revealed', 'trap');
    cell.textContent = '\u2620';
    towerState.active = false;
    // Reveal all traps on this floor
    towerState.traps[floor].forEach(t => {
      const tc = document.querySelector('.tower-cell[data-floor="' + floor + '"][data-col="' + t + '"]');
      if (tc && !tc.classList.contains('revealed')) { tc.classList.add('revealed', 'shown'); tc.textContent = '\u2620'; }
    });
    showResult('tower-result', false, 'Trapped on floor ' + (floor + 1) + '! Lost ' + towerState.bet.toLocaleString() + ' SPUNK\u2022BET');
    addHistory('Rune Tower', towerState.bet, 'lose', -towerState.bet, towerState.seedData);
    document.getElementById('tower-cashout-btn').style.display = 'none';
    document.getElementById('tower-start-btn').style.display = '';
  } else {
    cell.classList.add('revealed', 'safe');
    cell.textContent = '\u2B50';
    // Reveal traps on this floor
    towerState.traps[floor].forEach(t => {
      const tc = document.querySelector('.tower-cell[data-floor="' + floor + '"][data-col="' + t + '"]');
      if (tc && !tc.classList.contains('revealed')) { tc.classList.add('revealed', 'shown'); tc.textContent = '\u2620'; }
    });
    towerState.currentFloor++;
    const multi = getTowerMulti(towerState.currentFloor, towerState.diff);
    const profit = Math.floor(towerState.bet * multi) - towerState.bet;
    document.getElementById('tower-floor').textContent = towerState.currentFloor;
    document.getElementById('tower-multi').textContent = multi.toFixed(2) + 'x';
    document.getElementById('tower-profit').textContent = '+' + profit.toLocaleString();
    if (towerState.currentFloor >= towerState.config.floors) {
      cashoutTower();
    } else {
      // Unlock next floor
      document.querySelectorAll('.tower-cell[data-floor="' + towerState.currentFloor + '"]').forEach(c => {
        c.classList.remove('locked');
        c.classList.add('current');
        c.onclick = () => climbTower(parseInt(c.dataset.floor), parseInt(c.dataset.col));
      });
    }
  }
}
function cashoutTower() {
  if (!towerState || !towerState.active) return;
  if (towerState.currentFloor < 1) { showToast('Climb at least 1 floor before cashing out!'); return; }
  towerState.active = false;
  const multi = getTowerMulti(towerState.currentFloor, towerState.diff);
  const payout = Math.floor(towerState.bet * multi);
  balance += payout;
  const profit = payout - towerState.bet;
  showResult('tower-result', true, 'Escaped at floor ' + towerState.currentFloor + ' (' + multi.toFixed(2) + 'x)! Won +' + profit.toLocaleString() + ' SPUNK\u2022BET');
  addHistory('Rune Tower', towerState.bet, 'win', profit, towerState.seedData);
  document.getElementById('tower-cashout-btn').style.display = 'none';
  document.getElementById('tower-start-btn').style.display = '';
  updateBalance(); saveState();
}

// ===== XVERSE WALLET =====
let walletState = { connected: false, paymentAddress: null, ordinalsAddress: null };

function handleWalletClick() {
  if (walletState.connected) {
    showWalletDetails();
  } else {
    document.getElementById('wallet-modal').classList.add('show');
    document.getElementById('wallet-install-hint').style.display = 'none';
    document.getElementById('wallet-install-text').innerHTML = '';
  }
}

function closeWalletModal() { document.getElementById('wallet-modal').classList.remove('show'); }
function closeWalletDetails() { document.getElementById('wallet-details-modal').classList.remove('show'); }

function showWalletDetails() {
  const el = document.getElementById('wallet-info-details');
  const shortAddr = (a) => a ? a.slice(0, 8) + '...' + a.slice(-6) : 'N/A';
  el.innerHTML =
    '<div class="wallet-info-row"><span class="wallet-info-label">Payment</span><span class="wallet-info-value">' + shortAddr(walletState.paymentAddress) + '</span></div>' +
    '<div class="wallet-info-row"><span class="wallet-info-label">Ordinals</span><span class="wallet-info-value">' + shortAddr(walletState.ordinalsAddress) + '</span></div>' +
    '<div class="wallet-info-row"><span class="wallet-info-label">Network</span><span class="wallet-info-value">Mainnet</span></div>';

  const count = getReferralCount();
  const tier = getTier(count);
  document.getElementById('wallet-tier-display').innerHTML =
    '<div style="display:flex;justify-content:space-between;align-items:center;font-size:0.85rem;">' +
      '<span style="color:var(--muted);">Referral Tier</span>' +
      '<span class="tier-badge ' + tier.css + '">' + tier.name + '</span>' +
    '</div>' +
    '<div style="display:flex;justify-content:space-between;align-items:center;font-size:0.85rem;margin-top:0.3rem;">' +
      '<span style="color:var(--muted);">Referrals</span>' +
      '<span style="font-weight:700;color:var(--accent);">' + count + '</span>' +
    '</div>';
  document.getElementById('wallet-details-modal').classList.add('show');
}

function updateWalletButton() {
  const btn = document.getElementById('wallet-btn');
  if (walletState.connected) {
    const short = walletState.paymentAddress.slice(0, 6) + '...' + walletState.paymentAddress.slice(-4);
    btn.className = 'wallet-btn connected';
    btn.innerHTML = '<div class="wallet-dot"></div>' + short;
  } else {
    btn.className = 'wallet-btn';
    btn.textContent = 'Connect Wallet';
  }
}

function updateShareButton() {
  document.getElementById('share-btn').classList.toggle('visible', walletState.connected);
  const mobileShare = document.getElementById('mobile-share-btn');
  if (mobileShare) mobileShare.style.display = walletState.connected ? '' : 'none';
}

function disconnectWallet() {
  walletState = { connected: false, paymentAddress: null, ordinalsAddress: null };
  localStorage.removeItem('spunkbet_wallet');
  updateWalletButton();
  updateShareButton();
  closeWalletDetails();
}

function onWalletConnected() {
  if (typeof trackEvent === 'function') trackEvent('wallet_connect');
  updateWalletButton();
  updateShareButton();
  closeWalletModal();
  saveState();
  processReferralOnConnect(walletState.paymentAddress);
  updateFaucetButton();
  updateFaucetDisplay();
}

function getXverseProvider() {
  if (window.XverseProviders?.BitcoinProvider) return window.XverseProviders.BitcoinProvider;
  if (window.BitcoinProvider) return window.BitcoinProvider;
  if (window.btc_providers) {
    const xverse = window.btc_providers.find(p =>
      p.id === 'BitcoinProvider' || p.id === 'xverseProviders.BitcoinProvider'
    );
    if (xverse) return xverse.id.split('.').reduce((obj, key) => obj?.[key], window);
  }
  return null;
}

async function connectXverse() {
  const provider = getXverseProvider();
  if (!provider) { document.getElementById('wallet-install-hint').style.display = 'block'; return; }
  try {
    const connectResponse = await provider.request('wallet_connect', {
      addresses: ['payment', 'ordinals'],
      message: 'Spunk.bet wants to connect your wallet',
      network: 'Mainnet'
    });
    if (connectResponse.status === 'success') {
      const addresses = connectResponse.result.addresses || [];
      const payment = addresses.find(a => a.purpose === 'payment');
      const ordinals = addresses.find(a => a.purpose === 'ordinals');
      if (payment || addresses.length > 0) {
        walletState = { connected: true, paymentAddress: payment?.address || addresses[0]?.address, ordinalsAddress: ordinals?.address || null, provider: 'xverse' };
        onWalletConnected();
        return;
      }
    }
    const addrResponse = await provider.request('getAddresses', { purposes: ['payment', 'ordinals'] });
    if (addrResponse.status === 'success') {
      const addresses = addrResponse.result.addresses || addrResponse.result || [];
      const payment = addresses.find(a => a.purpose === 'payment');
      const ordinals = addresses.find(a => a.purpose === 'ordinals');
      walletState = { connected: true, paymentAddress: payment?.address || addresses[0]?.address, ordinalsAddress: ordinals?.address || null, provider: 'xverse' };
      onWalletConnected();
    }
  } catch (err) {
    if (err?.error?.code === -32000 || err?.code === 4001 || err?.error?.code === 4001) {
      closeWalletModal();
    } else {
      console.error('Xverse connection error:', err);
      document.getElementById('wallet-install-hint').style.display = 'block';
    }
  }
}

// ===== UNISAT WALLET =====
async function connectUnisat() {
  if (!window.unisat) {
    const hint = document.getElementById('wallet-install-hint');
    document.getElementById('wallet-install-text').innerHTML = 'Unisat not detected. <a href="https://unisat.io/download" target="_blank" style="color:var(--accent); text-decoration:none; font-weight:600;">Download Unisat</a> and refresh.';
    hint.style.display = 'block';
    return;
  }
  try {
    const accounts = await window.unisat.requestAccounts();
    if (accounts && accounts.length > 0) {
      walletState = {
        connected: true,
        paymentAddress: accounts[0],
        ordinalsAddress: accounts[0],
        provider: 'unisat'
      };
      onWalletConnected();
    }
  } catch (err) {
    if (err?.code === 4001) {
      closeWalletModal();
    } else {
      console.error('Unisat connection error:', err);
    }
  }
}

// ===== MAGIC EDEN WALLET =====
async function connectMagicEden() {
  const provider = window.magicEden?.bitcoin || window.MagicEden?.bitcoin;
  if (!provider) {
    const hint = document.getElementById('wallet-install-hint');
    document.getElementById('wallet-install-text').innerHTML = 'Magic Eden wallet not detected. <a href="https://wallet.magiceden.io/" target="_blank" style="color:var(--accent); text-decoration:none; font-weight:600;">Download Magic Eden Wallet</a> and refresh.';
    hint.style.display = 'block';
    return;
  }
  try {
    const accounts = await provider.connect();
    if (accounts && accounts.length > 0) {
      const payment = accounts.find(a => a.purpose === 'payment');
      const ordinals = accounts.find(a => a.purpose === 'ordinals');
      walletState = {
        connected: true,
        paymentAddress: payment?.address || accounts[0]?.address || accounts[0],
        ordinalsAddress: ordinals?.address || accounts[0]?.address || accounts[0],
        provider: 'magiceden'
      };
      onWalletConnected();
    }
  } catch (err) {
    if (err?.code === 4001) {
      closeWalletModal();
    } else {
      console.error('Magic Eden connection error:', err);
      // Try alternative API
      try {
        const res = await provider.requestAccounts();
        if (res && res.length > 0) {
          walletState = {
            connected: true,
            paymentAddress: res[0],
            ordinalsAddress: res[0],
            provider: 'magiceden'
          };
          onWalletConnected();
        }
      } catch (e2) {
        console.error('Magic Eden fallback error:', e2);
      }
    }
  }
}

// ===== PAYOUT API =====
const API_BASE = 'https://spunkbet-api.vercel.app';

async function claimFaucetOnChain() {
  if (!walletState.connected) return;
  try {
    const res = await fetch(API_BASE + '/api/claim', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: 'faucet', address: walletState.paymentAddress })
    });
    const data = await res.json();
    if (data.success) {
      showToast('Runes sent! TX: <span class="toast-amount">' + data.txid.slice(0, 12) + '...</span>');
    } else if (data.error) {
      showToast(data.error);
    }
  } catch (err) {
    console.error('Faucet claim error:', err);
  }
}

async function claimReferralOnChain(referrerAddress) {
  if (!walletState.connected) return;
  try {
    const res = await fetch(API_BASE + '/api/claim', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'referral',
        address: referrerAddress,
        referrerCode: walletState.paymentAddress.slice(0, 8),
        referredAddress: walletState.paymentAddress
      })
    });
    const data = await res.json();
    if (data.success) {
      showToast('Referral reward sent on-chain! TX: <span class="toast-amount">' + data.txid.slice(0, 12) + '...</span>');
    }
  } catch (err) {
    console.error('Referral claim error:', err);
  }
}

// ===== REFERRAL MODAL =====
function openReferralModal() {
  if (!walletState.connected) return;
  const code = walletState.paymentAddress.slice(0, 8);
  const link = window.location.origin + window.location.pathname + '?ref=' + code;
  document.getElementById('referral-link-input').value = link;
  document.getElementById('referral-code').textContent = code;
  const count = getReferralCount();
  document.getElementById('referral-count').textContent = count;
  const tier = getTier(count);
  document.getElementById('referral-tier').innerHTML = '<span class="tier-badge ' + tier.css + '">' + tier.name + '</span>';
  document.getElementById('referral-earned').textContent = getReferralEarnings().toLocaleString();
  renderTierCards('tiers-grid', count);
  document.getElementById('referral-modal').classList.add('show');
}

function closeReferralModal() { document.getElementById('referral-modal').classList.remove('show'); }

function shareReferralOnX() {
  if (!walletState.connected) return;
  if (typeof trackEvent === 'function') trackEvent('referral_share');
  const code = walletState.paymentAddress.slice(0, 8);
  const link = 'https://spunk.bet?ref=' + code;
  const text = 'Free crypto casino on Bitcoin \uD83C\uDFB0\n\nFast. Fair. Free. 10k free tokens daily + real ordinal prizes. No KYC. Come play \u2192 ' + link + '\n\nSupport @SpunkArt13 \u2014 a project for everyone \uD83E\uDDE1';
  downloadWinCard();
  window.open('https://x.com/intent/tweet?text=' + encodeURIComponent(text), '_blank');
  shareBonus();
}

function shareFirst100() {
  if (!walletState.connected) {
    document.getElementById('wallet-modal').classList.add('show');
    document.getElementById('wallet-install-hint').style.display = 'none';
    document.getElementById('wallet-install-text').innerHTML = '';
    showToast('Connect wallet first to get your referral link');
    return;
  }
  const code = walletState.paymentAddress.slice(0, 8);
  const link = 'https://spunk.bet?ref=' + code;
  const remaining = document.getElementById('first100-count')?.textContent || '?';
  const text = 'Only ' + remaining + ' spots left for 2x bonus rewards on Spunk.Bet \uD83C\uDFB0\n\nFast. Fair. Free. Daily runes + ordinal prizes. Claim yours \u2192 ' + link + '\n\n@SpunkArt13';
  window.open('https://x.com/intent/tweet?text=' + encodeURIComponent(text), '_blank');
  shareBonus();
}

function copyReferralLink() {
  const input = document.getElementById('referral-link-input');
  navigator.clipboard.writeText(input.value).then(() => {
    const btn = input.nextElementSibling;
    btn.textContent = 'Copied!';
    setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
  });
}

// ===== WALLET ADDRESS COPY =====
function copyWalletAddr(id) {
  const input = document.getElementById(id);
  navigator.clipboard.writeText(input.value).then(() => {
    const btn = input.nextElementSibling;
    btn.textContent = 'Copied!';
    setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
  });
}

// Close modals on backdrop click
document.getElementById('wallet-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeWalletModal(); });
document.getElementById('wallet-details-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeWalletDetails(); });
document.getElementById('referral-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeReferralModal(); });

// Update faucet timer every minute
setInterval(updateFaucetButton, 60000);

// ===== TURBO MODE =====
let turboMode = {};
function toggleTurbo(game) {
  const cb = document.getElementById('turbo-' + game);
  turboMode[game] = cb ? cb.checked : false;
}
function isTurbo(game) { return !!turboMode[game]; }

// ===== AUTOBET ENGINE =====
const autobetState = {};
const AUTOBET_GAMES = ['coinflip','dice','mines','crash','limbo','keno','wheel','plinko','hilo','tower'];

function getAutobetPanelHTML(game) {
  return '<div class="autobet-row"><span class="autobet-label">Number of Bets</span><input type="number" class="autobet-input" id="ab-count-'+game+'" value="0" min="0" placeholder="0 = infinite"></div>' +
    '<div class="autobet-row"><span class="autobet-label">On Win</span><select class="autobet-select" id="ab-onwin-'+game+'"><option value="reset">Reset</option><option value="increase">Increase by %</option></select><input type="number" class="autobet-input" id="ab-onwin-pct-'+game+'" value="0" min="0" style="max-width:60px;display:none;" placeholder="%"></div>' +
    '<div class="autobet-row"><span class="autobet-label">On Loss</span><select class="autobet-select" id="ab-onloss-'+game+'"><option value="reset">Reset</option><option value="increase">Increase by %</option></select><input type="number" class="autobet-input" id="ab-onloss-pct-'+game+'" value="0" min="0" style="max-width:60px;display:none;" placeholder="%"></div>' +
    '<div class="autobet-row"><span class="autobet-label">Stop on Profit</span><input type="number" class="autobet-input" id="ab-stopprofit-'+game+'" value="0" min="0" placeholder="0 = no limit"></div>' +
    '<div class="autobet-row"><span class="autobet-label">Stop on Loss</span><input type="number" class="autobet-input" id="ab-stoploss-'+game+'" value="0" min="0" placeholder="0 = no limit"></div>' +
    '<div class="autobet-row"><span class="autobet-label">Max Bet</span><input type="number" class="autobet-input" id="ab-maxbet-'+game+'" value="0" min="0" placeholder="0 = no limit"></div>' +
    '<button class="autobet-btn start" id="ab-btn-'+game+'" onclick="toggleAutobet(\''+game+'\')">Start Autobet</button>';
}

function initAutobetPanels() {
  AUTOBET_GAMES.forEach(game => {
    const panel = document.getElementById('autobet-' + game);
    if (panel) {
      panel.innerHTML = getAutobetPanelHTML(game);
      autobetState[game] = { running: false, count: 0, baseBet: 0, totalProfit: 0, totalLoss: 0 };
    }
    // Toggle % input visibility
    const onwinSel = document.getElementById('ab-onwin-' + game);
    const onlossSel = document.getElementById('ab-onloss-' + game);
    if (onwinSel) onwinSel.onchange = function() { document.getElementById('ab-onwin-pct-' + game).style.display = this.value === 'increase' ? '' : 'none'; };
    if (onlossSel) onlossSel.onchange = function() { document.getElementById('ab-onloss-pct-' + game).style.display = this.value === 'increase' ? '' : 'none'; };
  });
}

function setAutoMode(game, isAuto, tabEl) {
  const tabs = tabEl.parentElement.querySelectorAll('.mode-tab');
  tabs.forEach(t => t.classList.remove('active'));
  tabEl.classList.add('active');
  const panel = document.getElementById('autobet-' + game);
  if (panel) panel.classList.toggle('show', isAuto);
}

function toggleAutobet(game) {
  const state = autobetState[game];
  if (state.running) {
    stopAutobet(game);
  } else {
    startAutobet(game);
  }
}

function startAutobet(game) {
  const state = autobetState[game];
  const betInputMap = { coinflip:'cf-bet', dice:'dice-bet', mines:'mines-bet', crash:'crash-bet', limbo:'limbo-bet', keno:'keno-bet', wheel:'wheel-bet', plinko:'plinko-bet', hilo:'hilo-bet', tower:'tower-bet' };
  const betInput = document.getElementById(betInputMap[game]);
  state.baseBet = parseInt(betInput.value) || 100;
  state.running = true;
  state.count = 0;
  state.totalProfit = 0;
  state.totalLoss = 0;
  const btn = document.getElementById('ab-btn-' + game);
  btn.textContent = 'Stop Autobet';
  btn.className = 'autobet-btn stop';
  runAutobetRound(game);
}

function stopAutobet(game) {
  const state = autobetState[game];
  state.running = false;
  const btn = document.getElementById('ab-btn-' + game);
  btn.textContent = 'Start Autobet';
  btn.className = 'autobet-btn start';
}

function getAutobetSettings(game) {
  return {
    maxBets: parseInt(document.getElementById('ab-count-' + game).value) || 0,
    onWin: document.getElementById('ab-onwin-' + game).value,
    onWinPct: parseFloat(document.getElementById('ab-onwin-pct-' + game).value) || 0,
    onLoss: document.getElementById('ab-onloss-' + game).value,
    onLossPct: parseFloat(document.getElementById('ab-onloss-pct-' + game).value) || 0,
    stopProfit: parseInt(document.getElementById('ab-stopprofit-' + game).value) || 0,
    stopLoss: parseInt(document.getElementById('ab-stoploss-' + game).value) || 0,
    maxBet: parseInt(document.getElementById('ab-maxbet-' + game).value) || 0
  };
}

function adjustAutobetBet(game, won) {
  const betInputMap = { coinflip:'cf-bet', dice:'dice-bet', mines:'mines-bet', crash:'crash-bet', limbo:'limbo-bet', keno:'keno-bet', wheel:'wheel-bet', plinko:'plinko-bet', hilo:'hilo-bet', tower:'tower-bet' };
  const state = autobetState[game];
  const settings = getAutobetSettings(game);
  const betInput = document.getElementById(betInputMap[game]);
  let currentBet = parseInt(betInput.value) || state.baseBet;
  if (won) {
    if (settings.onWin === 'reset') currentBet = state.baseBet;
    else currentBet = Math.floor(currentBet * (1 + settings.onWinPct / 100));
  } else {
    if (settings.onLoss === 'reset') currentBet = state.baseBet;
    else currentBet = Math.floor(currentBet * (1 + settings.onLossPct / 100));
  }
  currentBet = Math.max(MIN_BET, currentBet);
  if (settings.maxBet > 0 && currentBet > settings.maxBet) {
    stopAutobet(game);
    currentBet = settings.maxBet;
  }
  betInput.value = currentBet;
}

function checkAutobetStop(game, won, profitThisRound) {
  const state = autobetState[game];
  const settings = getAutobetSettings(game);
  if (won) state.totalProfit += profitThisRound;
  else state.totalLoss += Math.abs(profitThisRound);
  state.count++;
  if (settings.maxBets > 0 && state.count >= settings.maxBets) { stopAutobet(game); return true; }
  if (settings.stopProfit > 0 && state.totalProfit >= settings.stopProfit) { stopAutobet(game); return true; }
  if (settings.stopLoss > 0 && state.totalLoss >= settings.stopLoss) { stopAutobet(game); return true; }
  if (balance < MIN_BET) { stopAutobet(game); return true; }
  return false;
}

async function runAutobetRound(game) {
  if (!autobetState[game].running) return;
  const balanceBefore = balance;

  // Call the game's play function
  const playFnMap = {
    coinflip: () => flipCoin(),
    dice: () => rollDice(),
    mines: () => autoplayMines(),
    crash: () => autoplayCrash(),
    limbo: () => playLimbo(),
    keno: () => playKenoAnimated(),
    wheel: () => spinWheel(),
    plinko: () => dropPlinko(),
    hilo: () => autoplayHiLo(),
    tower: () => autoplayTower()
  };

  try {
    await playFnMap[game]();
  } catch(e) {
    console.error('Autobet error:', e);
    stopAutobet(game);
    return;
  }

  // Wait for game animations to finish
  const delayMap = { coinflip:600, dice:500, mines:600, crash:1500, limbo:400, keno:1500, wheel:3500, plinko:1800, hilo:800, tower:600 };
  const turboDelayMap = { coinflip:100, dice:100, mines:250, crash:600, limbo:100, keno:300, wheel:800, plinko:400, hilo:300, tower:250 };
  const delay = isTurbo(game) ? (turboDelayMap[game] || 300) : (delayMap[game] || 1000);

  setTimeout(() => {
    if (!autobetState[game].running) return;
    const profitThisRound = balance - balanceBefore;
    const won = profitThisRound > 0;
    adjustAutobetBet(game, won);
    if (!checkAutobetStop(game, won, profitThisRound)) {
      runAutobetRound(game);
    }
  }, delay);
}

// Auto-play helpers for multi-step games
async function autoplayMines() {
  await startMines();
  // Auto-reveal 3 random safe-looking tiles then cashout
  await new Promise(r => setTimeout(r, 300));
  if (minesState && minesState.active) {
    const unrevealed = [];
    document.querySelectorAll('.mine-cell').forEach((c, i) => { if (!c.classList.contains('revealed')) unrevealed.push(i); });
    // Reveal 1-3 random tiles then cashout
    const reveals = Math.min(3, unrevealed.length);
    for (let i = 0; i < reveals; i++) {
      if (!minesState || !minesState.active) break;
      const idx = Math.floor(Math.random() * unrevealed.length);
      revealMine(unrevealed[idx]);
      unrevealed.splice(idx, 1);
      await new Promise(r => setTimeout(r, 150));
    }
    if (minesState && minesState.active) cashoutMines();
  }
}

async function autoplayCrash() {
  await startCrash();
  // Auto cashout at 2x
  return new Promise(resolve => {
    const check = setInterval(() => {
      if (!crashState) { clearInterval(check); resolve(); return; }
      if (crashState.multi >= 2.0 && crashState.active && !crashState.cashed) {
        cashoutCrash();
        clearInterval(check);
        resolve();
      }
      if (!crashState.active) { clearInterval(check); resolve(); }
    }, 50);
  });
}

async function autoplayHiLo() {
  await startHiLo();
  await new Promise(r => setTimeout(r, 400));
  // Always pick higher, then cashout after 1 correct
  if (hiloState && hiloState.active) {
    await guessHiLo('hi');
    await new Promise(r => setTimeout(r, 800));
    if (hiloState && hiloState.active) cashoutHiLo();
  }
}

async function autoplayTower() {
  await startTower();
  await new Promise(r => setTimeout(r, 300));
  // Click first cell of floor 0, then cashout
  if (towerState && towerState.active) {
    climbTower(0, 0);
    await new Promise(r => setTimeout(r, 300));
    if (towerState && towerState.active) cashoutTower();
  }
}

// ===== LIMBO HISTORY =====
let limboHistory = [];

function addLimboHistory(result, target) {
  const win = result >= target;
  limboHistory.unshift({ result, win });
  if (limboHistory.length > 25) limboHistory.pop();
  renderLimboHistory();
}

function renderLimboHistory() {
  const container = document.getElementById('limbo-history');
  if (!container) return;
  container.innerHTML = limboHistory.map(h =>
    '<div class="limbo-history-item ' + (h.win ? 'win' : 'lose') + '">' + h.result.toFixed(2) + 'x</div>'
  ).join('');
  // Scroll to show newest (leftmost)
  container.scrollLeft = 0;
}

// ===== KENO ANIMATED DRAW =====
let kenoPlaying = false;
async function playKenoAnimated() {
  if (kenoPlaying) return;
  if (kenoSelected.size === 0) { showToast('Pick at least 1 number'); return; }
  const bet = getBet('keno-bet');
  if (bet <= 0 || bet > balance) return;
  kenoPlaying = true;
  balance -= bet;
  updateBalance();

  // Clear ALL previous game state from grid cells
  const drawnArea = document.getElementById('keno-drawn-area');
  if (drawnArea) drawnArea.innerHTML = '';
  document.querySelectorAll('.keno-cell').forEach((cell, idx) => {
    const num = idx + 1;
    cell.classList.remove('drawn', 'hit', 'miss', 'keno-hit', 'keno-flash');
    cell.textContent = num;
    // Restore selected appearance for user's picks
    if (kenoSelected.has(num)) {
      cell.classList.add('selected');
    } else {
      cell.classList.remove('selected');
    }
  });
  document.getElementById('keno-result').className = 'result';
  document.getElementById('keno-result').textContent = '';

  const seedBefore = { serverSeedHash: pfState.serverSeedHash, clientSeed: pfState.clientSeed, nonce: pfState.nonce };
  const drawn = [];
  const avail = Array.from({length: 40}, (_, i) => i + 1);
  for (let i = 0; i < 10; i++) {
    const rand = await fairRandom();
    const idx = Math.floor(rand * avail.length);
    drawn.push(avail[idx]);
    avail.splice(idx, 1);
  }
  const seedAfter = { ...seedBefore, serverSeed: pfState.serverSeed };
  await rotateServerSeed(); savePFState();

  const cells = document.querySelectorAll('.keno-cell');
  const picks = kenoSelected.size;

  // Per-ball win calculation
  let hits = 0;
  const revealBall = (i) => {
    return new Promise(resolve => {
      setTimeout(() => {
        const num = drawn[i];
        const isHit = kenoSelected.has(num);
        if (isHit) hits++;

        // Mark on grid with highlight
        const cell = cells[num - 1];
        cell.classList.add('drawn');
        if (isHit) {
          cell.classList.add('keno-hit');
          cell.textContent = '\u2713';
          // Highlight the payout table
          const payoutSlots = document.querySelectorAll('.keno-payout-slot');
          payoutSlots.forEach(s => s.classList.remove('active'));
          if (payoutSlots[hits]) payoutSlots[hits].classList.add('active');
        } else {
          cell.classList.add('miss');
        }

        // Add ball to drawn area
        if (drawnArea) {
          const ball = document.createElement('div');
          ball.className = 'keno-ball ' + (isHit ? 'hit' : 'miss');
          ball.textContent = num;
          if (isHit) {
            const perBallMulti = getKenoMultiplier(picks, hits);
            if (perBallMulti > 0) {
              const winSpan = document.createElement('span');
              winSpan.className = 'ball-win';
              winSpan.textContent = '+' + Math.floor(bet * perBallMulti).toLocaleString();
              ball.appendChild(winSpan);
            }
          }
          drawnArea.appendChild(ball);
        }
        resolve();
      }, i * 100);
    });
  };

  // Stagger reveal all balls
  const promises = [];
  for (let i = 0; i < 10; i++) {
    promises.push(revealBall(i));
  }
  await Promise.all(promises);

  // Wait for last ball animation
  await new Promise(r => setTimeout(r, 200));

  // Dim selected numbers that were not drawn
  cells.forEach((cell, idx) => {
    const num = idx + 1;
    if (kenoSelected.has(num) && !drawn.includes(num)) {
      cell.classList.add('drawn', 'miss');
    }
  });

  const multi = getKenoMultiplier(picks, hits);
  showGameSeed('keno-seed', seedAfter.serverSeed, seedAfter.serverSeedHash);
  if (multi > 0) {
    const payout = Math.floor(bet * multi);
    balance += payout;
    showResult('keno-result', true, hits + ' hits! ' + multi + 'x payout. Won +' + (payout - bet).toLocaleString() + ' SPUNK\u2022BET');
    addHistory('Keno', bet, 'win', payout - bet, seedAfter);
  } else {
    showResult('keno-result', false, hits + ' hits. Not enough to win. Lost ' + bet.toLocaleString() + ' SPUNK\u2022BET');
    addHistory('Keno', bet, 'lose', -bet, seedAfter);
  }
  updateBalance(); saveState();
  kenoPlaying = false;
}

// ===== SHARE-TO-EARN BONUS SYSTEM =====
function shareBonus() {
  let shares = {};
  try { shares = JSON.parse(localStorage.getItem('spunkbet_shares') || '{}'); } catch(e) {}
  const today = new Date().toDateString();
  if (!shares[today]) shares[today] = 0;
  if (shares[today] >= 3) return; // Max 3 bonuses per 24h
  shares[today]++;
  // Clean old entries
  Object.keys(shares).forEach(k => { if (k !== today) delete shares[k]; });
  localStorage.setItem('spunkbet_shares', JSON.stringify(shares));
  balance += 2500;
  updateBalance();
  saveState();
  showToast('Shared! <span class="toast-amount">+2,500 SPUNK\u2022BET</span> bonus (' + shares[today] + '/3 today)');
}

// ===== WIN STREAK TRACKER =====
let winStreak = parseInt(localStorage.getItem('spunkbet_streak') || '0');

function updateStreakBadge() {
  const badge = document.getElementById('streak-badge');
  const countEl = document.getElementById('streak-count');
  if (!badge) return;
  if (winStreak >= 3) {
    badge.classList.add('show');
    countEl.textContent = winStreak;
  } else {
    badge.classList.remove('show');
  }
}

function checkStreakMilestone() {
  const milestones = [5, 10, 25, 50];
  if (milestones.includes(winStreak)) {
    const bonus = winStreak * 100;
    balance += bonus;
    updateBalance();
    saveState();
    showToast('\uD83D\uDD25 ' + winStreak + ' Win Streak! <span class="toast-amount">+' + bonus.toLocaleString() + ' SPUNK\u2022BET</span> bonus! <button class="toast-share-btn" onclick="shareStreakOnX()">Share</button>');
  }
}

async function shareStreakOnX() {
  const refCode = walletState.connected ? walletState.paymentAddress.slice(0, 8) : '';
  const link = refCode ? 'https://spunk.bet?ref=' + refCode : 'https://spunk.bet';
  const text = '\uD83D\uDD25 ' + winStreak + ' Win Streak on Spunk.Bet!\n\nFast. Fair. Free. Beat my streak & win real ordinals \u2192 ' + link + '\n\n@SpunkArt13';
  const url = 'https://x.com/intent/tweet?text=' + encodeURIComponent(text);
  window.open(url, '_blank', 'width=550,height=420');
  shareBonus();
}

// ===== BIG WIN OVERLAY =====
function showBigWinOverlay(amount, multi, game) {
  const overlay = document.getElementById('bigwin-overlay');
  document.getElementById('bigwin-amount').textContent = '+' + Math.abs(amount).toLocaleString() + ' SPUNK\u2022BET';
  document.getElementById('bigwin-multi').textContent = multi + ' on ' + game;
  const emojis = ['\uD83C\uDF89', '\uD83C\uDFB0', '\uD83D\uDCB0', '\uD83D\uDD25', '\uD83D\uDE80'];
  document.getElementById('bigwin-emoji').textContent = emojis[Math.floor(Math.random() * emojis.length)];
  overlay.classList.add('show');
  spawnConfetti();
}

function closeBigWin() {
  document.getElementById('bigwin-overlay').classList.remove('show');
}

async function shareBigWinOnX() {
  closeBigWin();
  shareWinOnX();
}

function spawnConfetti() {
  const colors = ['#ff5f1f', '#22c55e', '#eab308', '#a855f7', '#3b82f6', '#ec4899'];
  for (let i = 0; i < 40; i++) {
    const p = document.createElement('div');
    p.className = 'confetti-particle';
    p.style.left = Math.random() * 100 + 'vw';
    p.style.top = '-10px';
    p.style.background = colors[Math.floor(Math.random() * colors.length)];
    p.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
    p.style.width = (4 + Math.random() * 8) + 'px';
    p.style.height = (4 + Math.random() * 8) + 'px';
    p.style.animationDelay = (Math.random() * 1) + 's';
    p.style.animationDuration = (2 + Math.random() * 2) + 's';
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 5000);
  }
}

// ===== LIVE WINS TICKER =====
function updateLiveTicker(game, bet, result, amount) {
  if (result !== 'win') return;
  const wrap = document.getElementById('live-ticker-wrap');
  const inner = document.getElementById('live-ticker-inner');
  if (!wrap || !inner) return;
  wrap.style.display = '';
  const multi = bet > 0 ? ((amount + bet) / bet).toFixed(1) + 'x' : '';
  const addr = walletState.connected ? walletState.paymentAddress.slice(0, 6) + '...' + walletState.paymentAddress.slice(-4) : 'Player';
  const item = '<span class="ticker-item">' + addr + ' won <span class="ticker-win">+' + Math.abs(amount).toLocaleString() + '</span> on <span class="ticker-game">' + game + '</span> (' + multi + ')</span>';
  // Duplicate for seamless scroll
  inner.innerHTML = inner.innerHTML.replace(/<span class="ticker-item">.*?<\/span>/g, m => m).slice(0, 3000);
  inner.innerHTML = item + inner.innerHTML;
  // Keep duplicated for infinite scroll
  const items = inner.querySelectorAll('.ticker-item');
  if (items.length > 20) {
    for (let i = 20; i < items.length; i++) items[i].remove();
  }
  // Duplicate content for seamless loop
  const uniqueHTML = inner.innerHTML;
  inner.innerHTML = uniqueHTML + uniqueHTML;
}

function initLiveTicker() {
  // Populate with recent wins from history
  const wins = history.filter(h => h.result === 'win').slice(0, 8);
  if (wins.length === 0) return;
  const wrap = document.getElementById('live-ticker-wrap');
  const inner = document.getElementById('live-ticker-inner');
  if (!wrap || !inner) return;
  wrap.style.display = '';
  let html = '';
  wins.forEach(w => {
    const multi = w.bet > 0 ? ((w.amount + w.bet) / w.bet).toFixed(1) + 'x' : '';
    html += '<span class="ticker-item">Player won <span class="ticker-win">+' + Math.abs(w.amount).toLocaleString() + '</span> on <span class="ticker-game">' + w.game + '</span> (' + multi + ')</span>';
  });
  inner.innerHTML = html + html; // Duplicate for seamless scroll
}

// ===== CUMULATIVE STATS & MILESTONES =====
let cumulativeStats = {};

function loadCumulativeStats() {
  try { cumulativeStats = JSON.parse(localStorage.getItem('spunkbet_stats') || '{}'); } catch(e) {}
  if (!cumulativeStats.total_wagered) cumulativeStats = { total_wagered: 0, total_won: 0, games_played: 0, biggest_win: 0, biggest_multi: 0, milestones_hit: [] };
}

function saveCumulativeStats() {
  localStorage.setItem('spunkbet_stats', JSON.stringify(cumulativeStats));
}

function updateCumulativeStats(game, bet, result, amount, multi) {
  cumulativeStats.total_wagered += bet;
  cumulativeStats.games_played++;
  if (result === 'win') {
    cumulativeStats.total_won += amount;
    if (amount > cumulativeStats.biggest_win) cumulativeStats.biggest_win = amount;
    if (multi > cumulativeStats.biggest_multi) cumulativeStats.biggest_multi = multi;
  }
  saveCumulativeStats();
  checkMilestones();
  trackWagerLB(bet);
  updatePlayerRankBadge();
}

function checkMilestones() {
  const milestones = [
    { id: 'first_win', check: () => cumulativeStats.total_won > 0, msg: 'First win!', bonus: 500 },
    { id: 'bets_100', check: () => cumulativeStats.games_played >= 100, msg: '100 bets placed!', bonus: 1000 },
    { id: 'bets_1000', check: () => cumulativeStats.games_played >= 1000, msg: '1,000 bets placed!', bonus: 2500 },
    { id: 'wagered_10k', check: () => cumulativeStats.total_wagered >= 10000, msg: '10K total wagered!', bonus: 1000 },
    { id: 'wagered_100k', check: () => cumulativeStats.total_wagered >= 100000, msg: '100K total wagered!', bonus: 2500 },
    { id: 'wagered_1m', check: () => cumulativeStats.total_wagered >= 1000000, msg: '1M total wagered!', bonus: 5000 },
  ];
  const hit = cumulativeStats.milestones_hit || [];
  milestones.forEach(m => {
    if (!hit.includes(m.id) && m.check()) {
      hit.push(m.id);
      cumulativeStats.milestones_hit = hit;
      saveCumulativeStats();
      balance += m.bonus;
      updateBalance();
      saveState();
      showToast('\uD83C\uDFC6 Milestone: ' + m.msg + ' <span class="toast-amount">+' + m.bonus.toLocaleString() + ' SPUNK\u2022BET</span>');
    }
  });
}

// ===== PLAYER RANK SYSTEM =====
const PLAYER_RANKS = [
  { name: 'Unranked', min: 0, icon: '', css: '', color: '#71717a' },
  { name: 'Bronze', min: 5000, icon: '\uD83E\uDD49', css: 'rank-bronze', color: '#cd7f32' },
  { name: 'Silver', min: 50000, icon: '\uD83E\uDD48', css: 'rank-silver', color: '#c0c0c0' },
  { name: 'Gold', min: 250000, icon: '\uD83E\uDD47', css: 'rank-gold', color: '#ffd700' },
  { name: 'Platinum', min: 1000000, icon: '\uD83D\uDC8E', css: 'rank-platinum', color: '#a78bfa' },
];

function getPlayerRank(totalWagered) {
  let rank = PLAYER_RANKS[0];
  for (let i = PLAYER_RANKS.length - 1; i >= 0; i--) {
    if (totalWagered >= PLAYER_RANKS[i].min) { rank = PLAYER_RANKS[i]; break; }
  }
  return rank;
}

function getNextRank(totalWagered) {
  for (const r of PLAYER_RANKS) {
    if (totalWagered < r.min) return r;
  }
  return null;
}

function updatePlayerRankBadge() {
  const badge = document.getElementById('player-rank-badge');
  if (!badge) return;
  const wagered = cumulativeStats.total_wagered || 0;
  const rank = getPlayerRank(wagered);
  if (rank.css) {
    badge.className = 'player-rank-badge show ' + rank.css;
    badge.textContent = rank.icon + ' ' + rank.name;
  } else {
    badge.className = 'player-rank-badge';
  }
}

function renderPlayerRankCard() {
  const el = document.getElementById('player-rank-card');
  if (!el) return;
  const wagered = cumulativeStats.total_wagered || 0;
  const rank = getPlayerRank(wagered);
  const next = getNextRank(wagered);
  const games = cumulativeStats.games_played || 0;

  let progressHTML = '';
  if (next) {
    const pct = Math.min(100, Math.floor((wagered / next.min) * 100));
    progressHTML = '<div class="rank-progress">' +
      '<div style="display:flex;justify-content:space-between;font-size:0.8rem;">' +
        '<span style="color:' + rank.color + ';font-weight:700;">' + (rank.css ? rank.icon + ' ' + rank.name : 'Unranked') + '</span>' +
        '<span style="color:' + next.color + ';font-weight:700;">' + next.icon + ' ' + next.name + '</span>' +
      '</div>' +
      '<div class="rank-bar-bg"><div class="rank-bar-fill" style="width:' + pct + '%;background:linear-gradient(90deg,' + rank.color + ',' + next.color + ');"></div></div>' +
      '<div class="rank-next">Wager <strong style="color:var(--accent)">' + (next.min - wagered).toLocaleString() + '</strong> more SPUNK to reach ' + next.name + '</div>' +
    '</div>';
  } else {
    progressHTML = '<div class="rank-progress"><div style="color:var(--purple);font-weight:700;font-size:0.9rem;">' + rank.icon + ' MAX RANK: ' + rank.name + '!</div></div>';
  }

  el.innerHTML =
    '<div style="text-align:center;margin-bottom:0.5rem;">' +
      '<div style="font-size:2.5rem;">' + (rank.icon || '\uD83C\uDFAE') + '</div>' +
      '<div style="font-size:1.1rem;font-weight:800;color:' + rank.color + ';">' + rank.name + '</div>' +
      '<div style="font-size:0.8rem;color:var(--muted);">' + wagered.toLocaleString() + ' wagered &middot; ' + games.toLocaleString() + ' bets</div>' +
    '</div>' +
    progressHTML;
}

// ===== WAGER LEADERBOARD (Daily/Weekly/All-Time) =====
let currentLBTab = 'daily';
const LB_KEY = 'spunkbet_wager_lb';
const DAILY_PRIZE_KEY = 'spunkbet_daily_prize';
const WEEKLY_PRIZE_KEY = 'spunkbet_weekly_prize';

// Daily prizes: top 3 get SPUNK
const DAILY_PRIZES = [10000, 5000, 2500];
const WEEKLY_PRIZES = [50000, 25000, 10000, 5000, 2500];

function loadWagerLB() {
  try { return JSON.parse(localStorage.getItem(LB_KEY) || '{}'); } catch(e) { return {}; }
}

function saveWagerLB(data) {
  localStorage.setItem(LB_KEY, JSON.stringify(data));
}

function trackWagerLB(bet) {
  const data = loadWagerLB();
  const today = new Date().toISOString().slice(0, 10);
  const weekStart = getWeekStart();

  if (!data.daily) data.daily = {};
  if (!data.weekly) data.weekly = {};
  if (!data.alltime) data.alltime = 0;
  if (!data.daily_date) data.daily_date = today;
  if (!data.weekly_date) data.weekly_date = weekStart;

  // Reset daily if new day
  if (data.daily_date !== today) {
    checkDailyPrize(data);
    data.daily = {};
    data.daily_date = today;
  }

  // Reset weekly if new week
  if (data.weekly_date !== weekStart) {
    checkWeeklyPrize(data);
    data.weekly = {};
    data.weekly_date = weekStart;
  }

  const playerName = walletState.connected ? walletState.paymentAddress.slice(0, 6) : 'You';
  data.daily[playerName] = (data.daily[playerName] || 0) + bet;
  data.weekly[playerName] = (data.weekly[playerName] || 0) + bet;
  data.alltime = (data.alltime || 0) + bet;

  saveWagerLB(data);
}

function getWeekStart() {
  const d = new Date();
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  return new Date(d.setDate(diff)).toISOString().slice(0, 10);
}

function checkDailyPrize(data) {
  const lastPrize = localStorage.getItem(DAILY_PRIZE_KEY);
  if (lastPrize === data.daily_date) return;

  const myName = walletState.connected ? walletState.paymentAddress.slice(0, 6) : 'You';
  const entries = generateLBEntries('daily', data);
  const myPos = entries.findIndex(e => e.isLocal);

  if (myPos >= 0 && myPos < DAILY_PRIZES.length) {
    const prize = DAILY_PRIZES[myPos];
    balance += prize;
    updateBalance(); saveState();
    showToast('\uD83C\uDFC6 Daily Rank #' + (myPos + 1) + '! <span class="toast-amount">+' + prize.toLocaleString() + ' SPUNK\u2022BET</span>');
  }
  localStorage.setItem(DAILY_PRIZE_KEY, data.daily_date);
}

function checkWeeklyPrize(data) {
  const lastPrize = localStorage.getItem(WEEKLY_PRIZE_KEY);
  if (lastPrize === data.weekly_date) return;

  const entries = generateLBEntries('weekly', data);
  const myPos = entries.findIndex(e => e.isLocal);

  if (myPos >= 0 && myPos < WEEKLY_PRIZES.length) {
    const prize = WEEKLY_PRIZES[myPos];
    balance += prize;
    updateBalance(); saveState();
    showToast('\uD83C\uDFC6 Weekly Rank #' + (myPos + 1) + '! <span class="toast-amount">+' + prize.toLocaleString() + ' SPUNK\u2022BET</span>');
  }
  localStorage.setItem(WEEKLY_PRIZE_KEY, data.weekly_date);
}

function generateLBEntries(period, dataOverride) {
  const data = dataOverride || loadWagerLB();
  const dayNum = Math.floor(Date.now() / 86400000);
  function seededRand(seed) { let x = Math.sin(seed) * 10000; return x - Math.floor(x); }

  // Simulated community players
  const simNames = ['Degen_7x', 'Whale_m4', 'Grinder_f9', 'Lucky_r2', 'RuneKing', 'BTC_ape', 'Satoshi_d3', 'Flipper_w7', 'Hodler_e6', 'Chad_t1'];
  const periodSeed = period === 'daily' ? dayNum : period === 'weekly' ? Math.floor(dayNum / 7) : 0;

  const simEntries = simNames.map((name, i) => {
    let base;
    if (period === 'daily') base = Math.floor(seededRand(periodSeed + i * 97) * 80000) + 5000;
    else if (period === 'weekly') base = Math.floor(seededRand(periodSeed + i * 137) * 400000) + 30000;
    else base = Math.floor(seededRand(i * 211) * 2000000) + 100000;
    return { name, wagered: base, isLocal: false };
  });

  // Local player data
  const localWager = period === 'daily' ? (data.daily ? Object.values(data.daily).reduce((a, b) => a + b, 0) : 0)
    : period === 'weekly' ? (data.weekly ? Object.values(data.weekly).reduce((a, b) => a + b, 0) : 0)
    : (data.alltime || 0);

  if (localWager > 0) {
    const myName = walletState.connected ? walletState.paymentAddress.slice(0, 6) + '...' : 'You';
    simEntries.push({ name: myName, wagered: localWager, isLocal: true });
  }

  return simEntries.sort((a, b) => b.wagered - a.wagered).slice(0, 10);
}

function switchLBTab(tab, btn) {
  currentLBTab = tab;
  document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderWagerLeaderboard();
}

function renderWagerLeaderboard() {
  const el = document.getElementById('wager-leaderboard');
  const prizesEl = document.getElementById('wager-prizes');
  if (!el) return;

  const entries = generateLBEntries(currentLBTab);
  const prizes = currentLBTab === 'weekly' ? WEEKLY_PRIZES : DAILY_PRIZES;
  const periodLabel = currentLBTab === 'daily' ? 'Today' : currentLBTab === 'weekly' ? 'This Week' : 'All Time';

  el.innerHTML = entries.map((e, i) => {
    const rankClass = i < 3 ? 'wr' + (i + 1) : 'wr4';
    const rank = getPlayerRank(e.wagered);
    const youTag = e.isLocal ? ' <span style="color:var(--accent);font-size:0.65rem;">(You)</span>' : '';
    const prizeTag = i < prizes.length && currentLBTab !== 'alltime' ? '<div class="wager-prize">+' + prizes[i].toLocaleString() + ' SPUNK</div>' : '';
    return '<div class="wager-entry">' +
      '<div class="wager-rank ' + rankClass + '">' + (i + 1) + '</div>' +
      '<div class="wager-name">' + (rank.icon ? rank.icon + ' ' : '') + e.name + youTag + '</div>' +
      '<div style="text-align:right;">' +
        '<div class="wager-amount">' + e.wagered.toLocaleString() + '</div>' +
        prizeTag +
      '</div>' +
    '</div>';
  }).join('');

  if (prizesEl && currentLBTab !== 'alltime') {
    prizesEl.innerHTML = '<div style="font-size:0.8rem;color:var(--muted);text-align:center;">' +
      '<strong style="color:var(--green);">' + periodLabel + ' Prizes:</strong> ' +
      prizes.map((p, i) => '#' + (i + 1) + ': <span style="color:var(--accent);font-weight:700;">' + p.toLocaleString() + '</span>').join(' &middot; ') +
      '<div style="font-size:0.7rem;margin-top:0.3rem;">Prizes auto-awarded at reset. Wager more to climb!</div>' +
    '</div>';
  } else if (prizesEl) {
    prizesEl.innerHTML = '';
  }
}

function renderRankTiers() {
  const el = document.getElementById('rank-tiers');
  if (!el) return;
  const wagered = cumulativeStats.total_wagered || 0;
  el.innerHTML = PLAYER_RANKS.slice(1).map(r => {
    const isActive = wagered >= r.min;
    return '<div style="display:flex;align-items:center;gap:0.75rem;padding:0.6rem 0;border-bottom:1px solid var(--border);">' +
      '<div style="font-size:1.5rem;">' + r.icon + '</div>' +
      '<div style="flex:1;">' +
        '<div style="font-weight:700;color:' + r.color + ';font-size:0.9rem;">' + r.name + (isActive ? ' <span style="color:var(--green);font-size:0.7rem;">UNLOCKED</span>' : '') + '</div>' +
        '<div style="font-size:0.75rem;color:var(--muted);">Wager ' + r.min.toLocaleString() + '+ SPUNK total</div>' +
      '</div>' +
      '<div style="font-size:0.75rem;font-weight:600;color:' + (isActive ? 'var(--green)' : 'var(--muted)') + ';">' + (isActive ? 'Active' : r.min.toLocaleString()) + '</div>' +
    '</div>';
  }).join('');
}

// ===== DAILY BONUS WHEEL =====
function canDailySpin() {
  const last = localStorage.getItem('spunkbet_daily_spin');
  if (!last) return true;
  return Date.now() - parseInt(last) > 24 * 60 * 60 * 1000;
}

function updateDailySpinButton() {
  const btn = document.getElementById('daily-spin-btn');
  if (!btn) return;
  if (canDailySpin()) {
    btn.disabled = false;
    btn.textContent = 'Spin Now';
  } else {
    btn.disabled = true;
    const last = parseInt(localStorage.getItem('spunkbet_daily_spin'));
    const next = last + 24 * 60 * 60 * 1000;
    const remaining = next - Date.now();
    const hours = Math.floor(remaining / (60 * 60 * 1000));
    const mins = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
    btn.textContent = 'Spin again in ' + hours + 'h ' + mins + 'm';
  }
}

function openDailySpin() {
  if (!canDailySpin()) {
    const last = parseInt(localStorage.getItem('spunkbet_daily_spin'));
    const next = last + 24 * 60 * 60 * 1000;
    const remaining = next - Date.now();
    const hours = Math.floor(remaining / (60 * 60 * 1000));
    const mins = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
    showToast('Daily spin resets in <span class="toast-amount">' + hours + 'h ' + mins + 'm</span>. Come back tomorrow!');
    return;
  }
  document.getElementById('daily-spin-modal').classList.add('show');
  document.getElementById('daily-spin-result').style.display = 'none';
  document.getElementById('daily-spin-bonus').style.display = 'none';
  document.getElementById('daily-spin-share-btn').style.display = 'none';
  document.getElementById('daily-spin-display').textContent = '\uD83C\uDFA1';
  document.getElementById('daily-spin-display').style.cursor = 'pointer';
}

function closeDailySpin() {
  document.getElementById('daily-spin-modal').classList.remove('show');
}

let dailySpinPrize = 0;
function executeDailySpin() {
  if (!canDailySpin()) return;
  const display = document.getElementById('daily-spin-display');
  if (display.style.cursor !== 'pointer') return;
  display.style.cursor = 'default';
  const prizes = [500, 1000, 1000, 2500, 2500, 2500, 5000, 5000, 1000, 500];
  const idx = Math.floor(Math.random() * prizes.length);
  dailySpinPrize = prizes[idx];
  // Animate
  let spins = 0;
  const emojis = ['\uD83C\uDFA1', '\u2728', '\uD83C\uDFB0', '\uD83D\uDCB0', '\uD83D\uDD25'];
  const spinInterval = setInterval(() => {
    display.textContent = emojis[spins % emojis.length];
    spins++;
    if (spins > 15) {
      clearInterval(spinInterval);
      display.textContent = '\uD83C\uDF89';
      balance += dailySpinPrize;
      updateBalance();
      saveState();
      localStorage.setItem('spunkbet_daily_spin', Date.now().toString());
      updateDailySpinButton();
      document.getElementById('daily-spin-result').textContent = '+' + dailySpinPrize.toLocaleString() + ' SPUNK\u2022BET!';
      document.getElementById('daily-spin-result').style.display = '';
      document.getElementById('daily-spin-bonus').style.display = '';
      document.getElementById('daily-spin-share-btn').style.display = '';
    }
  }, 120);
}

function shareDailySpinOnX() {
  const btn = document.getElementById('daily-spin-share-btn');
  if (btn.disabled) return;
  btn.disabled = true;
  const refCode = walletState.connected ? walletState.paymentAddress.slice(0, 8) : '';
  const link = refCode ? 'https://spunk.bet?ref=' + refCode : 'https://spunk.bet';
  balance += dailySpinPrize;
  updateBalance();
  saveState();
  showToast('2x bonus! <span class="toast-amount">+' + dailySpinPrize.toLocaleString() + ' SPUNK\u2022BET</span> extra!');
  const text = 'Just spun +' + (dailySpinPrize * 2).toLocaleString() + ' SPUNK\u2022BET on the daily wheel! \uD83C\uDFA1\n\nFree runes daily + ordinal giveaways. Fast. Fair. Free \u2192 ' + link + '\n\n@SpunkArt13';
  window.open('https://x.com/intent/tweet?text=' + encodeURIComponent(text), '_blank');
  closeDailySpin();
}

// ===== TIP SPUNK =====
const TIP_WALLET = 'bc1q05ay5x4lwjl8pphy83j8wg08nwq2jdvnlw8ekl';
function openTipModal() { document.getElementById('tip-modal').classList.add('active'); }
function closeTipModal() { document.getElementById('tip-modal').classList.remove('active'); }
function copyTipAddr() {
  navigator.clipboard.writeText(TIP_WALLET).then(() => showToast('Address copied!')).catch(() => {});
}

// ===== PRIZE SHOWCASE SHARING =====
async function sharePrizeOnX(prizeName) {
  const refCode = walletState.connected ? walletState.paymentAddress.slice(0, 8) : '';
  const link = refCode ? 'https://spunk.bet?ref=' + refCode : 'https://spunk.bet';
  let text;
  if (prizeName) {
    text = 'Win a ' + prizeName + ' ordinal on @SpunkArt13\'s casino! \uD83C\uDFC6\n\nFree daily SPUNK\u2022BET runes + real ordinal prizes. Fast. Fair. Free \u2192 ' + link;
  } else {
    text = 'Real ordinal prizes up for grabs on Spunk.Bet! \uD83C\uDFC6\n\nFree runes daily, win Bitcoin ordinals. Support @SpunkArt13 \u2192 ' + link;
  }
  // Try Web Share API first
  try {
    const canvas = generateWinCard({ referralOnly: true });
    canvas.toBlob(function(blob) {
      const file = new File([blob], 'spunkbet-prizes.png', { type: 'image/png' });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({ text: text, files: [file] }).catch(() => {
          window.open('https://x.com/intent/tweet?text=' + encodeURIComponent(text), '_blank');
        });
      } else {
        window.open('https://x.com/intent/tweet?text=' + encodeURIComponent(text), '_blank');
      }
    }, 'image/png');
  } catch(e) {
    window.open('https://x.com/intent/tweet?text=' + encodeURIComponent(text), '_blank');
  }
  shareBonus();
}

// ===== PRIZE WALLET AUTO-SCAN (Magic Eden) =====
const PRIZE_WALLET = 'bc1p27l6s82w5dek9yffjtlyj58ue2sndxm6zszpcz9zcwqpd4v86n9s5l37xm';
let prizeOrdinals = [];
let prizeLastHash = '';
let prizeScanRetries = 0;

// Known prize inscriptions with verified metadata (ultimate fallback)
const KNOWN_PRIZES = [
  {
    id: '0a363cdd84ca2d49a9b55d20f82af5d82c781444f8d64caa09b95136e3306412i0',
    inscriptionId: '0a363cdd84ca2d49a9b55d20f82af5d82c781444f8d64caa09b95136e3306412i0',
    inscriptionNumber: 118867108, number: 118867108,
    contentType: 'image/webp', contentLength: '63 KB',
    contentURI: 'https://ordinals.com/content/0a363cdd84ca2d49a9b55d20f82af5d82c781444f8d64caa09b95136e3306412i0',
    contentPreviewURI: 'https://ordinals.com/content/0a363cdd84ca2d49a9b55d20f82af5d82c781444f8d64caa09b95136e3306412i0',
    collectionName: 'SpunkArt Collection', collection: 'spunkart',
    timestamp: '2026-02-09', satRarity: 'common',
  },
  {
    id: 'd7244525a36a312105aa2c9db78778b98ec659b30b4e6063d7b9a9dfd47dc2b7i0',
    inscriptionId: 'd7244525a36a312105aa2c9db78778b98ec659b30b4e6063d7b9a9dfd47dc2b7i0',
    inscriptionNumber: 119284034, number: 119284034,
    contentType: 'image/svg+xml', contentLength: '4 KB',
    contentURI: 'https://ordinals.com/content/d7244525a36a312105aa2c9db78778b98ec659b30b4e6063d7b9a9dfd47dc2b7i0',
    contentPreviewURI: 'https://ordinals.com/content/d7244525a36a312105aa2c9db78778b98ec659b30b4e6063d7b9a9dfd47dc2b7i0',
    collectionName: 'SpunkArt Collection', collection: 'spunkart',
    timestamp: '2026-02-13', satRarity: 'common',
  },
  {
    id: '65e06f5b9ccbd0202268e5f3d4d778e77c0a10af5ab1dbe55f7210f9121884adi0',
    inscriptionId: '65e06f5b9ccbd0202268e5f3d4d778e77c0a10af5ab1dbe55f7210f9121884adi0',
    inscriptionNumber: 118866403, number: 118866403,
    contentType: 'image/webp', contentLength: '61 KB',
    contentURI: 'https://ordinals.com/content/65e06f5b9ccbd0202268e5f3d4d778e77c0a10af5ab1dbe55f7210f9121884adi0',
    contentPreviewURI: 'https://ordinals.com/content/65e06f5b9ccbd0202268e5f3d4d778e77c0a10af5ab1dbe55f7210f9121884adi0',
    collectionName: 'SpunkArt Collection', collection: 'spunkart',
    timestamp: '2026-02-09', satRarity: 'common',
  },
  {
    id: 'c6e9ad7454cf9bb8b1d75ec9df13229dee1e18f16a5fd57b6549de87e8cce4abi5',
    inscriptionId: 'c6e9ad7454cf9bb8b1d75ec9df13229dee1e18f16a5fd57b6549de87e8cce4abi5',
    inscriptionNumber: 118723669, number: 118723669,
    contentType: 'image/svg+xml', contentLength: '1 KB',
    contentURI: 'https://ordinals.com/content/c6e9ad7454cf9bb8b1d75ec9df13229dee1e18f16a5fd57b6549de87e8cce4abi5',
    contentPreviewURI: 'https://ordinals.com/content/c6e9ad7454cf9bb8b1d75ec9df13229dee1e18f16a5fd57b6549de87e8cce4abi5',
    collectionName: 'SpunkArt Collection', collection: 'spunkart',
    timestamp: '2026-02-08', satRarity: 'common',
  }
];

// Load cached prizes from localStorage so they show instantly
try {
  const cached = JSON.parse(localStorage.getItem('spunkbet_prizes') || '[]');
  if (cached.length > 0) {
    prizeOrdinals = cached;
    prizeLastHash = JSON.stringify(cached.map(t => t.id || t.inscriptionId || ''));
  }
} catch(e) {}

// Enrich list items with known metadata
function enrichWithKnown(list) {
  return list.map(item => {
    const id = item.id || item.inscriptionId || '';
    const known = KNOWN_PRIZES.find(k => k.id === id);
    if (known) return { ...known, ...item, collectionName: known.collectionName, collection: known.collection, inscriptionNumber: known.inscriptionNumber, number: known.number, contentType: known.contentType };
    return item;
  });
}

async function scanPrizeWallet() {
  let list = [];
  let source = '';

  // Try Magic Eden API first
  try {
    const res = await fetch('https://api-mainnet.magiceden.dev/v2/ord/btc/tokens?ownerAddress=' + PRIZE_WALLET + '&showAll=true&limit=50');
    if (res.ok) {
      const data = await res.json();
      const tokens = data.tokens || data || [];
      list = Array.isArray(tokens) ? tokens : [];
      source = 'ME';
    }
  } catch(e) {}

  // Fallback to Hiro API
  if (list.length === 0) {
    try {
      const res = await fetch('https://api.hiro.so/ordinals/v1/inscriptions?address=' + PRIZE_WALLET + '&limit=50');
      if (res.ok) {
        const data = await res.json();
        if (data.results && data.results.length > 0) {
          list = data.results.map(r => ({
            id: r.id,
            inscriptionId: r.id,
            inscriptionNumber: r.number,
            number: r.number,
            contentType: r.content_type || '',
            contentURI: 'https://ordinals.com/content/' + r.id,
            contentPreviewURI: r.content_type && r.content_type.startsWith('image') ? 'https://ordinals.com/content/' + r.id : null,
            collectionName: 'Bitcoin Ordinal',
          }));
          source = 'Hiro';
        }
      }
    } catch(e) {}
  }

  // Fallback: UTXO-based scan via mempool.space
  if (list.length === 0) {
    try {
      const utxoRes = await fetch('https://mempool.space/api/address/' + PRIZE_WALLET + '/utxo');
      if (utxoRes.ok) {
        const utxos = await utxoRes.json();
        const ordinalUtxos = utxos.filter(u => u.value <= 1000 && u.status && u.status.confirmed);
        for (const utxo of ordinalUtxos) {
          const outpoint = utxo.txid + ':' + utxo.vout;
          try {
            const inscRes = await fetch('https://ordinals.com/api/output/' + outpoint);
            if (inscRes.ok) {
              const inscData = await inscRes.json();
              const inscs = inscData.inscriptions || [];
              for (const inscId of inscs) {
                list.push({
                  id: inscId, inscriptionId: inscId,
                  inscriptionNumber: '?', number: '?',
                  contentType: 'image/png',
                  contentURI: 'https://ordinals.com/content/' + inscId,
                  contentPreviewURI: 'https://ordinals.com/content/' + inscId,
                  collectionName: 'Bitcoin Ordinal',
                });
              }
            }
          } catch(e2) {}
        }
        if (list.length > 0) source = 'UTXO-scan';
      }
    } catch(e) {}
  }

  // Ultimate fallback: use known verified inscriptions
  if (list.length === 0) {
    list = KNOWN_PRIZES.slice();
    source = 'known';
  }

  // Enrich all items with known metadata (collection names, numbers, etc.)
  list = enrichWithKnown(list);

  // Update if we got data
  const hash = JSON.stringify(list.map(t => t.id || t.inscriptionId || ''));
  if (list.length > 0) {
    if (hash !== prizeLastHash) {
      prizeLastHash = hash;
      prizeOrdinals = list;
      localStorage.setItem('spunkbet_prizes', JSON.stringify(list));
      renderPrizes('prize-grid');
      renderPrizes('wallet-prize-grid');
    }
    prizeScanRetries = 0;
  } else {
    prizeScanRetries++;
    // Always render so the empty state shows properly (not stuck on "Scanning...")
    renderPrizes('prize-grid');
    renderPrizes('wallet-prize-grid');
    // Retry with exponential backoff up to 5 min
    if (prizeScanRetries <= 5) {
      const retryMs = Math.min(prizeScanRetries * 60000, 300000);
      setTimeout(scanPrizeWallet, retryMs);
    }
  }
}

function renderPrizes(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  if (prizeOrdinals.length === 0) {
    container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem 1rem;">' +
      '<div style="font-size:3rem;margin-bottom:0.75rem;">🏆</div>' +
      '<p style="color:var(--text);font-weight:700;margin-bottom:0.3rem;">Prize Pool Restocking!</p>' +
      '<p style="color:var(--muted);font-size:0.8rem;">New ordinal prizes are being added soon. Send ordinals to the prize wallet to contribute!</p>' +
      '<p style="color:var(--muted);font-size:0.75rem;margin-top:0.5rem;">Fast. Fair. Free. <span style="color:var(--accent);">Auto-scan every 15 min.</span></p>' +
      '<p style="margin-top:0.5rem;"><a href="https://magiceden.us/u/' + PRIZE_WALLET + '" target="_blank" style="color:var(--accent);font-size:0.65rem;font-family:monospace;text-decoration:none;opacity:0.6;">View on Magic Eden ↗</a></p>' +
      '<p style="margin-top:0.3rem;"><a href="https://mempool.space/address/' + PRIZE_WALLET + '" target="_blank" style="color:var(--muted);font-size:0.6rem;font-family:monospace;text-decoration:none;opacity:0.5;">' + PRIZE_WALLET.slice(0,16) + '...' + PRIZE_WALLET.slice(-6) + ' ↗</a></p>' +
      '</div>';
    return;
  }

  const isWalletPage = containerId === 'wallet-prize-grid';
  const bgs = ['bg1','bg2','bg3','bg4'];
  container.innerHTML = prizeOrdinals.map((ord, i) => {
    const id = ord.id || ord.inscriptionId || '';
    const shortId = id.slice(0,8) + '...' + id.slice(-4);
    const num = ord.inscriptionNumber || ord.number || '?';
    const collection = ord.collection || ord.collectionSymbol || '';
    const collectionName = ord.collectionName || collection || 'Bitcoin Ordinal';
    const contentType = ord.contentType || ord.content_type || '';
    const contentLength = ord.contentLength || '';
    const timestamp = ord.timestamp || '';
    const type = contentType.split('/')[0];
    const isImage = type === 'image';
    const isSVG = contentType === 'image/svg+xml';
    const imgUrl = ord.contentURI || ord.contentPreviewURI || ('https://ordinals.com/content/' + id);
    const bg = bgs[i % bgs.length];
    const ordLink = 'https://ordinals.com/inscription/' + id;

    let imgHtml;
    if (isSVG) {
      // For SVGs, use an iframe to render properly
      imgHtml = '<iframe src="' + imgUrl + '" style="width:100%;height:100%;border:none;position:relative;z-index:1;border-radius:12px 12px 0 0;pointer-events:none;" loading="lazy" sandbox="allow-scripts"></iframe>';
    } else if (isImage || ord.contentPreviewURI) {
      imgHtml = '<img src="' + imgUrl + '" alt="' + collectionName + ' #' + num + '" style="width:100%;height:100%;object-fit:cover;position:relative;z-index:1;border-radius:12px 12px 0 0;" loading="lazy" onerror="this.parentElement.innerHTML=\'<div class=prize-img-bg ' + bg + '></div><span style=position:relative;z-index:1;font-size:2rem;>🏆</span>\'">';
    } else {
      imgHtml = '<div class="prize-img-bg ' + bg + '"></div><span style="position:relative;z-index:1;filter:drop-shadow(0 4px 12px rgba(0,0,0,0.5));animation:prizeFloat 3s ease-in-out infinite;animation-delay:' + (i * 0.5) + 's;">🏆</span>';
    }

    const title = collectionName !== 'Bitcoin Ordinal' ? collectionName : 'Inscription #' + num;

    // Collection badge color
    const collBadge = collection ? '<span style="display:inline-block;background:linear-gradient(90deg,var(--accent),var(--purple));color:#fff;font-size:0.55rem;font-weight:700;padding:0.15rem 0.4rem;border-radius:4px;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:0.2rem;">' + collectionName + '</span>' : '';

    // Extended details for wallet page
    let detailsHtml = '';
    if (isWalletPage) {
      detailsHtml =
        '<div style="font-size:0.65rem;color:var(--muted);margin-top:0.3rem;line-height:1.5;">' +
          '<div>Inscription <span style="color:var(--text);font-weight:600;">#' + num + '</span></div>' +
          '<div>Type: <span style="color:var(--text);">' + contentType + '</span>' + (contentLength ? ' &middot; ' + contentLength : '') + '</div>' +
          (timestamp ? '<div>Inscribed: <span style="color:var(--text);">' + timestamp + '</span></div>' : '') +
          '<div style="margin-top:0.25rem;"><a href="' + ordLink + '" target="_blank" style="color:var(--accent);text-decoration:none;font-size:0.6rem;">View on ordinals.com ↗</a></div>' +
        '</div>';
    }

    return '<div class="prize-card" onclick="sharePrizeOnX(\'' + title.replace(/'/g, '') + '\')">' +
      '<div class="prize-img">' + imgHtml + '<span class="prize-badge win-this">WIN THIS</span></div>' +
      '<div class="prize-info">' +
        collBadge +
        '<h4>' + title + '</h4>' +
        '<p style="font-size:0.6rem;color:var(--muted);font-family:monospace;">#' + num + ' &middot; ' + shortId + '</p>' +
        detailsHtml +
        '<div class="prize-share-hint">Tap to share on X</div>' +
      '</div>' +
      '</div>';
  }).join('');
}

// Background polling — check for new prizes every 15 minutes
setInterval(scanPrizeWallet, 900000);

// ===== SITE ANALYTICS (Cloudflare Worker + local fallback) =====
// SET YOUR WORKER URL HERE after deploying the Cloudflare Worker:
const ANALYTICS_WORKER = ''; // e.g. 'https://spunk-analytics.YOUR-SUBDOMAIN.workers.dev'

(function() {
  const SK = 'spunkbet_analytics';
  let analytics = {};
  try { analytics = JSON.parse(localStorage.getItem(SK) || '{}'); } catch(e) {}
  if (!analytics.first_visit) analytics.first_visit = new Date().toISOString();
  if (!analytics.total_visits) analytics.total_visits = 0;
  if (!analytics.sessions) analytics.sessions = 0;
  if (!analytics.games_by_type) analytics.games_by_type = {};
  if (!analytics.faucet_claims) analytics.faucet_claims = 0;
  if (!analytics.referrals_sent) analytics.referrals_sent = 0;
  if (!analytics.wallet_connects) analytics.wallet_connects = 0;
  if (!analytics.daily_visits) analytics.daily_visits = {};
  if (!analytics.pages_viewed) analytics.pages_viewed = {};

  analytics.total_visits++;
  analytics.last_visit = new Date().toISOString();
  const today = new Date().toISOString().slice(0, 10);
  analytics.daily_visits[today] = (analytics.daily_visits[today] || 0) + 1;

  const lastTs = analytics.last_activity || 0;
  if (Date.now() - lastTs > 30 * 60 * 1000) analytics.sessions++;
  analytics.last_activity = Date.now();

  const cutoff = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
  Object.keys(analytics.daily_visits).forEach(d => { if (d < cutoff) delete analytics.daily_visits[d]; });
  localStorage.setItem(SK, JSON.stringify(analytics));

  // ===== Cloudflare Worker beacon =====
  function cfTrack(data) {
    if (!ANALYTICS_WORKER) return;
    try {
      const payload = JSON.stringify(data);
      if (navigator.sendBeacon) {
        navigator.sendBeacon(ANALYTICS_WORKER + '/track', payload);
      } else {
        fetch(ANALYTICS_WORKER + '/track', { method: 'POST', body: payload, headers: { 'Content-Type': 'application/json' }, keepalive: true }).catch(() => {});
      }
    } catch(e) {}
  }

  // Track this page visit on Cloudflare
  const urlParams = new URLSearchParams(window.location.search);
  cfTrack({ event: 'visit', page: 'home', ref: urlParams.get('ref') || '' });

  // Track page views (local + CF)
  window.trackPageView = function(page) {
    analytics.pages_viewed[page] = (analytics.pages_viewed[page] || 0) + 1;
    localStorage.setItem(SK, JSON.stringify(analytics));
    cfTrack({ event: 'visit', page: page });
  };

  // Track game plays (local + CF)
  window.trackGamePlay = function(game, bet, result) {
    analytics.games_by_type[game] = (analytics.games_by_type[game] || 0) + 1;
    analytics.last_activity = Date.now();
    localStorage.setItem(SK, JSON.stringify(analytics));
    cfTrack({ event: 'game_play', game: game, bet: bet || 0, result: result || '' });
  };

  // Track events (local + CF)
  window.trackEvent = function(event, data) {
    if (event === 'faucet_claim') { analytics.faucet_claims++; cfTrack({ event: 'faucet_claim' }); }
    if (event === 'wallet_connect') { analytics.wallet_connects++; cfTrack({ event: 'wallet_connect' }); }
    if (event === 'referral_share') { analytics.referrals_sent++; cfTrack({ event: 'share', platform: 'x' }); }
    if (event === 'referral_click') { cfTrack({ event: 'referral_click', code: data || '' }); }
    analytics.last_activity = Date.now();
    localStorage.setItem(SK, JSON.stringify(analytics));
  };

  // ===== Fetch real stats from Cloudflare Worker =====
  window.liveStats = null;
  window.fetchLiveStats = async function() {
    if (!ANALYTICS_WORKER) return null;
    try {
      const res = await fetch(ANALYTICS_WORKER + '/stats');
      if (res.ok) {
        window.liveStats = await res.json();
        return window.liveStats;
      }
    } catch(e) {}
    return null;
  };

  // Auto-fetch live stats on load
  if (ANALYTICS_WORKER) fetchLiveStats();

  // Console-accessible stats dump (local + live)
  window.spunkStats = async function() {
    const a = JSON.parse(localStorage.getItem(SK) || '{}');
    const s = cumulativeStats || {};
    console.log('%c SPUNK.BET ANALYTICS ', 'background:#ff5f1f;color:#000;font-weight:bold;padding:4px 8px;border-radius:4px;');
    console.table({
      'First Visit': a.first_visit || '—',
      'Local Visits': a.total_visits || 0,
      'Sessions': a.sessions || 0,
      'Last Visit': a.last_visit || '—',
      'Games Played': s.games_played || 0,
      'Total Wagered': (s.total_wagered || 0).toLocaleString() + ' SPUNK',
      'Total Won': (s.total_won || 0).toLocaleString() + ' SPUNK',
      'Biggest Win': (s.biggest_win || 0).toLocaleString() + ' SPUNK',
      'Faucet Claims': a.faucet_claims || 0,
      'Wallet Connects': a.wallet_connects || 0,
      'Referrals Shared': a.referrals_sent || 0
    });
    if (Object.keys(a.games_by_type || {}).length) {
      console.log('%c Games by Type (local) ', 'background:#7c3aed;color:#fff;font-weight:bold;padding:2px 6px;border-radius:4px;');
      console.table(a.games_by_type);
    }
    // Fetch and display live Cloudflare stats
    if (ANALYTICS_WORKER) {
      console.log('%c Fetching live stats from Cloudflare... ', 'background:#3b82f6;color:#fff;padding:2px 6px;border-radius:4px;');
      const live = await fetchLiveStats();
      if (live) {
        console.log('%c LIVE STATS (all users) ', 'background:#22c55e;color:#000;font-weight:bold;padding:4px 8px;border-radius:4px;');
        console.table(live.today);
        console.log('%c All Time ', 'background:#22c55e;color:#000;padding:2px 6px;border-radius:4px;');
        console.table(live.all_time);
      }
    } else {
      console.log('%c No Cloudflare Worker configured. Set ANALYTICS_WORKER URL for real cross-user stats. ', 'background:#eab308;color:#000;padding:2px 6px;border-radius:4px;');
    }
    return a;
  };

  // Admin stats (detailed breakdown - call from console)
  window.spunkAdmin = async function() {
    if (!ANALYTICS_WORKER) { console.log('Set ANALYTICS_WORKER URL first'); return; }
    try {
      const res = await fetch(ANALYTICS_WORKER + '/stats/admin');
      if (res.ok) {
        const data = await res.json();
        console.log('%c SPUNK.BET ADMIN DASHBOARD ', 'background:#ff5f1f;color:#000;font-weight:bold;padding:6px 12px;border-radius:4px;font-size:14px;');
        console.log('%c Daily Breakdown (7 days) ', 'background:#7c3aed;color:#fff;font-weight:bold;padding:2px 6px;border-radius:4px;');
        console.table(data.daily);
        console.log('%c Games Breakdown ', 'background:#7c3aed;color:#fff;font-weight:bold;padding:2px 6px;border-radius:4px;');
        console.table(data.games);
        console.log('%c Countries ', 'background:#7c3aed;color:#fff;font-weight:bold;padding:2px 6px;border-radius:4px;');
        console.table(data.countries);
        console.log('%c Devices ', 'background:#7c3aed;color:#fff;font-weight:bold;padding:2px 6px;border-radius:4px;');
        console.table(data.devices);
        console.log('%c Hourly Distribution ', 'background:#7c3aed;color:#fff;font-weight:bold;padding:2px 6px;border-radius:4px;');
        console.table(data.hourly);
        return data;
      }
    } catch(e) { console.error('Failed to fetch admin stats:', e); }
  };

  const el = document.getElementById('total-visits-count');
  if (el) el.textContent = analytics.total_visits.toLocaleString();
})();

// ===== VISITOR COUNTER =====
(function() {
  // Simulated "players online" based on time of day + randomization
  // Seeds from actual activity so it grows naturally with real traffic
  function updateOnlineCount() {
    const hour = new Date().getHours();
    // Base activity curve (peaks evening US time)
    const curve = [3,2,2,1,1,1,2,3,5,7,9,11,13,14,15,16,18,20,22,21,18,14,10,6];
    const base = curve[hour];
    // Add some randomness
    const jitter = Math.floor(Math.random() * Math.max(3, Math.floor(base * 0.4)));
    const count = base + jitter;
    const el = document.getElementById('online-count');
    if (el) el.textContent = count;
  }
  updateOnlineCount();
  setInterval(updateOnlineCount, 45000); // refresh every 45s
})();

// ===== INIT =====
captureReferral();
loadState();
loadCumulativeStats();
updateDiceSlider();
initProvablyFair();
initAutobetPanels();
updateStreakBadge();
updatePlayerRankBadge();
updateDailySpinButton();
initLiveTicker();
scanPrizeWallet();
renderCommunityHistory();
setInterval(updateDailySpinButton, 60000);
// Auto-check daily/weekly prize resets every 5 minutes
setInterval(() => { const d = loadWagerLB(); trackWagerLB(0); }, 300000);

// Close big win overlay on backdrop click
document.getElementById('bigwin-overlay').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeBigWin(); });
document.getElementById('daily-spin-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeDailySpin(); });

// ===== AUTO-AUDIT SYSTEM (runs every 30 minutes) =====
(function() {
  const AUDIT_INTERVAL = 30 * 60 * 1000; // 30 minutes
  let lastAuditLog = [];

  function runSiteAudit() {
    const issues = [];
    const fixes = [];
    const t0 = performance.now();

    // 1. CHECK ALL GAME PAGES EXIST
    const gamePages = ['coinflip','dice','mines','crash','limbo','keno','wheel','plinko','hilo','tower'];
    gamePages.forEach(g => {
      const page = document.getElementById(g + '-page');
      if (!page) issues.push('MISSING: ' + g + '-page element');
    });

    // 2. CHECK ALL BET INPUTS EXIST AND HAVE VALID VALUES
    const betInputs = ['coinflip-bet','dice-bet','mines-bet','crash-bet','limbo-bet','keno-bet','wheel-bet','plinko-bet','hilo-bet','tower-bet'];
    betInputs.forEach(id => {
      const el = document.getElementById(id);
      if (!el) { issues.push('MISSING: ' + id + ' input'); return; }
      const v = parseInt(el.value);
      if (isNaN(v) || v < 0) {
        el.value = MIN_BET;
        fixes.push('FIX: Reset ' + id + ' to ' + MIN_BET + ' (was invalid)');
      }
    });

    // 3. CHECK BALANCE INTEGRITY
    if (typeof balance === 'undefined' || isNaN(balance) || balance < 0) {
      balance = 0;
      fixes.push('FIX: Reset negative/NaN balance to 0');
    }
    const balEl = document.getElementById('balance');
    if (balEl && parseInt(balEl.textContent.replace(/,/g,'')) !== balance) {
      balEl.textContent = balance.toLocaleString();
      fixes.push('FIX: Synced balance display');
    }

    // 4. CHECK KEY BUTTONS ARE WIRED (onclick handlers)
    const criticalButtons = [
      { sel: '#faucet-btn', label: 'Faucet button' },
      { sel: '.nav-link', label: 'Nav links', min: 5 },
    ];
    criticalButtons.forEach(b => {
      const els = document.querySelectorAll(b.sel);
      if (els.length === 0) issues.push('MISSING: ' + b.label);
      if (b.min && els.length < b.min) issues.push('LOW COUNT: ' + b.label + ' (' + els.length + '/' + b.min + ')');
    });

    // 5. CHECK CSS VARIABLES LOADED (theme integrity)
    const root = getComputedStyle(document.documentElement);
    ['--bg','--surface','--accent','--text'].forEach(v => {
      if (!root.getPropertyValue(v).trim()) issues.push('MISSING CSS VAR: ' + v);
    });

    // 6. CHECK LOCALSTORAGE ISN'T CORRUPTED
    try {
      const state = JSON.parse(localStorage.getItem('spunkbet_state') || '{}');
      if (typeof state !== 'object') {
        localStorage.removeItem('spunkbet_state');
        fixes.push('FIX: Cleared corrupted localStorage state');
      }
    } catch(e) {
      localStorage.removeItem('spunkbet_state');
      fixes.push('FIX: Cleared unparseable localStorage state');
    }

    // 7. CHECK CUMULATIVE STATS INTEGRITY
    try {
      const stats = JSON.parse(localStorage.getItem('spunkbet_cumulative') || '{}');
      if (stats.games_played < 0 || stats.total_wagered < 0) {
        stats.games_played = Math.max(0, stats.games_played || 0);
        stats.total_wagered = Math.max(0, stats.total_wagered || 0);
        localStorage.setItem('spunkbet_cumulative', JSON.stringify(stats));
        fixes.push('FIX: Corrected negative cumulative stats');
      }
    } catch(e) {}

    // 8. CHECK PROVABLY FAIR SYSTEM
    if (typeof serverSeed === 'undefined' || !serverSeed) {
      if (typeof initProvablyFair === 'function') {
        initProvablyFair();
        fixes.push('FIX: Re-initialized provably fair seeds');
      }
    }

    // 9. CHECK FAUCET TIMER DISPLAY
    const faucetBtn = document.getElementById('faucet-btn');
    if (faucetBtn && typeof updateFaucetButton === 'function') {
      updateFaucetButton();
    }

    // 10. SPEED CHECK - Measure DOM query performance
    const speedT0 = performance.now();
    for (let i = 0; i < 100; i++) document.querySelectorAll('.game-card');
    const domSpeed = performance.now() - speedT0;
    if (domSpeed > 50) issues.push('SLOW DOM: querySelectorAll took ' + domSpeed.toFixed(1) + 'ms for 100 queries');

    // 11. CHECK PRIZE CACHE FRESHNESS
    const prizeCache = localStorage.getItem('spunkbet_prize_cache');
    if (prizeCache) {
      try {
        const pc = JSON.parse(prizeCache);
        const age = Date.now() - (pc.timestamp || 0);
        if (age > 60 * 60 * 1000) { // older than 1 hour
          scanPrizeWallet();
          fixes.push('FIX: Refreshed stale prize cache (was ' + Math.round(age/60000) + 'min old)');
        }
      } catch(e) {}
    }

    // 12. CHECK HISTORY ARRAY SIZE (prevent memory bloat)
    if (typeof history !== 'undefined' && Array.isArray(history) && history.length > 50) {
      history.length = 50;
      fixes.push('FIX: Trimmed history to 50 entries');
    }

    // 13. SYNC RANK BADGE
    if (typeof updatePlayerRankBadge === 'function') updatePlayerRankBadge();

    // 14. REFRESH LIVE STATS FROM CF WORKER
    if (typeof fetchLiveStats === 'function') fetchLiveStats();

    // 15. REFRESH STREAK BADGE
    if (typeof updateStreakBadge === 'function') updateStreakBadge();

    // 16. CHECK ONLINE COUNT IS RUNNING
    const onlineEl = document.getElementById('online-count');
    if (onlineEl && (!onlineEl.textContent || onlineEl.textContent === '0')) {
      if (typeof updateOnlineCount === 'function') updateOnlineCount();
      fixes.push('FIX: Refreshed online count');
    }

    const elapsed = (performance.now() - t0).toFixed(1);

    // Build audit report
    const report = {
      timestamp: new Date().toISOString(),
      elapsed_ms: parseFloat(elapsed),
      issues_found: issues.length,
      auto_fixes: fixes.length,
      issues: issues,
      fixes: fixes,
      stats: {
        balance: balance,
        games_played: (cumulativeStats || {}).games_played || 0,
        total_wagered: (cumulativeStats || {}).total_wagered || 0,
        dom_speed_100q: parseFloat(domSpeed.toFixed(1)) + 'ms',
        live_stats: window.liveStats ? 'connected' : 'local only',
        memory_mb: (performance.memory ? (performance.memory.usedJSHeapSize / 1048576).toFixed(1) : 'N/A'),
      },
      status: issues.length === 0 ? 'HEALTHY' : 'ISSUES DETECTED'
    };

    lastAuditLog.unshift(report);
    if (lastAuditLog.length > 10) lastAuditLog.pop();
    localStorage.setItem('spunkbet_audit_log', JSON.stringify(lastAuditLog));

    // Console output
    const statusColor = issues.length === 0 ? '#22c55e' : '#ef4444';
    console.log('%c SITE AUDIT ' + report.status + ' (' + elapsed + 'ms) ', 'background:' + statusColor + ';color:#fff;font-weight:bold;padding:4px 8px;border-radius:4px;');
    if (fixes.length) {
      console.log('%c Auto-fixes applied: ' + fixes.length, 'color:#22c55e;');
      fixes.forEach(f => console.log('  ' + f));
    }
    if (issues.length) {
      console.log('%c Issues: ' + issues.length, 'color:#ef4444;');
      issues.forEach(i => console.log('  ' + i));
    }

    return report;
  }

  // Expose to console
  window.spunkAudit = runSiteAudit;
  window.spunkAuditLog = function() {
    try { return JSON.parse(localStorage.getItem('spunkbet_audit_log') || '[]'); } catch(e) { return []; }
  };

  // Run initial audit after page fully loads
  setTimeout(runSiteAudit, 5000);
  // Run every 30 minutes
  setInterval(runSiteAudit, AUDIT_INTERVAL);
})();
</script>
</body>
</html>
